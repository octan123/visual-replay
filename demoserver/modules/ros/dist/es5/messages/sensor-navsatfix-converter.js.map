{"version":3,"sources":["../../../src/messages/sensor-navsatfix-converter.js"],"names":["SensorNavSatFix","config","frame","xvizBuilder","imuTopic","msg","message","length","rotation","orientation","topic","timestamp","state","_getOrientationFromIMU","ts","TimeUtil","toDate","getTime","poseBuilder","pose","xvizStream","mapOrigin","longitude","latitude","altitude","position","roll","pitch","yaw","xvizMetaBuilder","context","stream","category","Converter"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAaA;;AACA;;AACA;;;;;;IAEaA,e;;;;;AACX,2BAAYC,MAAZ,EAAoB;AAAA;AAAA,6BACZA,MADY;AAEnB;;;;2CAUsBC,K,EAAOC,W,EAAa;AACzC,UAAI,CAAC,KAAKF,MAAL,CAAYG,QAAjB,EAA2B;AACzB,eAAO,IAAP;AACD;;AAED,UAAMC,GAAG,GAAGH,KAAK,CAAC,KAAKD,MAAL,CAAYG,QAAb,CAAjB;;AACA,UAAI,CAACC,GAAL,EAAU;AACR,eAAO,IAAP;AACD;;AARwC,UAUlCC,OAVkC,GAUvBD,GAAG,CAACA,GAAG,CAACE,MAAJ,GAAa,CAAd,CAVoB,CAUlCD,OAVkC;AAWzC,UAAME,QAAQ,GAAG,mCAAkBF,OAAO,CAACG,WAA1B,CAAjB;AACA,aAAO;AAACD,QAAAA,QAAQ,EAARA;AAAD,OAAP;AACD;;;;6GAEoBN,K,EAAOC,W;;;;;;;AACpBE,gBAAAA,G,GAAMH,KAAK,CAAC,KAAKQ,KAAN,C;;oBACZL,G;;;;;;;;uBAIwBA,GAAG,CAACA,GAAG,CAACE,MAAJ,GAAa,CAAd,C,EAAzBI,S,QAAAA,S,EAAWL,O,QAAAA,O;AAEZM,gBAAAA,K,GAAQ,KAAKC,sBAAL,CAA4BX,KAA5B,EAAmCC,WAAnC,C;AAKRW,gBAAAA,E,GAAKC,iBAASC,MAAT,CAAgBL,SAAhB,EAA2BM,OAA3B,KAAuC,G;AAC5CC,gBAAAA,W,GAAcf,WAAW,CAC5BgB,IADiB,CACZ,KAAKC,UADO,EAEjBC,SAFiB,CAEPf,OAAO,CAACgB,SAFD,EAEYhB,OAAO,CAACiB,QAFpB,EAE8BjB,OAAO,CAACkB,QAFtC,EAGjBb,SAHiB,CAGPG,EAHO,EAIjBW,QAJiB,CAIR,CAJQ,EAIL,CAJK,EAIF,CAJE,C;;AAOpB,oBAAIb,KAAK,IAAIA,KAAK,CAACJ,QAAnB,EAA6B;AACpBA,kBAAAA,QADoB,GACRI,KADQ,CACpBJ,QADoB;AAE3BU,kBAAAA,WAAW,CAACT,WAAZ,CAAwBD,QAAQ,CAACkB,IAAjC,EAAuClB,QAAQ,CAACmB,KAAhD,EAAuDnB,QAAQ,CAACoB,GAAhE;AACD;;;;;;;;;;;;;;;;;;gCAGSC,e,EAAiBC,O,EAAS;AACpCD,MAAAA,eAAe,CAACE,MAAhB,CAAuB,KAAKX,UAA5B,EAAwCY,QAAxC,CAAiD,MAAjD;AACD;;;wBApDiB;AAChB,aAAO,iBAAP;AACD;;;wBAEwB;AACvB,aAAO,uBAAP;AACD;;;EAXkCC,qB","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport Converter from './converter';\nimport {quaternionToEuler} from '../common/quaternion';\nimport {TimeUtil} from 'rosbag';\n\nexport class SensorNavSatFix extends Converter {\n  constructor(config) {\n    super(config);\n  }\n\n  static get name() {\n    return 'SensorNavSatFix';\n  }\n\n  static get messageType() {\n    return 'sensor_msgs/NavSatFix';\n  }\n\n  _getOrientationFromIMU(frame, xvizBuilder) {\n    if (!this.config.imuTopic) {\n      return null;\n    }\n\n    const msg = frame[this.config.imuTopic];\n    if (!msg) {\n      return null;\n    }\n\n    const {message} = msg[msg.length - 1];\n    const rotation = quaternionToEuler(message.orientation);\n    return {rotation};\n  }\n\n  async convertMessage(frame, xvizBuilder) {\n    const msg = frame[this.topic];\n    if (!msg) {\n      return;\n    }\n\n    const {timestamp, message} = msg[msg.length - 1];\n\n    const state = this._getOrientationFromIMU(frame, xvizBuilder);\n\n    // Every frame *MUST* have a pose. The pose can be considered\n    // the core reference point for other data and usually drives the timing\n    // of the system.\n    const ts = TimeUtil.toDate(timestamp).getTime() / 1e3;\n    const poseBuilder = xvizBuilder\n      .pose(this.xvizStream)\n      .mapOrigin(message.longitude, message.latitude, message.altitude)\n      .timestamp(ts)\n      .position(0, 0, 0);\n\n    // Add rotation to the pose\n    if (state && state.rotation) {\n      const {rotation} = state;\n      poseBuilder.orientation(rotation.roll, rotation.pitch, rotation.yaw);\n    }\n  }\n\n  getMetadata(xvizMetaBuilder, context) {\n    xvizMetaBuilder.stream(this.xvizStream).category('pose');\n  }\n}\n"],"file":"sensor-navsatfix-converter.js"}