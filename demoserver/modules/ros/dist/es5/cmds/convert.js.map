{"version":3,"sources":["../../../src/cmds/convert.js"],"names":["convertArgs","inArgs","cmd","command","StartEndOptions","directory","alias","describe","type","required","rosConfig","format","choices","nargs","convertCmd","args","bag","start","end","deleteDirRecursive","err","createDir","source","FileSource","XVIZProviderFactory","open","options","root","provider","Error","sink","FileSink","iterator","getMessageIterator","startTime","endTime","valid","writer","XVIZFormatWriter","md","xvizMetadata","setMetadataTimes","message","data","writeMetadata","signalWriteIndexOnInterrupt","frameSequence","xvizMessage","process","stdout","write","writeMessage","console","log","close","metadata","logInfo","log_info","start_time","end_time","on","exit","dirPath","fs","existsSync","parent","path","dirname","mkdirSync","parentDir","files","readdirSync","forEach","file","currPath","join","lstatSync","isDirectory","unlinkSync","rmdirSync"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* global console */\n/* eslint-disable no-console, complexity, max-statements */\nimport {XVIZFormatWriter} from '@xviz/io';\nimport {FileSource, FileSink} from '@xviz/io/node';\nimport {XVIZProviderFactory} from '@xviz/io';\n\nimport {StartEndOptions} from './common';\n\nimport process from 'process';\nimport fs from 'fs';\nimport path from 'path';\n\nexport function convertArgs(inArgs) {\n  const cmd = 'convert [-d output] <bag>';\n\n  return inArgs.command(\n    cmd,\n    'Convert a rosbag to xviz',\n    {\n      ...StartEndOptions,\n      directory: {\n        alias: 'd',\n        describe: 'Directory to save XVIZ data',\n        type: 'string',\n        required: true\n      },\n      rosConfig: {\n        describe: 'Path to ROS Bag JSON configuration',\n        type: 'string',\n        required: true\n      },\n      format: {\n        describe: 'Output data format',\n        default: 'BINARY_GLB',\n        choices: ['JSON_STRING', 'BINARY_GLB'],\n        nargs: 1\n      }\n    },\n    convertCmd\n  );\n}\n\nexport async function convertCmd(args) {\n  const {bag, directory, start, end, format} = args;\n\n  // Setup output directory\n  try {\n    deleteDirRecursive(directory);\n  } catch (err) {\n    // ignore\n  }\n  createDir(directory);\n\n  const source = new FileSource(bag);\n  const provider = await XVIZProviderFactory.open({\n    options: {...args},\n    source,\n    root: bag\n  });\n\n  if (!provider) {\n    throw new Error('Failed to create ROSBagProvider');\n  }\n\n  // This abstracts the details of the filenames expected by our server\n  const sink = new FileSink(directory);\n\n  const iterator = provider.getMessageIterator({startTime: start, endTime: end});\n  if (!iterator.valid()) {\n    throw new Error('Error creating and iterator');\n  }\n\n  const writer = new XVIZFormatWriter(sink, {format});\n\n  const md = provider.xvizMetadata();\n\n  // Augment metadata with timing information\n  // if provided\n  setMetadataTimes(md.message().data, start, end);\n  writer.writeMetadata(md);\n\n  // If we get interrupted make sure the index is written out\n  signalWriteIndexOnInterrupt(writer);\n\n  // Process data\n  let frameSequence = 0;\n  while (iterator.valid()) {\n    const data = await provider.xvizMessage(iterator);\n    if (data) {\n      process.stdout.write(`Writing frame ${frameSequence}\\r`);\n      writer.writeMessage(frameSequence, data);\n      frameSequence += 1;\n    } else {\n      console.log(`No data for frame ${frameSequence}`);\n    }\n  }\n\n  writer.close();\n}\n\n/* eslint-disable camelcase */\nfunction setMetadataTimes(metadata, start, end) {\n  if (start || end) {\n    if (start) {\n      const logInfo = metadata.log_info || {};\n      logInfo.start_time = start;\n    }\n\n    if (end) {\n      const logInfo = metadata.log_info || {};\n      logInfo.end_time = end;\n    }\n  }\n}\n/* eslint-enable camelcase */\n\nfunction signalWriteIndexOnInterrupt(writer) {\n  process.on('SIGINT', () => {\n    console.log('Aborting, writing index file.');\n    writer.close();\n    process.exit(0); // eslint-disable-line no-process-exit\n  });\n}\n\nfunction createDir(dirPath) {\n  if (!fs.existsSync(dirPath)) {\n    // make sure parent exists\n    const parent = path.dirname(dirPath);\n    createDir(parent);\n\n    fs.mkdirSync(dirPath);\n  }\n}\n\nfunction deleteDirRecursive(parentDir) {\n  const files = fs.readdirSync(parentDir);\n  files.forEach(file => {\n    const currPath = path.join(parentDir, file);\n    if (fs.lstatSync(currPath).isDirectory()) {\n      // recurse\n      deleteDirRecursive(currPath);\n    } else {\n      // delete file\n      fs.unlinkSync(currPath);\n    }\n  });\n\n  fs.rmdirSync(parentDir);\n}\n"],"file":"convert.js"}