{"version":3,"sources":["../../../src/cmds/convert.js"],"names":["XVIZFormatWriter","FileSource","FileSink","XVIZProviderFactory","StartEndOptions","process","fs","path","convertArgs","inArgs","cmd","command","directory","alias","describe","type","required","rosConfig","format","choices","nargs","convertCmd","args","bag","start","end","deleteDirRecursive","err","createDir","source","open","options","root","provider","Error","sink","iterator","getMessageIterator","startTime","endTime","valid","writer","md","xvizMetadata","setMetadataTimes","message","data","writeMetadata","signalWriteIndexOnInterrupt","frameSequence","xvizMessage","stdout","write","writeMessage","console","log","close","metadata","logInfo","log_info","start_time","end_time","on","exit","dirPath","existsSync","parent","dirname","mkdirSync","parentDir","files","readdirSync","forEach","file","currPath","join","lstatSync","isDirectory","unlinkSync","rmdirSync"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* global console */\n/* eslint-disable no-console, complexity, max-statements */\nimport {XVIZFormatWriter} from '@xviz/io';\nimport {FileSource, FileSink} from '@xviz/io/node';\nimport {XVIZProviderFactory} from '@xviz/io';\n\nimport {StartEndOptions} from './common';\n\nimport process from 'process';\nimport fs from 'fs';\nimport path from 'path';\n\nexport function convertArgs(inArgs) {\n  const cmd = 'convert [-d output] <bag>';\n\n  return inArgs.command(\n    cmd,\n    'Convert a rosbag to xviz',\n    {\n      ...StartEndOptions,\n      directory: {\n        alias: 'd',\n        describe: 'Directory to save XVIZ data',\n        type: 'string',\n        required: true\n      },\n      rosConfig: {\n        describe: 'Path to ROS Bag JSON configuration',\n        type: 'string',\n        required: true\n      },\n      format: {\n        describe: 'Output data format',\n        default: 'BINARY_GLB',\n        choices: ['JSON_STRING', 'BINARY_GLB'],\n        nargs: 1\n      }\n    },\n    convertCmd\n  );\n}\n\nexport async function convertCmd(args) {\n  const {bag, directory, start, end, format} = args;\n\n  // Setup output directory\n  try {\n    deleteDirRecursive(directory);\n  } catch (err) {\n    // ignore\n  }\n  createDir(directory);\n\n  const source = new FileSource(bag);\n  const provider = await XVIZProviderFactory.open({\n    options: {...args},\n    source,\n    root: bag\n  });\n\n  if (!provider) {\n    throw new Error('Failed to create ROSBagProvider');\n  }\n\n  // This abstracts the details of the filenames expected by our server\n  const sink = new FileSink(directory);\n\n  const iterator = provider.getMessageIterator({startTime: start, endTime: end});\n  if (!iterator.valid()) {\n    throw new Error('Error creating and iterator');\n  }\n\n  const writer = new XVIZFormatWriter(sink, {format});\n\n  const md = provider.xvizMetadata();\n\n  // Augment metadata with timing information\n  // if provided\n  setMetadataTimes(md.message().data, start, end);\n  writer.writeMetadata(md);\n\n  // If we get interrupted make sure the index is written out\n  signalWriteIndexOnInterrupt(writer);\n\n  // Process data\n  let frameSequence = 0;\n  while (iterator.valid()) {\n    const data = await provider.xvizMessage(iterator);\n    if (data) {\n      process.stdout.write(`Writing frame ${frameSequence}\\r`);\n      writer.writeMessage(frameSequence, data);\n      frameSequence += 1;\n    } else {\n      console.log(`No data for frame ${frameSequence}`);\n    }\n  }\n\n  writer.close();\n}\n\n/* eslint-disable camelcase */\nfunction setMetadataTimes(metadata, start, end) {\n  if (start || end) {\n    if (start) {\n      const logInfo = metadata.log_info || {};\n      logInfo.start_time = start;\n    }\n\n    if (end) {\n      const logInfo = metadata.log_info || {};\n      logInfo.end_time = end;\n    }\n  }\n}\n/* eslint-enable camelcase */\n\nfunction signalWriteIndexOnInterrupt(writer) {\n  process.on('SIGINT', () => {\n    console.log('Aborting, writing index file.');\n    writer.close();\n    process.exit(0); // eslint-disable-line no-process-exit\n  });\n}\n\nfunction createDir(dirPath) {\n  if (!fs.existsSync(dirPath)) {\n    // make sure parent exists\n    const parent = path.dirname(dirPath);\n    createDir(parent);\n\n    fs.mkdirSync(dirPath);\n  }\n}\n\nfunction deleteDirRecursive(parentDir) {\n  const files = fs.readdirSync(parentDir);\n  files.forEach(file => {\n    const currPath = path.join(parentDir, file);\n    if (fs.lstatSync(currPath).isDirectory()) {\n      // recurse\n      deleteDirRecursive(currPath);\n    } else {\n      // delete file\n      fs.unlinkSync(currPath);\n    }\n  });\n\n  fs.rmdirSync(parentDir);\n}\n"],"file":"convert.js"}