{"version":3,"sources":["../../../src/core/ros-2-xviz.js"],"names":["XVIZBuilder","ROS2XVIZConverter","constructor","converters","rosConfig","options","instances","verbose","msg","logger","_makeConvertersForTopic","entry","topicMessageTypes","aux","topic","type","converter","config","ConverterClass","find","conv","name","msgType","messageType","converterConfig","push","initializeConverters","count","entryCount","topicConfig","key","length","Error","buildMetadata","metadataBuilder","instance","getMetadata","metadata","buildMessage","frame","xvizBuilder","disableStreams","convertMessage","frm","getMessage","err"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n// Given a mapping, this will initialize the converter classes and manage delegating\n// the building of metadata and messsages to the converters\n/* eslint-disable no-continue, max-depth */\n\nimport {XVIZBuilder} from '@xviz/builder';\n\nexport class ROS2XVIZConverter {\n  constructor(converters, rosConfig, options = {}) {\n    // options: {logger}\n    this.options = options;\n\n    // Converters: [\n    //  converterClass { name, messageType }\n    // ]\n    this.converters = converters;\n\n    // Would represent all available topics handled\n    // or null if just mapping by converters.messageType\n    // rosConfig: {\n    //  topicConfig: [\n    //    { topic, type, converter, config: {xvizStream}\n    //  ]\n    // }\n    this.rosConfig = rosConfig;\n\n    this.instances = [];\n  }\n\n  verbose(msg) {\n    const {logger} = this.options;\n    if (logger && logger.verbose) {\n      logger.verbose(msg);\n    }\n  }\n\n  // Make a converter for each topic.\n  // If we have a rosConfig, that will be used to find a converter\n  //\n  // if we don't have a rosConfig, we will just find one based on\n  // the message type\n  _makeConvertersForTopic(entry, topicMessageTypes, aux) {\n    const {topic, type, converter, config} = entry;\n    const {converters} = this;\n\n    let ConverterClass = null;\n\n    // Specific converter by name\n    if (converter) {\n      this.verbose(`ROS2XVIZConverter setting up converter by name for '${topic}'`);\n      ConverterClass = converters.find(conv => conv.name === converter);\n      if (!ConverterClass) {\n        this.verbose(\n          `ROS2XVIZConverter cannot find the converter with name '${converter}' for topic '${topic}'`\n        );\n      }\n    } else {\n      // converter by message type\n      const msgType = type || topicMessageTypes[topic];\n      if (!msgType) {\n        this.verbose(`ROS2XVIZConverter does not have a type for the '${topic}', skipping`);\n      } else {\n        this.verbose(`ROS2XVIZConverter setting up converter by type '${msgType}' for '${topic}'`);\n        ConverterClass = converters.find(conv => conv.messageType === msgType);\n        if (!ConverterClass) {\n          this.verbose(\n            `ROS2XVIZConverter cannot find the converter for message type '${msgType}' for topic '${topic}'`\n          );\n        }\n      }\n    }\n\n    if (ConverterClass) {\n      // aux could have origin, frameIdToPoseMap\n      const converterConfig = {...this.options, ...aux, ...config, topic};\n      this.instances.push(new ConverterClass(converterConfig));\n    }\n  }\n\n  // Using the rosConfig, we have to initialize a converter for each entry.\n  // Note this must support 1-1 and 1-m topic to Converter mappings.\n  //\n  // topicMessageTypes is used if the entries in the rosConfig\n  // to not have a type or converter named.\n  initializeConverters(topicMessageTypes, aux) {\n    const {rosConfig} = this;\n    // topicMessageTypes {topic: type, ...}\n    // aux { origin, frameIdToPoseMap }\n\n    const count = rosConfig.entryCount;\n\n    if (count > 0) {\n      // Construct by rosConfig\n      for (const entry of rosConfig.topicConfig) {\n        this._makeConvertersForTopic(entry, topicMessageTypes, aux);\n      }\n    } else {\n      // Construct by topic type\n      for (const key in topicMessageTypes) {\n        this._makeConvertersForTopic(\n          {topic: key, type: topicMessageTypes[key]},\n          topicMessageTypes,\n          aux\n        );\n      }\n    }\n\n    if (this.instances.length === 0) {\n      throw new Error(\n        'No converters where created. Check that the configuration is correct and the Converter classes are properly registered.'\n      );\n    }\n  }\n\n  buildMetadata(metadataBuilder, aux) {\n    // aux = { frameIdToPoseMap }\n\n    for (const instance of this.instances) {\n      instance.getMetadata(metadataBuilder, aux);\n    }\n\n    this.metadata = metadataBuilder.getMetadata();\n  }\n\n  async buildMessage(frame) {\n    const xvizBuilder = new XVIZBuilder(this.metadata, this.disableStreams, {});\n\n    for (const instance of this.instances) {\n      await instance.convertMessage(frame, xvizBuilder);\n    }\n\n    try {\n      const frm = xvizBuilder.getMessage();\n      return frm;\n    } catch (err) {\n      return null;\n    }\n  }\n}\n"],"file":"ros-2-xviz.js"}