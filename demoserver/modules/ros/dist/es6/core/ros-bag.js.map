{"version":3,"sources":["../../../src/core/ros-bag.js"],"names":["open","TimeUtil","quaternionToEuler","ROSBag","constructor","bagPath","rosConfig","options","bagContext","topicMessageTypes","init","ros2xviz","bag","_openBag","_initBag","needsTopicTypes","_gatherTopicsTypes","_initTopics","TF","TF_STATIC","start_time","toDate","startTime","getTime","end_time","endTime","frameIdToPoseMap","readMessages","topics","topic","message","transforms","forEach","t","child_frame_id","transform","translation","rotation","conn","connections","type","includes","Error","initializeConverters","getMetadata","metadataBuilder","buildMetadata","start","end","frame","fromDate","Date","result","data","Buffer","from","push"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* global Buffer */\n/* eslint-disable camelcase */\nimport {open, TimeUtil} from 'rosbag';\nimport {quaternionToEuler} from '../common/quaternion';\n\nexport class ROSBag {\n  constructor(bagPath, rosConfig, options = {}) {\n    this.bagPath = bagPath;\n    this.rosConfig = rosConfig;\n    this.options = options;\n\n    this.bagContext = {};\n    this.topicMessageTypes = {};\n  }\n\n  // Open the ROS Bag and collect information\n  async init(ros2xviz) {\n    const bag = await this._openBag();\n\n    await this._initBag(bag);\n\n    // If we already have types for every topic, then\n    // we do not need to scan the bag file.\n    if (this.rosConfig.needsTopicTypes()) {\n      this._gatherTopicsTypes(bag);\n    }\n\n    this._initTopics(ros2xviz);\n\n    return true;\n  }\n\n  async _openBag() {\n    return await open(this.bagPath);\n  }\n\n  /**\n   * Clients may subclass and expand this method\n   * in order to support any special processing for their specific\n   * topics.\n   *\n   * Extracts:\n   *   frameIdToPoseMap: ROS /tf transform tree\n   *   start_time,\n   *   end_time,\n   *   origin: map origin\n   */\n  async _initBag(bag) {\n    const TF = '/tf';\n    const TF_STATIC = '/tf_static';\n\n    this.bagContext.start_time = TimeUtil.toDate(bag.startTime).getTime() / 1e3;\n    this.bagContext.end_time = TimeUtil.toDate(bag.endTime).getTime() / 1e3;\n\n    const frameIdToPoseMap = {};\n    await bag.readMessages({topics: [TF, TF_STATIC]}, ({topic, message}) => {\n      message.transforms.forEach(t => {\n        frameIdToPoseMap[t.child_frame_id] = {\n          ...t.transform.translation,\n          ...quaternionToEuler(t.transform.rotation)\n        };\n      });\n    });\n\n    this.bagContext.frameIdToPoseMap = frameIdToPoseMap;\n  }\n\n  // Collecting the topic & types can be expensive, so we only\n  // collect them if they are not already in the configuration\n  _gatherTopicsTypes(bag) {\n    const topics = this.rosConfig.topics;\n\n    for (const conn in bag.connections) {\n      const {topic, type} = bag.connections[conn];\n\n      // Filter if 'topics' are provided\n      if (!topics || topics.includes(topic)) {\n        // Validate that the message type does not change\n        if (this.topicMessageTypes[topic] && this.topicMessageTypes[topic] !== type) {\n          throw new Error(\n            `Unexpected change in topic type ${topic} has ${\n              this.topicMessageTypes[topic]\n            } with new type ${type}`\n          );\n        } else if (!this.topicMessageTypes[topic]) {\n          // track we have seen it and add to list\n          this.topicMessageTypes[topic] = type;\n        }\n      }\n    }\n  }\n\n  // Using topics and message type, ensure we create a converter\n  // for each topic.\n  _initTopics(ros2xviz) {\n    ros2xviz.initializeConverters(this.topicMessageTypes, this.bagContext);\n  }\n\n  getMetadata(metadataBuilder, ros2xviz) {\n    ros2xviz.buildMetadata(metadataBuilder, this.bagContext);\n\n    metadataBuilder.startTime(this.bagContext.start_time);\n    metadataBuilder.endTime(this.bagContext.end_time);\n  }\n\n  // Synchronize xviz messages by timestep\n  async readMessages(start, end) {\n    const bag = await this._openBag();\n    const frame = {};\n\n    const options = {\n      topics: this.rosConfig.topics\n    };\n\n    if (start) {\n      options.startTime = TimeUtil.fromDate(new Date(start * 1e3));\n    }\n\n    if (end) {\n      options.endTime = TimeUtil.fromDate(new Date(end * 1e3));\n    }\n\n    await bag.readMessages(options, async result => {\n      // rosbag.js reuses the data buffer for subsequent messages, so we need to make a copy\n      if (result.message.data) {\n        // Used for binary data in images, point clouds, etc\n        // TODO(this needs to work in the browser)\n        result.message.data = Buffer.from(result.message.data);\n      }\n\n      frame[result.topic] = frame[result.topic] || [];\n      frame[result.topic].push(result);\n    });\n\n    return frame;\n  }\n}\n"],"file":"ros-bag.js"}