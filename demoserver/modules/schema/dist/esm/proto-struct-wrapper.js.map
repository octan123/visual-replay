{"version":3,"sources":["../../src/proto-struct-wrapper.js"],"names":["wrappers","is","StructEncode","options","seenObjects","Set","removeCircular","stringify","obj","convertedObject","fields","add","prop","hasOwnProperty","value","undefined","encodeValue","convertedValue","nullValue","number","numberValue","string","stringValue","boolValue","object","has","Error","join","structValue","encodeStruct","array","listValue","values","map","bind","String","StructDecode","kind","decodeStruct","decodeValue","struct","fromObject","toObject","message"],"mappings":";;;AAqBA,SAAQA,QAAR,QAAuB,YAAvB;AACA,OAAO,KAAKC,EAAZ,MAAoB,IAApB;AAEA,WAAaC,YAAb;AAKE,wBAAYC,OAAZ,EAAqB;AAAA;;AACnBA,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AAEA,SAAKC,WAAL,GAAmB,IAAIC,GAAJ,EAAnB;AACA,SAAKC,cAAL,GAAsBH,OAAO,CAACG,cAAR,KAA2B,IAAjD;AACA,SAAKC,SAAL,GAAiBJ,OAAO,CAACI,SAAR,KAAsB,IAAvC;AACD;;AAXH;AAAA;AAAA,iCAaeC,GAbf,EAaoB;AAChB,UAAMC,eAAe,GAAG;AACtBC,QAAAA,MAAM,EAAE;AADc,OAAxB;AAIA,WAAKN,WAAL,CAAiBO,GAAjB,CAAqBH,GAArB;;AAEA,WAAK,IAAMI,IAAX,IAAmBJ,GAAnB,EAAwB;AACtB,YAAIA,GAAG,CAACK,cAAJ,CAAmBD,IAAnB,CAAJ,EAA8B;AAC5B,cAAME,KAAK,GAAGN,GAAG,CAACI,IAAD,CAAjB;;AAEA,cAAIX,EAAE,CAACc,SAAH,CAAaD,KAAb,CAAJ,EAAyB;AACvB;AACD;;AAEDL,UAAAA,eAAe,CAACC,MAAhB,CAAuBE,IAAvB,IAA+B,KAAKI,WAAL,CAAiBF,KAAjB,CAA/B;AACD;AACF;;AAED,WAAKV,WAAL,WAAwBI,GAAxB;AAEA,aAAOC,eAAP;AACD;AAnCH;AAAA;AAAA,gCAqCcK,KArCd,EAqCqB;AACjB,UAAIG,cAAJ;;AAEA,UAAIhB,EAAE,QAAF,CAAQa,KAAR,CAAJ,EAAoB;AAClBG,QAAAA,cAAc,GAAG;AACfC,UAAAA,SAAS,EAAE;AADI,SAAjB;AAGD,OAJD,MAIO,IAAIjB,EAAE,CAACkB,MAAH,CAAUL,KAAV,CAAJ,EAAsB;AAC3BG,QAAAA,cAAc,GAAG;AACfG,UAAAA,WAAW,EAAEN;AADE,SAAjB;AAGD,OAJM,MAIA,IAAIb,EAAE,CAACoB,MAAH,CAAUP,KAAV,CAAJ,EAAsB;AAC3BG,QAAAA,cAAc,GAAG;AACfK,UAAAA,WAAW,EAAER;AADE,SAAjB;AAGD,OAJM,MAIA,IAAIb,EAAE,WAAF,CAAWa,KAAX,CAAJ,EAAuB;AAC5BG,QAAAA,cAAc,GAAG;AACfM,UAAAA,SAAS,EAAET;AADI,SAAjB;AAQD,OATM,MASA,IAAIb,EAAE,CAACuB,MAAH,CAAUV,KAAV,CAAJ,EAAsB;AAC3B,YAAI,KAAKV,WAAL,CAAiBqB,GAAjB,CAAqBX,KAArB,CAAJ,EAAiC;AAE/B,cAAI,CAAC,KAAKR,cAAV,EAA0B;AACxB,kBAAM,IAAIoB,KAAJ,CACJ,CACE,6DADF,EAEE,qDAFF,EAGEC,IAHF,CAGO,GAHP,CADI,CAAN;AAMD;;AACDV,UAAAA,cAAc,GAAG;AACfK,YAAAA,WAAW,EAAE;AADE,WAAjB;AAGD,SAbD,MAaO;AACLL,UAAAA,cAAc,GAAG;AACfW,YAAAA,WAAW,EAAE,KAAKC,YAAL,CAAkBf,KAAlB;AADE,WAAjB;AAGD;AACF,OAnBM,MAmBA,IAAIb,EAAE,CAAC6B,KAAH,CAAShB,KAAT,CAAJ,EAAqB;AAC1BG,QAAAA,cAAc,GAAG;AACfc,UAAAA,SAAS,EAAE;AACTC,YAAAA,MAAM,EAAElB,KAAK,CAACmB,GAAN,CAAU,KAAKjB,WAAL,CAAiBkB,IAAjB,CAAsB,IAAtB,CAAV;AADC;AADI,SAAjB;AAKD,OANM,MAMA;AACL,YAAI,CAAC,KAAK3B,SAAV,EAAqB;AACnB,gBAAM,IAAImB,KAAJ,iCAAkCZ,KAAlC,uBAAN;AACD;;AAEDG,QAAAA,cAAc,GAAG;AACfK,UAAAA,WAAW,EAAEa,MAAM,CAACrB,KAAD;AADJ,SAAjB;AAGD;;AAED,aAAOG,cAAP;AACD;AAjGH;;AAAA;AAAA;AAoGA,WAAamB,YAAb;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,gCACqBtB,KADrB,EAC4B;AACxB,cAAQA,KAAK,CAACuB,IAAd;AACE,aAAK,aAAL;AAAoB;AAClB,mBAAOD,YAAY,CAACE,YAAb,CAA0BxB,KAAK,CAACc,WAAhC,CAAP;AACD;;AAED,aAAK,WAAL;AAAkB;AAChB,mBAAO,IAAP;AACD;;AAED,aAAK,WAAL;AAAkB;AAChB,mBAAOd,KAAK,CAACiB,SAAN,CAAgBC,MAAhB,CAAuBC,GAAvB,CAA2BG,YAAY,CAACG,WAAxC,CAAP;AACD;;AAED;AAAS;AACP,mBAAOzB,KAAK,CAACA,KAAK,CAACuB,IAAP,CAAZ;AACD;AAfH;AAiBD;AAnBH;AAAA;AAAA,iCAqBsBG,MArBtB,EAqB8B;AAC1B,UAAM/B,eAAe,GAAG,EAAxB;;AAEA,WAAK,IAAMG,IAAX,IAAmB4B,MAAM,CAAC9B,MAA1B,EAAkC;AAChC,YAAI8B,MAAM,CAAC9B,MAAP,CAAcG,cAAd,CAA6BD,IAA7B,CAAJ,EAAwC;AACtC,cAAME,KAAK,GAAG0B,MAAM,CAAC9B,MAAP,CAAcE,IAAd,CAAd;AACAH,UAAAA,eAAe,CAACG,IAAD,CAAf,GAAwBwB,YAAY,CAACG,WAAb,CAAyBzB,KAAzB,CAAxB;AACD;AACF;;AAED,aAAOL,eAAP;AACD;AAhCH;;AAAA;AAAA;AAmCAT,QAAQ,CAAC,wBAAD,CAAR,GAAqC;AACnCyC,EAAAA,UADmC,sBACxBjB,MADwB,EAChB;AACjB,QAAIA,MAAJ,EAAY;AACV,aAAO,IAAItB,YAAJ,GAAmBc,WAAnB,CAA+BQ,MAA/B,CAAP;AACD;;AAED,WAAO,KAAKiB,UAAL,CAAgBjB,MAAhB,CAAP;AACD,GAPkC;AASnCkB,EAAAA,QATmC,oBAS1BC,OAT0B,EASjB;AAChB,WAAOP,YAAY,CAACG,WAAb,CAAyBI,OAAzB,CAAP;AACD;AAXkC,CAArC;AAcA3C,QAAQ,CAAC,yBAAD,CAAR,GAAsC;AACpCyC,EAAAA,UADoC,sBACzBjB,MADyB,EACjB;AACjB,QAAIA,MAAJ,EAAY;AACV,aAAO,IAAItB,YAAJ,GAAmB2B,YAAnB,CAAgCL,MAAhC,CAAP;AACD;;AAED,WAAO,KAAKiB,UAAL,CAAgBjB,MAAhB,CAAP;AACD,GAPmC;AASpCkB,EAAAA,QAToC,oBAS3BC,OAT2B,EASlB;AAChB,WAAOP,YAAY,CAACE,YAAb,CAA0BK,OAA1B,CAAP;AACD;AAXmC,CAAtC","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Add support well known type google.protobuf.Struct.  Which when\n// encountered by full protobuf implementation it gets transparently\n// turned in JSON and back.\n\n// Code from, only changes are conversion to ES6 from typescript\n// https://github.com/dcodeIO/protobuf.js/issues/839#issuecomment-401279631\n\nimport {wrappers} from 'protobufjs';\nimport * as is from 'is';\n\nexport class StructEncode {\n  // seenObjects: Set<{}>;\n  // removeCircular: boolean;\n  // stringify?: boolean;\n\n  constructor(options) {\n    options = options || {};\n\n    this.seenObjects = new Set();\n    this.removeCircular = options.removeCircular === true;\n    this.stringify = options.stringify === true;\n  }\n\n  encodeStruct(obj) {\n    const convertedObject = {\n      fields: {}\n    };\n\n    this.seenObjects.add(obj);\n\n    for (const prop in obj) {\n      if (obj.hasOwnProperty(prop)) {\n        const value = obj[prop];\n\n        if (is.undefined(value)) {\n          continue; // eslint-disable-line no-continue\n        }\n\n        convertedObject.fields[prop] = this.encodeValue(value);\n      }\n    }\n\n    this.seenObjects.delete(obj);\n\n    return convertedObject;\n  }\n\n  encodeValue(value) {\n    let convertedValue;\n\n    if (is.null(value)) {\n      convertedValue = {\n        nullValue: 0\n      };\n    } else if (is.number(value)) {\n      convertedValue = {\n        numberValue: value\n      };\n    } else if (is.string(value)) {\n      convertedValue = {\n        stringValue: value\n      };\n    } else if (is.boolean(value)) {\n      convertedValue = {\n        boolValue: value\n      };\n      // Not supported in Node.js and not needed for our level of support\n      // } else if (Buffer.isBuffer(value)) {\n      //   convertedValue = {\n      //     blobValue: value\n      //   };\n    } else if (is.object(value)) {\n      if (this.seenObjects.has(value)) {\n        // Circular reference.\n        if (!this.removeCircular) {\n          throw new Error(\n            [\n              'This object contains a circular reference. To automatically',\n              'remove it, set the `removeCircular` option to true.'\n            ].join(' ')\n          );\n        }\n        convertedValue = {\n          stringValue: '[Circular]'\n        };\n      } else {\n        convertedValue = {\n          structValue: this.encodeStruct(value)\n        };\n      }\n    } else if (is.array(value)) {\n      convertedValue = {\n        listValue: {\n          values: value.map(this.encodeValue.bind(this))\n        }\n      };\n    } else {\n      if (!this.stringify) {\n        throw new Error(`Value of type ${typeof value} not recognized.`);\n      }\n\n      convertedValue = {\n        stringValue: String(value)\n      };\n    }\n\n    return convertedValue;\n  }\n}\n\nexport class StructDecode {\n  static decodeValue(value) {\n    switch (value.kind) {\n      case 'structValue': {\n        return StructDecode.decodeStruct(value.structValue);\n      }\n\n      case 'nullValue': {\n        return null;\n      }\n\n      case 'listValue': {\n        return value.listValue.values.map(StructDecode.decodeValue);\n      }\n\n      default: {\n        return value[value.kind];\n      }\n    }\n  }\n\n  static decodeStruct(struct) {\n    const convertedObject = {};\n\n    for (const prop in struct.fields) {\n      if (struct.fields.hasOwnProperty(prop)) {\n        const value = struct.fields[prop];\n        convertedObject[prop] = StructDecode.decodeValue(value);\n      }\n    }\n\n    return convertedObject;\n  }\n}\n\nwrappers['.google.protobuf.Value'] = {\n  fromObject(object) {\n    if (object) {\n      return new StructEncode().encodeValue(object);\n    }\n\n    return this.fromObject(object);\n  },\n\n  toObject(message) {\n    return StructDecode.decodeValue(message);\n  }\n};\n\nwrappers['.google.protobuf.Struct'] = {\n  fromObject(object) {\n    if (object) {\n      return new StructEncode().encodeStruct(object);\n    }\n\n    return this.fromObject(object);\n  },\n\n  toObject(message) {\n    return StructDecode.decodeStruct(message);\n  }\n};\n"],"file":"proto-struct-wrapper.js"}