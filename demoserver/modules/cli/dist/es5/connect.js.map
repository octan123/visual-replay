{"version":3,"sources":["../../src/connect.js"],"names":["W3CWebSocket","require","w3cwebsocket","openSource","args","middlewares","isLive","push","TransformLogFlow","metadata","OnlyMetadata","socket","webSocketFromArgs","stackedMiddleware","XVIZMiddlewareStack","client","WebSocketInterface","middleware","i","length","sigintCount","process","on","console","log","close","exit","url","urlFromArgs","createWebSocket","undefined","extraArgs","host","maxReceivedFrameSize","maxReceivedMessageSize"],"mappings":";;;;;;;;;;;AAiBA;;AACA;;AACA;;AAEA,IAAMA,YAAY,GAAGC,OAAO,CAAC,WAAD,CAAP,CAAqBC,YAA1C;;AAOO,SAASC,UAAT,CAAoBC,IAApB,EAA0BC,WAA1B,EAAuC;AAE5C,MAAI,CAACC,MAAM,CAACF,IAAD,CAAX,EAAmB;AACjBC,IAAAA,WAAW,CAACE,IAAZ,CAAiB,IAAIC,sBAAJ,CAAqB,IAArB,EAA2BJ,IAA3B,CAAjB;AACD;;AAGD,MAAIA,IAAI,CAACK,QAAT,EAAmB;AACjBJ,IAAAA,WAAW,CAACE,IAAZ,CAAiB,IAAIG,kBAAJ,CAAiB,IAAjB,CAAjB;AACD;;AAGD,MAAMC,MAAM,GAAGC,iBAAiB,CAACR,IAAD,CAAhC;AACA,MAAMS,iBAAiB,GAAG,IAAIC,+BAAJ,CAAwBT,WAAxB,CAA1B;AAEA,MAAMU,MAAM,GAAG,IAAIC,6BAAJ,CAAuB;AAACC,IAAAA,UAAU,EAAEJ,iBAAb;AAAgCF,IAAAA,MAAM,EAANA;AAAhC,GAAvB,CAAf;;AAIA,OAAK,IAAIO,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGb,WAAW,CAACc,MAAhC,EAAwC,EAAED,CAA1C,EAA6C;AAC3C,QAAMD,UAAU,GAAGZ,WAAW,CAACa,CAAD,CAA9B;;AACA,QAAID,UAAU,CAACF,MAAX,KAAsB,IAA1B,EAAgC;AAC9BE,MAAAA,UAAU,CAACF,MAAX,GAAoBA,MAApB;AACD;AACF;;AAGD,MAAIK,WAAW,GAAG,CAAlB;AACAC,EAAAA,OAAO,CAACC,EAAR,CAAW,QAAX,EAAqB,YAAM;AACzB,QAAIF,WAAW,KAAK,CAApB,EAAuB;AACrBG,MAAAA,OAAO,CAACC,GAAR,CAAY,SAAZ;AACAb,MAAAA,MAAM,CAACc,KAAP;AACD,KAHD,MAGO;AAELF,MAAAA,OAAO,CAACC,GAAR,CAAY,UAAZ;AACAH,MAAAA,OAAO,CAACK,IAAR,CAAa,CAAb;AACD;;AAEDN,IAAAA,WAAW;AACZ,GAXD;AAaA,SAAOL,MAAP;AACD;;AAKM,SAASH,iBAAT,CAA2BR,IAA3B,EAAiC;AACtC,MAAMuB,GAAG,GAAGC,WAAW,CAACxB,IAAD,CAAvB;AACA,SAAOyB,eAAe,CAACF,GAAD,CAAtB;AACD;;AAKM,SAASrB,MAAT,CAAgBF,IAAhB,EAAsB;AAC3B,SAAOA,IAAI,CAACoB,GAAL,KAAaM,SAApB;AACD;;AAKM,SAASF,WAAT,CAAqBxB,IAArB,EAA2B;AAChC,MAAM2B,SAAS,GAAGzB,MAAM,CAACF,IAAD,CAAN,GAAe,mBAAf,iBAA4CA,IAAI,CAACoB,GAAjD,CAAlB;AACA,MAAMG,GAAG,aAAMvB,IAAI,CAAC4B,IAAX,0BAA+BD,SAA/B,CAAT;AAEA,SAAOJ,GAAP;AACD;;AAKM,SAASE,eAAT,CAAyBF,GAAzB,EAA8B;AACnC,MAAMZ,MAAM,GAAG,IAAIf,YAAJ,CACb2B,GADa,EAEb,IAFa,EAGb,IAHa,EAIb,IAJa,EAKb,IALa,EAMb;AACEM,IAAAA,oBAAoB,EAAE,KAAK,IAAL,GAAY,IADpC;AAEEC,IAAAA,sBAAsB,EAAE,KAAK,IAAL,GAAY;AAFtC,GANa,CAAf;AAYA,SAAOnB,MAAP;AACD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* eslint-env node */\n/* eslint no-console: [\"error\", { allow: [\"log\"] }] */\n\nimport {XVIZMiddlewareStack} from './middleware';\nimport {WebSocketInterface} from './websocket';\nimport {TransformLogFlow, OnlyMetadata} from './core';\n\nconst W3CWebSocket = require('websocket').w3cwebsocket;\n\n/**\n * With the given arguments open an XVIZ data source and process with\n * the provided middleware stack.  Additional middleware is added to\n * facilitate processing as needed.\n */\nexport function openSource(args, middlewares) {\n  // Non-live sessions require sending a transform log message\n  if (!isLive(args)) {\n    middlewares.push(new TransformLogFlow(null, args));\n  }\n\n  // If we just want metadata we shutdown afterwards\n  if (args.metadata) {\n    middlewares.push(new OnlyMetadata(null));\n  }\n\n  // Assemble our message processors\n  const socket = webSocketFromArgs(args);\n  const stackedMiddleware = new XVIZMiddlewareStack(middlewares);\n\n  const client = new WebSocketInterface({middleware: stackedMiddleware, socket});\n\n  // Some middleware needs to be able to send messages/close connections\n  // so provide them access to the client.\n  for (let i = 0; i < middlewares.length; ++i) {\n    const middleware = middlewares[i];\n    if (middleware.client === null) {\n      middleware.client = client;\n    }\n  }\n\n  // Setup graceful shutdown\n  let sigintCount = 0;\n  process.on('SIGINT', () => {\n    if (sigintCount === 0) {\n      console.log('Closing');\n      socket.close();\n    } else {\n      // If the user or system is really mashing Ctrl-C, then abort\n      console.log('Aborting');\n      process.exit(1); // eslint-disable-line no-process-exit\n    }\n\n    sigintCount++;\n  });\n\n  return client;\n}\n\n/**\n * Take the standard data args and return a working websocket\n */\nexport function webSocketFromArgs(args) {\n  const url = urlFromArgs(args);\n  return createWebSocket(url);\n}\n\n/**\n * Arg we operating a live session or not\n */\nexport function isLive(args) {\n  return args.log === undefined;\n}\n\n/**\n * Based on the command data arguments create a standard XVIZ service URL\n */\nexport function urlFromArgs(args) {\n  const extraArgs = isLive(args) ? 'session_type=live' : `log=${args.log}`;\n  const url = `${args.host}?version=2.0&${extraArgs}`;\n\n  return url;\n}\n\n/**\n * Create a web socket properly configured for large XVIZ data flows\n */\nexport function createWebSocket(url) {\n  const client = new W3CWebSocket(\n    url,\n    null, // protocols\n    null, // origin\n    null, // headers\n    null, // requestOptions\n    {\n      maxReceivedFrameSize: 64 * 1024 * 1024, // 64MiB\n      maxReceivedMessageSize: 64 * 1024 * 1024 // 64MiB\n    }\n  );\n\n  return client;\n}\n"],"file":"connect.js"}