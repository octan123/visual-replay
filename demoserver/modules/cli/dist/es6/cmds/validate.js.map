{"version":3,"sources":["../../../src/cmds/validate.js"],"names":["openSource","addDataArgs","addMetadataArg","addCondensedArg","XVIZSessionValidator","default","indentString","Table","colors","validateArgs","inArgs","command","args","options","alias","describe","verbose","condensed","invalidCallback","t","e","m","printValidationError","validator","printed","printSummary","printErrorSummary","stats","reportValidation","onMetadata","msg","metadata","onTransformLogDone","onClose","stack","table","head","style","message","messages","count","errors","validationErrors","errPer","uniqueErrors","uniqueErrorCount","Object","keys","length","row","toFixed","coloredRow","forEach","push","red","bold","console","log","toString","msgType","err","displayType","msgStr","JSON","stringify","errStr","display","type","toLowerCase"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/* eslint no-console: [\"error\", { allow: [\"log\"] }] */\n/* eslint-env node, browser */\n\nimport {openSource} from '../connect';\nimport {addDataArgs, addMetadataArg, addCondensedArg} from '../commonargs';\nimport {XVIZSessionValidator} from '@xviz/schema';\n\nimport {default as indentString} from 'indent-string';\nimport {default as Table} from 'cli-table3';\nimport {default as colors} from 'colors';\n\nexport function validateArgs(inArgs) {\n  return inArgs.command(\n    'validate <host> [log]',\n    'Validate XVIZ data and message flow',\n    args => {\n      addDataArgs(args);\n      addMetadataArg(args, 'Just check the metadata');\n      addCondensedArg(args, 'Display summary information');\n\n      args.options('type', {\n        alias: 't',\n        describe: 'Just report on this type'\n      });\n    },\n    args => {\n      command(args);\n    }\n  );\n}\n\n/**\n * Validate the content and order of XVIZ messages\n */\nexport function command(args) {\n  // Validate the message flow\n  const options = {verbose: !args.condensed};\n\n  if (!args.condensed) {\n    options.invalidCallback = (t, e, m) => {\n      printValidationError(t, e, m, args);\n    };\n  }\n\n  const validator = new XVIZSessionValidator(options);\n\n  let printed = false;\n  const printSummary = () => {\n    if (!printed) {\n      printErrorSummary(validator.stats, args);\n      printed = true;\n    }\n  };\n\n  // Report validation as we go\n  const reportValidation = {\n    onMetadata: msg => {\n      if (args.metadata) {\n        printSummary();\n      }\n    },\n    onTransformLogDone: msg => {\n      printSummary();\n    },\n    onClose: () => {\n      printSummary();\n    }\n  };\n\n  // The middleware stack handle all messages\n  const stack = [validator, reportValidation];\n\n  // Everything async from here...\n  openSource(args, stack);\n}\n\nfunction printErrorSummary(stats, args) {\n  // Form a table of the main errors one row per type\n  const table = new Table({\n    head: ['Type', 'Count', 'Invalid', 'Inv %', 'Unique Errors'],\n    style: {head: ['white', 'bold']}\n  });\n\n  for (const message in stats.messages) {\n    const count = stats.messages[message] || 0;\n    const errors = stats.validationErrors[message] || 0;\n    const errPer = (errors / count) * 100;\n\n    const uniqueErrors = stats.uniqueErrors[message];\n    const uniqueErrorCount = uniqueErrors ? Object.keys(uniqueErrors).length : 0;\n\n    const row = [message, count, errors, errPer.toFixed(1), uniqueErrorCount];\n\n    if (errors) {\n      const coloredRow = [];\n      row.forEach(e => {\n        coloredRow.push(colors.red.bold(e));\n      });\n      table.push(coloredRow);\n    } else {\n      table.push(row);\n    }\n  }\n\n  // console.log(stats);\n  console.log(table.toString());\n}\n\n// Print details about a validation error\nfunction printValidationError(msgType, err, msg, args) {\n  if (msg && displayType(msgType, args)) {\n    // TODO(jlisee): look into ajv-errors package to simplify this output\n    const msgStr = indentString(JSON.stringify(msg, null, 4), 4);\n    const errStr = indentString(err.toString(), 4);\n    console.log(`VALIDATION ERROR:\\n  TYPE: ${msgType}\\n  DETAILS:\\n${errStr}\\n  MSG:\\n${msgStr}`);\n  }\n}\n\n// Return true if we should display information about this message type\nfunction displayType(msgType, args) {\n  let display = true;\n  if (args.type && args.type.toLowerCase() !== msgType.toLowerCase()) {\n    display = false;\n  }\n\n  return display;\n}\n"],"file":"validate.js"}