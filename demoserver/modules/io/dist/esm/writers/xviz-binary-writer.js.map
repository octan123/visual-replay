{"version":3,"sources":["../../../src/writers/xviz-binary-writer.js"],"names":["XVIZBaseWriter","GLTFBuilder","packBinaryJson","XVIZEnvelope","XVIZ_GLTF_EXTENSION","toBuffer","binaryData","ArrayBuffer","isView","buffer","Buffer","byteLength","view","Uint8Array","i","length","Error","messageName","index","encodeBinaryXVIZ","xvizJson","options","gltfBuilder","packedData","useAVSXVIZExtension","addExtension","nopack","addApplicationData","encodeAsGLB","XVIZBinaryWriter","sink","envelope","flattenArrays","DracoWriter","DracoLoader","messageTimings","messages","Map","wroteMessageIndex","encodingOptions","xvizMetadata","_checkValid","_saveTimestamp","Metadata","glbFileBuffer","writeSync","flag","messageIndex","xvizMessage","StateUpdate","startTime","endTime","messageTimes","Array","from","keys","sort","a","b","timing","forEach","value","limit","push","get","JSON","stringify","_writeMessageIndex","xviz_data","log_info","updates","undefined","start_time","end_time","every","update","timestamp","min","Math","map","max","set"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {XVIZBaseWriter} from './xviz-base-writer';\nimport {GLTFBuilder} from '../gltf/gltf-builder';\nimport {packBinaryJson} from './xviz-pack-binary';\nimport {XVIZEnvelope, XVIZ_GLTF_EXTENSION} from '@xviz/io';\n\n// Convert (copy) ArrayBuffer to Buffer\n// This is from @loaders.gl/core/src/node/utils/to-buffer.node.js\n// but the function is no longer exported\nfunction toBuffer(binaryData) {\n  if (ArrayBuffer.isView(binaryData)) {\n    binaryData = binaryData.buffer;\n  }\n\n  if (typeof Buffer !== 'undefined' && binaryData instanceof ArrayBuffer) {\n    /* global Buffer */\n    const buffer = new Buffer(binaryData.byteLength);\n    const view = new Uint8Array(binaryData);\n    for (let i = 0; i < buffer.length; ++i) {\n      buffer[i] = view[i];\n    }\n    return buffer;\n  }\n\n  throw new Error('Failed to convert to buffer');\n}\n\n// 0-frame is an index file for timestamp metadata\n// 1-frame is the metadata file for the log\n// 2-frame is where the actual XVIZ updates begin\nconst messageName = index => `${index + 2}-frame`;\n\nexport function encodeBinaryXVIZ(xvizJson, options) {\n  const gltfBuilder = new GLTFBuilder(options);\n\n  // Pack appropriate large data elements (point clouds and images) in binary\n  const packedData = packBinaryJson(xvizJson, gltfBuilder, null, options);\n\n  // As permitted by glTF, we put all XVIZ data in a top-level subfield.\n  const {useAVSXVIZExtension} = options;\n  if (useAVSXVIZExtension === true) {\n    gltfBuilder.addExtension(XVIZ_GLTF_EXTENSION, packedData, {nopack: true});\n  } else {\n    gltfBuilder.addApplicationData('xviz', packedData, {nopack: true});\n  }\n\n  return gltfBuilder.encodeAsGLB(options);\n}\n\nexport class XVIZBinaryWriter extends XVIZBaseWriter {\n  constructor(sink, options = {}) {\n    super(sink);\n\n    const {envelope = true, flattenArrays = true, DracoWriter, DracoLoader} = options;\n    this.messageTimings = {\n      messages: new Map()\n    };\n    this.wroteMessageIndex = null;\n    this.options = {envelope, flattenArrays, DracoWriter, DracoLoader};\n\n    this.encodingOptions = {\n      flattenArrays: this.options.flattenArrays\n    };\n\n    if (this.options.DracoWriter) {\n      this.encodingOptions.DracoWriter = DracoWriter;\n    }\n\n    if (this.options.DracoLoader) {\n      this.encodingOptions.DracoLoader = DracoLoader;\n    }\n  }\n\n  // xvizMetadata is the object returned\n  // from a Builder.\n  writeMetadata(xvizMetadata) {\n    this._checkValid();\n    this._saveTimestamp(xvizMetadata);\n\n    if (this.options.envelope) {\n      xvizMetadata = XVIZEnvelope.Metadata(xvizMetadata);\n    }\n\n    const glbFileBuffer = encodeBinaryXVIZ(xvizMetadata, this.encodingOptions);\n    this.sink.writeSync(`1-frame.glb`, toBuffer(glbFileBuffer), {flag: 'w'});\n  }\n\n  writeMessage(messageIndex, xvizMessage) {\n    this._checkValid();\n    this._saveTimestamp(xvizMessage, messageIndex);\n\n    if (this.options.envelope) {\n      xvizMessage = XVIZEnvelope.StateUpdate(xvizMessage);\n    }\n\n    const glbFileBuffer = encodeBinaryXVIZ(xvizMessage, this.encodingOptions);\n    this.sink.writeSync(`${messageName(messageIndex)}.glb`, toBuffer(glbFileBuffer), {flag: 'w'});\n  }\n\n  _writeMessageIndex() {\n    this._checkValid();\n    const {startTime, endTime, messages} = this.messageTimings;\n    const messageTimings = {};\n\n    if (startTime) {\n      messageTimings.startTime = startTime;\n    }\n\n    if (endTime) {\n      messageTimings.endTime = endTime;\n    }\n\n    // Sort messages by index before writing out as an array\n    const messageTimes = Array.from(messages.keys()).sort((a, b) => a - b);\n\n    const timing = [];\n    messageTimes.forEach((value, index) => {\n      // Value is two greater than message index\n      const limit = timing.length;\n      if (value > limit) {\n        // Adding 2 because 1-frame is metadata file, so message data starts at 2\n        throw new Error(\n          `Error writing time index file. Messages are missing between ${limit + 2} and ${value +\n            2}`\n        );\n      }\n\n      timing.push(messages.get(value));\n    });\n    messageTimings.timing = timing;\n\n    this.sink.writeSync('0-frame.json', JSON.stringify(messageTimings));\n    this.wroteMessageIndex = timing.length;\n  }\n\n  close() {\n    if (this.sink) {\n      if (!this.wroteMessageIndex) {\n        this._writeMessageIndex();\n      }\n\n      super.close();\n    }\n  }\n\n  /* eslint-disable camelcase */\n  _saveTimestamp(xviz_data, index) {\n    const {log_info, updates} = xviz_data;\n\n    if (index === undefined) {\n      // Metadata case\n      if (log_info) {\n        const {start_time, end_time} = log_info || {};\n        if (start_time) {\n          this.messageTimings.startTime = start_time;\n        }\n\n        if (end_time) {\n          this.messageTimings.endTime = end_time;\n        }\n      }\n    } else if (updates) {\n      if (updates.length === 0 || !updates.every(update => typeof update.timestamp === 'number')) {\n        throw new Error('XVIZ updates did not contain a valid timestamp');\n      }\n\n      const min = Math.min(updates.map(update => update.timestamp));\n      const max = Math.max(updates.map(update => update.timestamp));\n\n      this.messageTimings.messages.set(index, [min, max, index, messageName(index)]);\n    } else {\n      // Missing updates & index is invalid call\n      throw new Error('Cannot find timestamp');\n    }\n  }\n  /* eslint-enable camelcase */\n}\n"],"file":"xviz-binary-writer.js"}