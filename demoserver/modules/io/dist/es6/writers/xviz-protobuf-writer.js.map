{"version":3,"sources":["../../../src/writers/xviz-protobuf-writer.js"],"names":["XVIZBaseWriter","XVIZ_PROTOBUF_MAGIC","XVIZ_PROTOBUF_MESSAGE","messageName","index","XVIZProtobufWriter","constructor","sink","options","envelope","messageTimings","messages","Map","wroteMessageIndex","writeMetadata","xvizMetadata","_checkValid","_saveTimestamp","pbJSON","xvizConvertProtobuf","pbInfo","type","Metadata","msg","fromObject","_applyEnvelope","pbBuffer","encode","finish","buffer","Uint8Array","byteLength","set","writeToSink","writeMessage","messageIndex","xvizMessage","StateUpdate","info","value","Envelope","data","type_url","_writeMessageIndex","startTime","endTime","messageTimes","Array","from","keys","sort","a","b","timing","forEach","limit","length","Error","push","get","JSON","stringify","close","xviz_data","log_info","updates","undefined","start_time","end_time","every","update","timestamp","min","Math","map","max","name","writeSync","COLOR_KEYS","toColorArray","object","clrs","substring","len","color","step","i","parseInt","substr","keyName","isArray","element","flat","el","ArrayBuffer","isView","Number","isFinite","includes","match","properties","Object","newObject","objectKeys","key"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* eslint-disable */\nimport {XVIZBaseWriter} from './xviz-base-writer';\nimport {XVIZ_PROTOBUF_MAGIC, XVIZ_PROTOBUF_MESSAGE} from '../common/protobuf-support';\n\n// 0-frame is an index file for timestamp metadata\n// 1-frame is the metadata file for the log\n// 2-frame is where the actual XVIZ updates begin\nconst messageName = index => `${index + 2}-frame`;\n\nexport class XVIZProtobufWriter extends XVIZBaseWriter {\n  constructor(sink, options = {}) {\n    super(sink);\n\n    const {envelope = true} = options;\n    this.messageTimings = {\n      messages: new Map()\n    };\n    this.wroteMessageIndex = null;\n    this.options = {envelope};\n  }\n\n  // xvizMetadata is the object returned\n  // from a Builder.\n  writeMetadata(xvizMetadata) {\n    this._checkValid();\n    this._saveTimestamp(xvizMetadata);\n\n    const pbJSON = xvizConvertProtobuf(xvizMetadata);\n    let pbInfo = {\n      type: XVIZ_PROTOBUF_MESSAGE.Metadata,\n      msg: XVIZ_PROTOBUF_MESSAGE.Metadata.fromObject(pbJSON)\n    };\n\n    if (this.options.envelope) {\n      this._applyEnvelope(pbInfo);\n    }\n\n    const pbBuffer = pbInfo.type.encode(pbInfo.msg).finish();\n    const buffer = new Uint8Array(pbBuffer.byteLength + 4);\n    buffer.set(XVIZ_PROTOBUF_MAGIC, 0);\n    buffer.set(pbBuffer, 4);\n    this.writeToSink('1-frame.pbe', buffer);\n  }\n\n  writeMessage(messageIndex, xvizMessage) {\n    this._checkValid();\n    this._saveTimestamp(xvizMessage, messageIndex);\n\n    const pbJSON = xvizConvertProtobuf(xvizMessage);\n    let pbInfo = {\n      type: XVIZ_PROTOBUF_MESSAGE.StateUpdate,\n      msg: XVIZ_PROTOBUF_MESSAGE.StateUpdate.fromObject(pbJSON)\n    };\n\n    if (this.options.envelope) {\n      this._applyEnvelope(pbInfo);\n    }\n\n    const pbBuffer = pbInfo.type.encode(pbInfo.msg).finish();\n    const buffer = new Uint8Array(pbBuffer.byteLength + 4);\n    buffer.set(XVIZ_PROTOBUF_MAGIC, 0);\n    buffer.set(pbBuffer, 4);\n    this.writeToSink(`${messageName(messageIndex)}.pbe`, buffer);\n  }\n\n  // Apply protobuf structure for the Any type used in the envelope\n  _applyEnvelope(info) {\n    if (info.type === XVIZ_PROTOBUF_MESSAGE.Metadata) {\n      const value = info.type.encode(info.msg).finish();\n      info.type = XVIZ_PROTOBUF_MESSAGE.Envelope;\n      info.msg = info.type.fromObject({\n        type: 'xviz/metadata',\n        data: {type_url: 'xviz.v2.Metadata', value}\n      });\n    } else if (info.type === XVIZ_PROTOBUF_MESSAGE.StateUpdate) {\n      const value = info.type.encode(info.msg).finish();\n      info.type = XVIZ_PROTOBUF_MESSAGE.Envelope;\n      info.msg = info.type.fromObject({\n        type: 'xviz/state_update',\n        data: {type_url: 'xviz.v2.StateUpdate', value}\n      });\n    }\n  }\n\n  _writeMessageIndex() {\n    this._checkValid();\n    const {startTime, endTime, messages} = this.messageTimings;\n    const messageTimings = {};\n\n    if (startTime) {\n      messageTimings.startTime = startTime;\n    }\n\n    if (endTime) {\n      messageTimings.endTime = endTime;\n    }\n\n    // Sort messages by index before writing out as an array\n    const messageTimes = Array.from(messages.keys()).sort((a, b) => a - b);\n\n    const timing = [];\n    messageTimes.forEach((value, index) => {\n      // Value is two greater than message index\n      const limit = timing.length;\n      if (value > limit) {\n        // Adding 2 because 1-frame is metadata file, so message data starts at 2\n        throw new Error(\n          `Error writing time index file. Messages are missing between ${limit + 2} and ${value +\n            2}`\n        );\n      }\n\n      timing.push(messages.get(value));\n    });\n    messageTimings.timing = timing;\n\n    const msg = JSON.stringify(messageTimings);\n    this.writeToSink('0-frame.json', msg);\n    this.wroteMessageIndex = timing.length;\n  }\n\n  close() {\n    if (this.sink) {\n      if (!this.wroteMessageIndex) {\n        this._writeMessageIndex();\n      }\n\n      super.close();\n    }\n  }\n\n  /* eslint-disable camelcase */\n  _saveTimestamp(xviz_data, index) {\n    const {log_info, updates} = xviz_data;\n\n    if (index === undefined) {\n      // Metadata case\n      if (log_info) {\n        const {start_time, end_time} = log_info || {};\n        if (start_time) {\n          this.messageTimings.startTime = start_time;\n        }\n\n        if (end_time) {\n          this.messageTimings.endTime = end_time;\n        }\n      }\n    } else if (updates) {\n      if (updates.length === 0 || !updates.every(update => typeof update.timestamp === 'number')) {\n        throw new Error('XVIZ updates did not contain a valid timestamp');\n      }\n\n      const min = Math.min(updates.map(update => update.timestamp));\n      const max = Math.max(updates.map(update => update.timestamp));\n\n      this.messageTimings.messages.set(index, [min, max, index, messageName(index)]);\n    } else {\n      // Missing updates & index is invalid call\n      throw new Error('Cannot find timestamp');\n    }\n  }\n  /* eslint-enable camelcase */\n\n  writeToSink(name, msg) {\n    this.sink.writeSync(name, msg);\n  }\n}\n\nconst COLOR_KEYS = ['stroke_color', 'fill_color'];\n/* Convert color to a flattened array */\nfunction toColorArray(object) {\n  const clrs = object.substring(1);\n  const len = clrs.length;\n  if (!(len === 3 || len === 4 || len === 6 || len === 8)) {\n    return null;\n  }\n\n  const color = [];\n  const step = clrs.length === 3 || clrs.length === 4 ? 1 : 2;\n  for (let i = 0; i < clrs.length; i += step) {\n    color.push(parseInt(clrs.substr(i, step), 16));\n  }\n\n  return color;\n}\n\n// Protobuf messages do not allow variations on the field types, such\n// as a color field that supports both 'string' and 'array' data in JSON.\n//\n// This function will normalize the object, generally produced by an XVIZBuilder,\n// to allow it to be encoded per our protobuf message definitions. It will change\n// the variation of particular fields into a normalized format.\n//\n// Recursively walk object performing the following conversions\n// - primitives with typed array fields are turned into arrays\n// - primtives of type image have the data turned into a base64 string\n/* eslint-disable complexity, no-else-return, max-statements */\nexport function xvizConvertProtobuf(object, keyName) {\n  if (Array.isArray(object)) {\n    if (!(keyName === 'vertices' || keyName === 'points' || keyName === 'colors')) {\n      return object.map(element => xvizConvertProtobuf(element, keyName));\n    }\n\n    // Handle the following cases\n    // [ [x, y, z], [x, y, z], ...]\n    // [ TypedArray{x, y, z}, TypedArray{x, y ,z} ]\n    // [ x, y, z, x, y, z, ... ]\n    // [ {}, {}, ... ]\n    if (Array.isArray(object[0])) {\n      const flat = [];\n      object.forEach(el => flat.push(...el));\n      return flat;\n    } else if (ArrayBuffer.isView(object[0])) {\n      const flat = [];\n      object.forEach(el => flat.push(...Array.from(el)));\n      return flat;\n    } else if (Number.isFinite(object[0])) {\n      return object;\n    } else if (typeof object[0] === 'object') {\n      return object.map(element => xvizConvertProtobuf(element, keyName));\n    }\n  }\n\n  // Typed arrays become normal arrays\n  if (ArrayBuffer.isView(object)) {\n    return Array.from(object);\n  }\n\n  if (COLOR_KEYS.includes(keyName)) {\n    if (typeof object === 'string' && object.match(/^#([0-9a-f]{3,4})|([0-9a-f]{6,8})$/i)) {\n      return toColorArray(object);\n    }\n  }\n\n  if (object !== null && typeof object === 'object') {\n    // Handle XVIZ Image Primitive\n    const properties = Object.keys(object);\n    if (properties.includes('data') && keyName === 'images') {\n      // TODO: should verify it is a typed array and if not convert it to one\n      return object;\n    }\n\n    // Handle all other objects\n    const newObject = {};\n    const objectKeys = Object.keys(object);\n    for (const key of objectKeys) {\n      // console.log(key)\n      newObject[key] = xvizConvertProtobuf(object[key], key);\n    }\n    return newObject;\n  }\n\n  return object;\n}\n/* eslint-enable complexity */\n"],"file":"xviz-protobuf-writer.js"}