{"version":3,"sources":["../../../src/server/xviz-provider-handler.js"],"names":["default","path","XVIZProviderSession","FileSource","XVIZProviderHandler","factory","options","sessionCount","socket","req","provider","dirs","Array","isArray","d","i","length","root","join","source","open","params","logger","id"],"mappings":";;;;;;;;;;AAaA,SAAQA,OAAO,IAAIC,IAAnB,QAA8B,MAA9B;AAEA,SAAQC,mBAAR,QAAkC,yBAAlC;AACA,SAAQC,UAAR,QAAyB,eAAzB;AAGA,WAAaC,mBAAb;AACE,+BAAYC,OAAZ,EAAqBC,OAArB,EAA8B;AAAA;;AAC5B,SAAKD,OAAL,GAAeA,OAAf;AACA,SAAKC,OAAL,GAAeA,OAAf;AAEA,SAAKC,YAAL,GAAoB,CAApB;AACD;;AANH;AAAA;AAAA;AAAA,oFAQmBC,MARnB,EAQ2BC,GAR3B;AAAA;AAAA;AAAA;AAAA;AAAA;AASQC,gBAAAA,QATR,GASmB,IATnB;AAWUC,gBAAAA,IAXV,GAWiBC,KAAK,CAACC,OAAN,CAAc,KAAKP,OAAL,CAAaQ,CAA3B,IAAgC,KAAKR,OAAL,CAAaQ,CAA7C,GAAiD,CAAC,KAAKR,OAAL,CAAaQ,CAAd,CAXlE;AAYaC,gBAAAA,CAZb,GAYiB,CAZjB;;AAAA;AAAA,sBAYoBA,CAAC,GAAGJ,IAAI,CAACK,MAZ7B;AAAA;AAAA;AAAA;;AAcYC,gBAAAA,IAdZ,GAcmBhB,IAAI,CAACiB,IAAL,CAAUP,IAAI,CAACI,CAAD,CAAd,EAAmBN,GAAG,CAACR,IAAvB,CAdnB;AAiBYkB,gBAAAA,MAjBZ,GAiBqB,IAAIhB,UAAJ,CAAec,IAAf,CAjBrB;AAAA;AAAA,uBAmBuB,KAAKZ,OAAL,CAAae,IAAb,CAAkB;AACjCD,kBAAAA,MAAM,EAANA,MADiC;AAEjCb,kBAAAA,OAAO,kCAAMG,GAAG,CAACY,MAAV;AAAkBC,oBAAAA,MAAM,EAAE,KAAKhB,OAAL,CAAagB;AAAvC,oBAF0B;AAGjCL,kBAAAA,IAAI,EAAJA;AAHiC,iBAAlB,CAnBvB;;AAAA;AAmBMP,gBAAAA,QAnBN;;AAAA,qBAyBUA,QAzBV;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAYqCK,gBAAAA,CAAC,EAZtC;AAAA;AAAA;;AAAA;AAAA,qBA8BQL,QA9BR;AAAA;AAAA;AAAA;;AAAA,iDA+Ba,IAAIR,mBAAJ,CAAwBM,MAAxB,EAAgCC,GAAhC,EAAqCC,QAArC,kCACF,KAAKJ,OADH;AAELiB,kBAAAA,EAAE,EAAE,KAAKhB,YAAL;AAFC,mBA/Bb;;AAAA;AAAA,iDAqCW,IArCX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport {default as path} from 'path';\n\nimport {XVIZProviderSession} from './xviz-provider-session';\nimport {FileSource} from '@xviz/io/node';\n\n// Setup the source and return an XVIZSession or null\nexport class XVIZProviderHandler {\n  constructor(factory, options) {\n    this.factory = factory;\n    this.options = options;\n\n    this.sessionCount = 0;\n  }\n\n  async newSession(socket, req) {\n    let provider = null;\n\n    const dirs = Array.isArray(this.options.d) ? this.options.d : [this.options.d];\n    for (let i = 0; i < dirs.length; i++) {\n      // Root is used by some XVIZ providers\n      const root = path.join(dirs[i], req.path);\n\n      // FileSource is used for a JSON/BINARY providers\n      const source = new FileSource(root);\n      // TODO: reconsile cli options with request options\n      provider = await this.factory.open({\n        source,\n        options: {...req.params, logger: this.options.logger},\n        root\n      });\n\n      if (provider) {\n        break;\n      }\n    }\n\n    if (provider) {\n      return new XVIZProviderSession(socket, req, provider, {\n        ...this.options,\n        id: this.sessionCount++\n      });\n    }\n\n    return null;\n  }\n}\n"],"file":"xviz-provider-handler.js"}