{"version":3,"sources":["../../../src/server/xviz-provider-session.js"],"names":["XVIZProviderRequestHandler","XVIZWebsocketSender","XVIZMessageToMiddleware","XVIZServerMiddlewareStack","XVIZSessionContext","XVIZProviderSession","socket","request","provider","options","middleware","context","id","set","_setupSocket","_setupMiddleware","handler","msg","logger","log","args","info","onerror","err","_onSocketError","onclose","event","_onSocketClose","onopen","_onSocketOpen","onmessage","message","_onSocketMessage","stack","error","toString","code","reason","onMessage","JSON","stringify","slice","params","callMiddleware","session_type"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {XVIZProviderRequestHandler} from '../middlewares/xviz-provider-request-handler';\nimport {XVIZWebsocketSender} from '../middlewares/xviz-websocket-sender';\nimport {XVIZMessageToMiddleware} from '../middlewares/xviz-message-to-middleware';\n\nimport {XVIZServerMiddlewareStack} from '../middlewares/xviz-server-middleware-stack';\nimport {XVIZSessionContext} from '../middlewares/xviz-session-context';\n\n// XVIZProviderSession handles the socket and dispatching to the middleware\n//\n// anyone else can add their own session\n// - Would someone want to \"mix\" sessions?\n// - if so they just create a wrapper that if XVIZ session is happy\n//   they can attach to it and proxy as necessary\n// - say they want to handle xvIZ data, but then want to mutate or\n//   add data (custom) for messages, they could try to handle first,\n//   else send to XVIZ\nexport class XVIZProviderSession {\n  constructor(socket, request, provider, options) {\n    this.socket = socket;\n    this.request = request;\n    this.provider = provider;\n    this.options = options;\n    this.middleware = null;\n\n    // session shared storage for the middlewares\n    this.context = new XVIZSessionContext();\n    if (options.id) {\n      this.context.set('id', options.id);\n    }\n\n    this._setupSocket();\n    this._setupMiddleware();\n\n    this.handler = new XVIZMessageToMiddleware(this.middleware);\n  }\n\n  log(msg, ...args) {\n    const {logger} = this.options;\n    if (logger && logger.log) {\n      logger.log(`${msg}`, ...args);\n    }\n  }\n\n  info(...msg) {\n    const {logger} = this.options;\n    if (logger && logger.info) {\n      logger.info(...msg);\n    }\n  }\n\n  _setupSocket() {\n    this.socket.onerror = err => {\n      this._onSocketError(err);\n    };\n\n    this.socket.onclose = event => {\n      this._onSocketClose(event);\n    };\n\n    this.socket.onopen = () => {\n      this._onSocketOpen();\n    };\n\n    this.socket.onmessage = message => {\n      this._onSocketMessage(message);\n    };\n  }\n\n  _setupMiddleware() {\n    this.middleware = new XVIZServerMiddlewareStack();\n\n    const stack = [\n      new XVIZProviderRequestHandler(this.context, this.provider, this.middleware, this.options),\n      new XVIZWebsocketSender(this.context, this.socket, this.options)\n    ];\n    this.middleware.set(stack);\n  }\n\n  _onSocketOpen() {\n    this.log('[> Socket] Open');\n  }\n\n  _onSocketError(error) {\n    this.log('[> Socket] Error: ', error.toString());\n  }\n\n  _onSocketClose(event) {\n    this.log(`[> Socket] Close: Code ${event.code} Reason: ${event.reason}`);\n  }\n\n  _onSocketMessage(message) {\n    if (!this.handler.onMessage(message)) {\n      this.log('[> Socket] Unknown message: ', JSON.stringify(message, null, 2).slice(0, 100));\n    }\n  }\n\n  onConnect() {\n    this.log('[> Connection] made');\n\n    const params = this.request.params;\n    // Providers have already decided via the URL Path\n    // that this is a valid source, so we can\n    // treat connection as 'start' and send metadata\n    this.handler.callMiddleware('start', params);\n\n    if (params.session_type === 'live') {\n      // If 'live' we start sending data immediately\n      this.handler.callMiddleware('transform_log', {id: 'live', ...params});\n    }\n  }\n}\n"],"file":"xviz-provider-session.js"}