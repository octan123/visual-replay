{"version":3,"sources":["../../../src/server/xviz-provider-handler.js"],"names":["default","path","XVIZProviderSession","FileSource","XVIZProviderHandler","constructor","factory","options","sessionCount","newSession","socket","req","provider","dirs","Array","isArray","d","i","length","root","join","source","open","params","logger","id"],"mappings":";;;;;;AAaA,SAAQA,OAAO,IAAIC,IAAnB,QAA8B,MAA9B;AAEA,SAAQC,mBAAR,QAAkC,yBAAlC;AACA,SAAQC,UAAR,QAAyB,eAAzB;AAGA,OAAO,MAAMC,mBAAN,CAA0B;AAC/BC,EAAAA,WAAW,CAACC,OAAD,EAAUC,OAAV,EAAmB;AAC5B,SAAKD,OAAL,GAAeA,OAAf;AACA,SAAKC,OAAL,GAAeA,OAAf;AAEA,SAAKC,YAAL,GAAoB,CAApB;AACD;;AAED,QAAMC,UAAN,CAAiBC,MAAjB,EAAyBC,GAAzB,EAA8B;AAC5B,QAAIC,QAAQ,GAAG,IAAf;AAEA,UAAMC,IAAI,GAAGC,KAAK,CAACC,OAAN,CAAc,KAAKR,OAAL,CAAaS,CAA3B,IAAgC,KAAKT,OAAL,CAAaS,CAA7C,GAAiD,CAAC,KAAKT,OAAL,CAAaS,CAAd,CAA9D;;AACA,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,IAAI,CAACK,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;AAEpC,YAAME,IAAI,GAAGlB,IAAI,CAACmB,IAAL,CAAUP,IAAI,CAACI,CAAD,CAAd,EAAmBN,GAAG,CAACV,IAAvB,CAAb;AAGA,YAAMoB,MAAM,GAAG,IAAIlB,UAAJ,CAAegB,IAAf,CAAf;AAEAP,MAAAA,QAAQ,GAAG,MAAM,KAAKN,OAAL,CAAagB,IAAb,CAAkB;AACjCD,QAAAA,MADiC;AAEjCd,QAAAA,OAAO,kCAAMI,GAAG,CAACY,MAAV;AAAkBC,UAAAA,MAAM,EAAE,KAAKjB,OAAL,CAAaiB;AAAvC,UAF0B;AAGjCL,QAAAA;AAHiC,OAAlB,CAAjB;;AAMA,UAAIP,QAAJ,EAAc;AACZ;AACD;AACF;;AAED,QAAIA,QAAJ,EAAc;AACZ,aAAO,IAAIV,mBAAJ,CAAwBQ,MAAxB,EAAgCC,GAAhC,EAAqCC,QAArC,kCACF,KAAKL,OADH;AAELkB,QAAAA,EAAE,EAAE,KAAKjB,YAAL;AAFC,SAAP;AAID;;AAED,WAAO,IAAP;AACD;;AAtC8B","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport {default as path} from 'path';\n\nimport {XVIZProviderSession} from './xviz-provider-session';\nimport {FileSource} from '@xviz/io/node';\n\n// Setup the source and return an XVIZSession or null\nexport class XVIZProviderHandler {\n  constructor(factory, options) {\n    this.factory = factory;\n    this.options = options;\n\n    this.sessionCount = 0;\n  }\n\n  async newSession(socket, req) {\n    let provider = null;\n\n    const dirs = Array.isArray(this.options.d) ? this.options.d : [this.options.d];\n    for (let i = 0; i < dirs.length; i++) {\n      // Root is used by some XVIZ providers\n      const root = path.join(dirs[i], req.path);\n\n      // FileSource is used for a JSON/BINARY providers\n      const source = new FileSource(root);\n      // TODO: reconsile cli options with request options\n      provider = await this.factory.open({\n        source,\n        options: {...req.params, logger: this.options.logger},\n        root\n      });\n\n      if (provider) {\n        break;\n      }\n    }\n\n    if (provider) {\n      return new XVIZProviderSession(socket, req, provider, {\n        ...this.options,\n        id: this.sessionCount++\n      });\n    }\n\n    return null;\n  }\n}\n"],"file":"xviz-provider-handler.js"}