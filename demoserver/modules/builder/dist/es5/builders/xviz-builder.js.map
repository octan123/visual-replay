{"version":3,"sources":["../../../src/builders/xviz-builder.js"],"names":["defaultValidateWarn","console","warn","defaultValidateError","error","XVIZBuilder","metadata","disableStreams","validateWarn","validateError","_validator","XVIZValidator","updateType","_streamBuilder","_poseBuilder","XVIZPoseBuilder","validator","_variablesBuilder","XVIZVariableBuilder","_primitivesBuilder","XVIZPrimitiveBuilder","_futureInstanceBuilder","XVIZFutureInstanceBuilder","_uiPrimitivesBuilder","XVIZUIPrimitiveBuilder","_timeSeriesBuilder","XVIZTimeSeriesBuilder","_linkBuilder","XVIZLinkBuilder","streamId","PRIMARY_POSE_STREAM","stream","parent","child","timestamp","_timestamp","getData","poses","primitives","futures","variables","timeSeries","uiPrimitives","links","data","future_instances","time_series","ui_primitives","message","update_type","updates","getMessage"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Note: XVIZ data structures use snake_case\n/* eslint-disable camelcase */\nimport XVIZPoseBuilder from './xviz-pose-builder';\nimport XVIZLinkBuilder from './xviz-link-builder';\nimport XVIZPrimitiveBuilder from './xviz-primitive-builder';\nimport XVIZFutureInstanceBuilder from './xviz-future-instance-builder';\nimport XVIZUIPrimitiveBuilder from './xviz-ui-primitive-builder';\nimport XVIZTimeSeriesBuilder from './xviz-time-series-builder';\nimport XVIZValidator from './xviz-validator';\nimport XVIZVariableBuilder from './xviz-variable-builder';\nimport {PRIMARY_POSE_STREAM} from './constant';\n\n/* global console */\n/* eslint-disable no-console */\nconst defaultValidateWarn = console.warn;\nconst defaultValidateError = console.error;\n/* eslint-enable no-console */\n\n// TODO: Builder could validate against stream metadata!\nexport default class XVIZBuilder {\n  constructor({\n    metadata = {},\n    disableStreams = [],\n    validateWarn = defaultValidateWarn,\n    validateError = defaultValidateError\n  } = {}) {\n    this._validator = new XVIZValidator({\n      validateWarn,\n      validateError\n    });\n\n    this.metadata = metadata;\n    this.disableStreams = disableStreams;\n\n    this.updateType = 'SNAPSHOT';\n\n    // Current streamBuilder\n    this._streamBuilder = null;\n\n    // Construct different builders\n    this._poseBuilder = new XVIZPoseBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._variablesBuilder = new XVIZVariableBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._primitivesBuilder = new XVIZPrimitiveBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._futureInstanceBuilder = new XVIZFutureInstanceBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._uiPrimitivesBuilder = new XVIZUIPrimitiveBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._timeSeriesBuilder = new XVIZTimeSeriesBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n    this._linkBuilder = new XVIZLinkBuilder({\n      metadata: this.metadata,\n      validator: this._validator\n    });\n  }\n\n  persistent() {\n    this.updateType = 'PERSISTENT';\n  }\n\n  pose(streamId = PRIMARY_POSE_STREAM) {\n    this._streamBuilder = this._poseBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  link(parent, child) {\n    this._streamBuilder = this._linkBuilder.stream(child).parent(parent);\n    return this._streamBuilder;\n  }\n\n  variable(streamId) {\n    this._streamBuilder = this._variablesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  primitive(streamId) {\n    this._streamBuilder = this._primitivesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  futureInstance(streamId, timestamp) {\n    this._streamBuilder = this._futureInstanceBuilder.stream(streamId);\n    this._streamBuilder._timestamp(timestamp);\n    return this._streamBuilder;\n  }\n\n  uiPrimitive(streamId) {\n    this._streamBuilder = this._uiPrimitivesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  timeSeries(streamId) {\n    this._streamBuilder = this._timeSeriesBuilder.stream(streamId);\n    return this._streamBuilder;\n  }\n\n  /*\n  message data:\n  {\n    update_type: 'SNAPSHOT',\n    updates: [{\n      timestamp,\n      poses: {'/vehicle-pose': {}, ...},\n      primitives: {},\n      variables: {},\n      future_instances: {}\n    }]\n  }\n   */\n  getMessage() {\n    const {poses} = this._poseBuilder.getData();\n\n    if (!poses || !poses[PRIMARY_POSE_STREAM]) {\n      this._validator.error(`Every message requires a ${PRIMARY_POSE_STREAM} stream`);\n    }\n\n    const primitives = this._primitivesBuilder.getData();\n    const futures = this._futureInstanceBuilder.getData();\n    const variables = this._variablesBuilder.getData();\n    const timeSeries = this._timeSeriesBuilder.getData();\n    const uiPrimitives = this._uiPrimitivesBuilder.getData();\n    const links = this._linkBuilder.getData();\n\n    const data = {\n      timestamp: poses[PRIMARY_POSE_STREAM].timestamp,\n      poses\n    };\n\n    if (primitives) {\n      data.primitives = primitives;\n    }\n    if (futures) {\n      data.future_instances = futures;\n    }\n    if (variables) {\n      data.variables = variables;\n    }\n    if (timeSeries) {\n      data.time_series = timeSeries;\n    }\n    if (uiPrimitives) {\n      data.ui_primitives = uiPrimitives;\n    }\n    if (links) {\n      data.links = links;\n    }\n\n    const message = {\n      update_type: this.updateType,\n      updates: [data]\n    };\n\n    return message;\n  }\n\n  // DEPRECATED: change to using getMessage()\n  getFrame() {\n    return this.getMessage();\n  }\n\n  _reset() {\n    this._streamBuilder = null;\n  }\n}\n"],"file":"xviz-builder.js"}