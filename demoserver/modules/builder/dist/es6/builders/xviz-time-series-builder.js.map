{"version":3,"sources":["../../../src/builders/xviz-time-series-builder.js"],"names":["CATEGORY","XVIZBaseBuilder","XVIZTimeSeriesBuilder","constructor","props","category","TIME_SERIES","_data","Map","_id","_value","_timestamp","id","identifier","validatePropSetOnce","value","Array","validateError","timestamp","getData","_flush","size","timeSeriesData","ids","fields","tsdata","values","entry","streams","object_id","push","_addTimestampEntry","_dataPending","fieldName","String","tsEntry","get","idEntry","fieldEntry","_streamId","set","_getFieldEntry","_getIdEntry","_validate","validateWarn","_reset"],"mappings":";;;;;;AAcA,SAAQA,QAAR,QAAuB,YAAvB;AACA,OAAOC,eAAP,MAA4B,qBAA5B;AAsBA,eAAe,MAAMC,qBAAN,SAAoCD,eAApC,CAAoD;AACjEE,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACjB,0CACKA,KADL;AAEEC,MAAAA,QAAQ,EAAEL,QAAQ,CAACM;AAFrB;AAOA,SAAKC,KAAL,GAAa,IAAIC,GAAJ,EAAb;AAGA,SAAKC,GAAL,GAAW,IAAX;AACA,SAAKC,MAAL,GAAc,IAAd;AACA,SAAKC,UAAL,GAAkB,IAAlB;AACD;;AAEDC,EAAAA,EAAE,CAACC,UAAD,EAAa;AACb,SAAKC,mBAAL,CAAyB,KAAzB;AACA,SAAKL,GAAL,GAAWI,UAAX;AACA,WAAO,IAAP;AACD;;AAEDE,EAAAA,KAAK,CAACA,KAAD,EAAQ;AACX,SAAKD,mBAAL,CAAyB,QAAzB;;AAEA,QAAIC,KAAK,YAAYC,KAArB,EAA4B;AAC1B,WAAKC,aAAL,CAAmB,oCAAnB;AACD;;AAED,SAAKP,MAAL,GAAcK,KAAd;AACA,WAAO,IAAP;AACD;;AAEDG,EAAAA,SAAS,CAACA,SAAD,EAAY;AACnB,SAAKJ,mBAAL,CAAyB,YAAzB;;AAEA,QAAII,SAAS,YAAYF,KAAzB,EAAgC;AAC9B,WAAKC,aAAL,CAAmB,0CAAnB;AACD;;AAED,SAAKN,UAAL,GAAkBO,SAAlB;AACA,WAAO,IAAP;AACD;;AAEDC,EAAAA,OAAO,GAAG;AACR,SAAKC,MAAL;;AACA,QAAI,KAAKb,KAAL,CAAWc,IAAX,KAAoB,CAAxB,EAA2B;AACzB,aAAO,IAAP;AACD;;AAED,UAAMC,cAAc,GAAG,EAAvB;;AACA,SAAK,MAAM,CAACJ,SAAD,EAAYK,GAAZ,CAAX,IAA+B,KAAKhB,KAApC,EAA2C;AACzC,WAAK,MAAM,CAACK,EAAD,EAAKY,MAAL,CAAX,IAA2BD,GAA3B,EAAgC;AAC9B,aAAK,MAAME,MAAX,IAAqBD,MAAM,CAACE,MAAP,EAArB,EAAsC;AACpC,gBAAMC,KAAK,GAAG;AACZT,YAAAA,SADY;AAEZU,YAAAA,OAAO,EAAEH,MAAM,CAACG,OAFJ;AAGZF,YAAAA,MAAM,EAAED,MAAM,CAACC;AAHH,WAAd;;AAOA,cAAId,EAAE,KAAK,IAAX,EAAiB;AACfe,YAAAA,KAAK,CAACE,SAAN,GAAkBjB,EAAlB;AACD;;AAGDU,UAAAA,cAAc,CAACQ,IAAf,CAAoBH,KAApB;AACD;AACF;AACF;;AAED,WAAOL,cAAP;AACD;;AAGDS,EAAAA,kBAAkB,GAAG;AAUnB,QAAI,CAAC,KAAKC,YAAL,EAAL,EAA0B;AACxB;AACD;;AAGD,QAAIC,SAAS,GAAG,SAAhB;;AACA,QAAI,OAAO,KAAKvB,MAAZ,KAAuB,QAAvB,IAAmC,KAAKA,MAAL,YAAuBwB,MAA9D,EAAsE;AACpED,MAAAA,SAAS,GAAG,SAAZ;AACD,KAFD,MAEO,IAAI,OAAO,KAAKvB,MAAZ,KAAuB,SAA3B,EAAsC;AAC3CuB,MAAAA,SAAS,GAAG,OAAZ;AACD;;AAGD,QAAIE,OAAO,GAAG,KAAK5B,KAAL,CAAW6B,GAAX,CAAe,KAAKzB,UAApB,CAAd;;AACA,QAAIwB,OAAJ,EAAa;AAEX,YAAME,OAAO,GAAGF,OAAO,CAACC,GAAR,CAAY,KAAK3B,GAAjB,CAAhB;;AACA,UAAI4B,OAAJ,EAAa;AACX,cAAMC,UAAU,GAAGD,OAAO,CAACD,GAAR,CAAYH,SAAZ,CAAnB;;AACA,YAAIK,UAAJ,EAAgB;AAEdA,UAAAA,UAAU,CAACV,OAAX,CAAmBE,IAAnB,CAAwB,KAAKS,SAA7B;AACAD,UAAAA,UAAU,CAACZ,MAAX,CAAkBO,SAAlB,EAA6BH,IAA7B,CAAkC,KAAKpB,MAAvC;AACD,SAJD,MAIO;AACL2B,UAAAA,OAAO,CAACG,GAAR,CAAYP,SAAZ,EAAuB,KAAKQ,cAAL,CAAoBR,SAApB,CAAvB;AACD;AACF,OATD,MASO;AAELE,QAAAA,OAAO,CAACK,GAAR,CAAY,KAAK/B,GAAjB,EAAsB,KAAKiC,WAAL,CAAiBT,SAAjB,CAAtB;AACD;AACF,KAhBD,MAgBO;AAILE,MAAAA,OAAO,GAAG,IAAI3B,GAAJ,EAAV;AACA2B,MAAAA,OAAO,CAACK,GAAR,CAAY,KAAK/B,GAAjB,EAAsB,KAAKiC,WAAL,CAAiBT,SAAjB,CAAtB;;AACA,WAAK1B,KAAL,CAAWiC,GAAX,CAAe,KAAK7B,UAApB,EAAgCwB,OAAhC;AACD;AACF;;AAEDO,EAAAA,WAAW,CAACT,SAAD,EAAY;AACrB,UAAMI,OAAO,GAAG,IAAI7B,GAAJ,EAAhB;AACA6B,IAAAA,OAAO,CAACG,GAAR,CAAYP,SAAZ,EAAuB,KAAKQ,cAAL,CAAoBR,SAApB,CAAvB;AACA,WAAOI,OAAP;AACD;;AAEDI,EAAAA,cAAc,CAACR,SAAD,EAAY;AACxB,WAAO;AACLL,MAAAA,OAAO,EAAE,CAAC,KAAKW,SAAN,CADJ;AAELb,MAAAA,MAAM,EAAE;AAAC,SAACO,SAAD,GAAa,CAAC,KAAKvB,MAAN;AAAd;AAFH,KAAP;AAID;;AAEDsB,EAAAA,YAAY,GAAG;AACb,WAAO,KAAKtB,MAAL,KAAgB,IAAhB,IAAwB,KAAKC,UAAL,KAAoB,IAA5C,IAAoD,KAAKF,GAAL,KAAa,IAAxE;AACD;;AAEDkC,EAAAA,SAAS,GAAG;AACV,QAAI,KAAKX,YAAL,EAAJ,EAAyB;AACvB,YAAMW,SAAN;;AAEA,UAAI,KAAKjC,MAAL,KAAgB,IAApB,EAA0B;AACxB,aAAKkC,YAAL,kBAA4B,KAAKL,SAAjC;AACD;;AACD,UAAI,KAAK5B,UAAL,KAAoB,IAAxB,EAA8B;AAC5B,aAAKiC,YAAL,kBAA4B,KAAKL,SAAjC;AACD;AACF;AACF;;AAEDnB,EAAAA,MAAM,GAAG;AACP,SAAKuB,SAAL;;AAEA,SAAKZ,kBAAL;;AACA,SAAKc,MAAL;AACD;;AAGDA,EAAAA,MAAM,GAAG;AACP,SAAKpC,GAAL,GAAW,IAAX;AACA,SAAKC,MAAL,GAAc,IAAd;AACA,SAAKC,UAAL,GAAkB,IAAlB;AACD;;AAxKgE","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {CATEGORY} from './constant';\nimport XVIZBaseBuilder from './xviz-base-builder';\n\n/**\n * XVIZTimeSeriesBuilder manages time_series data by `time` and `id` and stores\n * the the array of single stream value entries.\n *\n * This is the shape returned from getData()\n *\n * [\n *   {\n *     timestamp: x,\n *     streams: ['a', 'b'],\n *     values: {doubles: [1, 2]},\n *     object_id: '123'\n *   },\n *   {\n *     timestamp: y,\n *     streams: ['a', 'b'],\n *     values: {doubles: [1, 2]},\n *   }\n * ]\n */\nexport default class XVIZTimeSeriesBuilder extends XVIZBaseBuilder {\n  constructor(props) {\n    super({\n      ...props,\n      category: CATEGORY.TIME_SERIES\n    });\n\n    // Stores time_series data by timestamp then id\n    // They will then be group when constructing final object\n    this._data = new Map();\n\n    // inflight builder data\n    this._id = null;\n    this._value = null;\n    this._timestamp = null;\n  }\n\n  id(identifier) {\n    this.validatePropSetOnce('_id');\n    this._id = identifier;\n    return this;\n  }\n\n  value(value) {\n    this.validatePropSetOnce('_value');\n\n    if (value instanceof Array) {\n      this.validateError('Input `value` must be single value');\n    }\n\n    this._value = value;\n    return this;\n  }\n\n  timestamp(timestamp) {\n    this.validatePropSetOnce('_timestamp');\n\n    if (timestamp instanceof Array) {\n      this.validateError('Input `timestamp` must be a single value');\n    }\n\n    this._timestamp = timestamp;\n    return this;\n  }\n\n  getData() {\n    this._flush();\n    if (this._data.size === 0) {\n      return null;\n    }\n\n    const timeSeriesData = [];\n    for (const [timestamp, ids] of this._data) {\n      for (const [id, fields] of ids) {\n        for (const tsdata of fields.values()) {\n          const entry = {\n            timestamp,\n            streams: tsdata.streams,\n            values: tsdata.values\n          };\n\n          /* eslint-disable camelcase, max-depth */\n          if (id !== null) {\n            entry.object_id = id;\n          }\n          /* eslint-enable camelcase, max-depth */\n\n          timeSeriesData.push(entry);\n        }\n      }\n    }\n\n    return timeSeriesData;\n  }\n\n  // Lookup by timestamp, then id to store [streamId, value]\n  _addTimestampEntry() {\n    // this._data structure\n    // timestamp: {\n    //   id: {\n    //     fieldName: {\n    //       streams: []\n    //       values: []\n    //     }\n    //   }\n    // }\n    if (!this._dataPending()) {\n      return;\n    }\n\n    // Lookup where to put the value\n    let fieldName = 'doubles';\n    if (typeof this._value === 'string' || this._value instanceof String) {\n      fieldName = 'strings';\n    } else if (typeof this._value === 'boolean') {\n      fieldName = 'bools';\n    }\n\n    // Building up the [(stream, value)] list\n    let tsEntry = this._data.get(this._timestamp);\n    if (tsEntry) {\n      // We have timestamp, now get id\n      const idEntry = tsEntry.get(this._id);\n      if (idEntry) {\n        const fieldEntry = idEntry.get(fieldName);\n        if (fieldEntry) {\n          // append entry to existing array\n          fieldEntry.streams.push(this._streamId);\n          fieldEntry.values[fieldName].push(this._value);\n        } else {\n          idEntry.set(fieldName, this._getFieldEntry(fieldName));\n        }\n      } else {\n        // create new mapping of id -> array of entries\n        tsEntry.set(this._id, this._getIdEntry(fieldName));\n      }\n    } else {\n      // No timestamp entry\n      // create new id -> array of entries\n      // for same id different with fieldNames, we store as different ts entries\n      tsEntry = new Map();\n      tsEntry.set(this._id, this._getIdEntry(fieldName));\n      this._data.set(this._timestamp, tsEntry);\n    }\n  }\n\n  _getIdEntry(fieldName) {\n    const idEntry = new Map();\n    idEntry.set(fieldName, this._getFieldEntry(fieldName));\n    return idEntry;\n  }\n\n  _getFieldEntry(fieldName) {\n    return {\n      streams: [this._streamId],\n      values: {[fieldName]: [this._value]}\n    };\n  }\n\n  _dataPending() {\n    return this._value !== null || this._timestamp !== null || this._id !== null;\n  }\n\n  _validate() {\n    if (this._dataPending()) {\n      super._validate();\n\n      if (this._value === null) {\n        this.validateWarn(`Stream ${this._streamId} value is not provided.`);\n      }\n      if (this._timestamp === null) {\n        this.validateWarn(`Stream ${this._streamId} timestamp is not provided.`);\n      }\n    }\n  }\n\n  _flush() {\n    this._validate();\n\n    this._addTimestampEntry();\n    this._reset();\n  }\n\n  // reset the inflight values\n  _reset() {\n    this._id = null;\n    this._value = null;\n    this._timestamp = null;\n  }\n}\n"],"file":"xviz-time-series-builder.js"}