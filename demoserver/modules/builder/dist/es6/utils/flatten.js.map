{"version":3,"sources":["../../../src/utils/flatten.js"],"names":["isFlattened","array","Number","isFinite","flattenToTypedArray","nestedArray","dimensions","ArrayType","Float32Array","length","checkVertices","from","count","countVertices","typedArray","flattenVerticesInPlace","nestedCount","localCount","index","value","Array","isArray","ArrayBuffer","isView","predicate","result","flattenVerticesInPlaceRecursive","insert","vertexLength"],"mappings":"AAcA,SAASA,WAAT,CAAqBC,KAArB,EAA4B;AAC1B,SAAOC,MAAM,CAACC,QAAP,CAAgBF,KAAK,CAAC,CAAD,CAArB,CAAP;AACD;;AAED,OAAO,SAASG,mBAAT,CAA6BC,WAA7B,EAA0CC,UAAU,GAAG,CAAvD,EAA0DC,SAAS,GAAGC,YAAtE,EAAoF;AACzF,MAAIH,WAAW,CAACI,MAAZ,KAAuB,CAA3B,EAA8B;AAC5B,WAAO,IAAID,YAAJ,CAAiB,CAAjB,CAAP;AACD;;AAED,MAAI,CAACE,aAAa,CAACL,WAAD,CAAlB,EAAiC;AAC/B,WAAO,IAAP;AACD;;AAGD,MAAIL,WAAW,CAACK,WAAD,CAAf,EAA8B;AAC5B,WAAOE,SAAS,CAACI,IAAV,CAAeN,WAAf,CAAP;AACD;;AAED,QAAMO,KAAK,GAAGC,aAAa,CAACR,WAAD,EAAcC,UAAd,CAA3B;AAEA,QAAMQ,UAAU,GAAG,IAAIP,SAAJ,CAAcK,KAAd,CAAnB;AACAG,EAAAA,sBAAsB,CAACV,WAAD,EAAcS,UAAd,EAA0BR,UAA1B,CAAtB;AACA,SAAOQ,UAAP;AACD;;AAED,SAASD,aAAT,CAAuBR,WAAvB,EAAoCC,UAAU,GAAG,CAAjD,EAAoD;AAClD,MAAIU,WAAW,GAAG,CAAlB;AACA,MAAIC,UAAU,GAAG,CAAjB;AACA,MAAIC,KAAK,GAAG,CAAC,CAAb;;AACA,SAAO,EAAEA,KAAF,GAAUb,WAAW,CAACI,MAA7B,EAAqC;AACnC,UAAMU,KAAK,GAAGd,WAAW,CAACa,KAAD,CAAzB;;AACA,QAAIE,KAAK,CAACC,OAAN,CAAcF,KAAd,KAAwBG,WAAW,CAACC,MAAZ,CAAmBJ,KAAnB,CAA5B,EAAuD;AACrDH,MAAAA,WAAW,IAAIH,aAAa,CAACM,KAAD,CAA5B;AACD,KAFD,MAEO;AACLF,MAAAA,UAAU;AACX;AACF;;AACD,SAAOD,WAAW,IAAIA,WAAW,KAAK,CAAhB,IAAqBC,UAAU,GAAGX,UAAlC,GAA+CA,UAA/C,GAA4DW,UAAhE,CAAlB;AACD;;AAED,SAASP,aAAT,CAAuBL,WAAvB,EAAoCmB,SAAS,GAAGtB,MAAM,CAACC,QAAvD,EAAiE;AAC/D,MAAIe,KAAK,GAAG,CAAC,CAAb;;AACA,SAAO,EAAEA,KAAF,GAAUb,WAAW,CAACI,MAA7B,EAAqC;AACnC,UAAMU,KAAK,GAAGd,WAAW,CAACa,KAAD,CAAzB;;AACA,QAAIE,KAAK,CAACC,OAAN,CAAcF,KAAd,KAAwBG,WAAW,CAACC,MAAZ,CAAmBJ,KAAnB,CAA5B,EAAuD;AACrD,UAAI,CAACT,aAAa,CAACS,KAAD,EAAQK,SAAR,CAAlB,EAAsC;AACpC,eAAO,KAAP;AACD;AACF,KAJD,MAIO,IAAI,CAACA,SAAS,CAACL,KAAD,CAAd,EAAuB;AAC5B,aAAO,KAAP;AACD;AACF;;AACD,SAAO,IAAP;AACD;;AAED,SAASJ,sBAAT,CAAgCV,WAAhC,EAA6CoB,MAA7C,EAAqDnB,UAAU,GAAG,CAAlE,EAAqE;AACnEoB,EAAAA,+BAA+B,CAACrB,WAAD,EAAcoB,MAAd,EAAsBnB,UAAtB,EAAkC,CAAlC,CAA/B;AACA,SAAOmB,MAAP;AACD;;AAGD,SAASC,+BAAT,CAAyCrB,WAAzC,EAAsDoB,MAAtD,EAA8DnB,UAA9D,EAA0EqB,MAA1E,EAAkF;AAChF,MAAIT,KAAK,GAAG,CAAC,CAAb;AACA,MAAIU,YAAY,GAAG,CAAnB;;AACA,SAAO,EAAEV,KAAF,GAAUb,WAAW,CAACI,MAA7B,EAAqC;AACnC,UAAMU,KAAK,GAAGd,WAAW,CAACa,KAAD,CAAzB;;AACA,QAAIE,KAAK,CAACC,OAAN,CAAcF,KAAd,KAAwBG,WAAW,CAACC,MAAZ,CAAmBJ,KAAnB,CAA5B,EAAuD;AACrDQ,MAAAA,MAAM,GAAGD,+BAA+B,CAACP,KAAD,EAAQM,MAAR,EAAgBnB,UAAhB,EAA4BqB,MAA5B,CAAxC;AACD,KAFD,MAEO;AAEL,UAAIC,YAAY,GAAGtB,UAAnB,EAA+B;AAC7BmB,QAAAA,MAAM,CAACE,MAAM,EAAP,CAAN,GAAmBR,KAAnB;AACAS,QAAAA,YAAY;AACb;AACF;AACF;;AAED,MAAIA,YAAY,GAAG,CAAf,IAAoBA,YAAY,GAAGtB,UAAvC,EAAmD;AACjDmB,IAAAA,MAAM,CAACE,MAAM,EAAP,CAAN,GAAmB,CAAnB;AACD;;AACD,SAAOA,MAAP;AACD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nfunction isFlattened(array) {\n  return Number.isFinite(array[0]);\n}\n\nexport function flattenToTypedArray(nestedArray, dimensions = 3, ArrayType = Float32Array) {\n  if (nestedArray.length === 0) {\n    return new Float32Array(0);\n  }\n\n  if (!checkVertices(nestedArray)) {\n    return null;\n  }\n\n  // Handle case where the array is already flattened.\n  if (isFlattened(nestedArray)) {\n    return ArrayType.from(nestedArray);\n  }\n\n  const count = countVertices(nestedArray, dimensions);\n\n  const typedArray = new ArrayType(count);\n  flattenVerticesInPlace(nestedArray, typedArray, dimensions);\n  return typedArray;\n}\n\nfunction countVertices(nestedArray, dimensions = 3) {\n  let nestedCount = 0;\n  let localCount = 0;\n  let index = -1;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      nestedCount += countVertices(value);\n    } else {\n      localCount++;\n    }\n  }\n  return nestedCount + (nestedCount === 0 && localCount < dimensions ? dimensions : localCount);\n}\n\nfunction checkVertices(nestedArray, predicate = Number.isFinite) {\n  let index = -1;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      if (!checkVertices(value, predicate)) {\n        return false;\n      }\n    } else if (!predicate(value)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction flattenVerticesInPlace(nestedArray, result, dimensions = 3) {\n  flattenVerticesInPlaceRecursive(nestedArray, result, dimensions, 0);\n  return result;\n}\n\n// Flattens nested array of vertices, padding third coordinate as needed\nfunction flattenVerticesInPlaceRecursive(nestedArray, result, dimensions, insert) {\n  let index = -1;\n  let vertexLength = 0;\n  while (++index < nestedArray.length) {\n    const value = nestedArray[index];\n    if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n      insert = flattenVerticesInPlaceRecursive(value, result, dimensions, insert);\n    } else {\n      // eslint-disable-next-line\n      if (vertexLength < dimensions) {\n        result[insert++] = value;\n        vertexLength++;\n      }\n    }\n  }\n  // Add a third coordinate if needed\n  if (vertexLength > 0 && vertexLength < dimensions) {\n    result[insert++] = 0;\n  }\n  return insert;\n}\n"],"file":"flatten.js"}