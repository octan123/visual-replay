{"version":3,"sources":["../../../src/parsers/parse-video-message-v1.js"],"names":["parseVideoMessageV1","message","onResult","onError","Blob","then","arrayBuffer","data","JSON","parse","result","parseStreamVideoData","error","ArrayBuffer","parseVideoFrame","type","parseVideoMetadata","XVIZ_MESSAGE_TYPE","ERROR","VIDEO_METADATA","view","DataView","VIDEO_FRAME","littleEndian","utf8Decoder","TextDecoder","offset","version","getUint32","versionFlags","streamLength","stringStart","stream","decode","slice","timestamp","getFloat64","imageSize","imageData","imageType"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * This file contains parsers for XVIZ video stream protocol.\n * Naming conventions:\n * `message` refers to the raw message received via webSocket.onmessage\n * `data` refers to pre-processed data objects (blob, arraybuffer, JSON object)\n */\n/* global Blob */\nimport {XVIZ_MESSAGE_TYPE} from '../constants';\nimport {TextDecoder} from '../utils/text-encoding';\nimport {blobToArrayBuffer} from '../utils/binary';\n\nimport {parseLogMetadata} from './parse-log-metadata';\n\n// Handle messages from the stand alone video server\nexport function parseVideoMessageV1(message, onResult, onError) {\n  if (message instanceof Blob) {\n    blobToArrayBuffer(message)\n      .then(arrayBuffer => {\n        parseVideoMessageV1(arrayBuffer, onResult, onError);\n      })\n      .catch(onError);\n    return;\n  }\n\n  try {\n    let data = message;\n    if (typeof message === 'string') {\n      data = JSON.parse(message);\n    }\n    const result = parseStreamVideoData(data);\n    onResult(result);\n  } catch (error) {\n    onError(error);\n  }\n}\n\n// Handle messages from the stand alone video server\nexport function parseStreamVideoData(data) {\n  if (data instanceof ArrayBuffer) {\n    return parseVideoFrame(data);\n  }\n  if (data.type === 'metadata') {\n    return parseVideoMetadata(data);\n  }\n  // Unknown message\n  return {type: XVIZ_MESSAGE_TYPE.ERROR, message: 'Unknown stream data type', data};\n}\n\n// Extract metadata from stream message\nfunction parseVideoMetadata(data) {\n  const result = parseLogMetadata(data);\n  result.type = XVIZ_MESSAGE_TYPE.VIDEO_METADATA;\n\n  return result;\n}\n\n// Parse image data from stream message\n// https://code.int.uberatc.com/diffusion/AV/browse/master/source/xviz/services/video/www/index.js\nexport function parseVideoFrame(arrayBuffer) {\n  const view = new DataView(arrayBuffer);\n\n  // Read off version\n  const result = {type: XVIZ_MESSAGE_TYPE.VIDEO_FRAME};\n  const littleEndian = true;\n  const utf8Decoder = new TextDecoder('utf-8');\n\n  // Check version\n  let offset = 0;\n  result.version = view.getUint32(offset, littleEndian);\n  offset += 4;\n  result.versionFlags = view.getUint32(offset, littleEndian);\n  offset += 4;\n\n  // Read off stream name\n  const streamLength = view.getUint32(offset, littleEndian);\n  const stringStart = offset + 4;\n  offset += 4 + streamLength;\n\n  result.stream = utf8Decoder.decode(arrayBuffer.slice(stringStart, offset));\n\n  // Read off timestamp\n  result.timestamp = view.getFloat64(offset, littleEndian);\n  offset += 8;\n\n  // Read slice off the image data\n  const imageSize = view.getUint32(offset, littleEndian);\n  offset += 4;\n\n  result.imageData = arrayBuffer.slice(offset, offset + imageSize);\n  result.imageType = 'image/jpeg';\n\n  return result;\n}\n"],"file":"parse-video-message-v1.js"}