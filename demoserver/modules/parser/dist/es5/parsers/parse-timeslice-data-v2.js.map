{"version":3,"sources":["../../../src/parsers/parse-timeslice-data-v2.js"],"names":["parseStreamSet","data","convertPrimitive","update_type","updates","updateType","STATE_UPDATE_TYPE","toUpperCase","log","error","type","XVIZ_MESSAGE_TYPE","INCOMPLETE","message","length","warn","streamSets","timestamp","reduce","t","stateUpdate","Math","max","Number","isFinite","result","TIMESLICE","streams","links","parseStreamSets","Object","assign","STREAM_BLACKLIST","newStreams","newLinks","poses","primitives","variables","timeSeries","futures","uiPrimitives","noDataStreams","streamSet","future_instances","ui_primitives","time_series","push","no_data_streams","keys","filter","streamName","has","forEach","primitive","variable","timeSeriesStreams","future","stream"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Extracts a TIMESLICE message v2\nimport {XVIZ_MESSAGE_TYPE, STATE_UPDATE_TYPE} from '../constants';\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {parseXVIZPose} from './parse-xviz-pose';\nimport {parseXVIZLink} from './parse-xviz-link';\nimport {\n  parseStreamFutures,\n  parseStreamPrimitive,\n  parseStreamVariable,\n  parseStreamTimeSeries,\n  parseStreamUIPrimitives\n} from './parse-xviz-stream';\nimport log from '../utils/log';\n\n/* eslint-disable camelcase */\n\nexport default function parseStreamSet(data, convertPrimitive) {\n  const {update_type, updates} = data;\n  const updateType = STATE_UPDATE_TYPE[update_type.toUpperCase()];\n\n  if (!updateType) {\n    log.error(`update_type of \"${update_type}\" is not supported.`)();\n    return {type: XVIZ_MESSAGE_TYPE.INCOMPLETE, message: 'Unsupported update type'};\n  }\n\n  if (!updates) {\n    return {type: XVIZ_MESSAGE_TYPE.INCOMPLETE, message: 'Missing required \"updates\" property'};\n  }\n\n  if (updates && updates.length === 0) {\n    return {\n      type: XVIZ_MESSAGE_TYPE.INCOMPLETE,\n      message: 'Property \"updates\" has length of 0, no data?'\n    };\n  }\n\n  if (updates.length > 1) {\n    log.warn(\n      `Only XVIZ first update of \"snapshot\" is currently supported. Current updates has \"${\n        updates.length\n      }\" entries.`\n    )();\n  }\n\n  const streamSets = updates;\n\n  let timestamp = null;\n  if (streamSets) {\n    timestamp = streamSets.reduce((t, stateUpdate) => {\n      if (!t) {\n        return stateUpdate && stateUpdate.timestamp;\n      }\n      return Math.max(t, stateUpdate.timestamp);\n    }, null);\n  }\n\n  if (!Number.isFinite(timestamp)) {\n    // Incomplete stream message, just tag it accordingly so client can ignore it\n    return {type: XVIZ_MESSAGE_TYPE.INCOMPLETE, message: 'Missing timestamp in \"updates\"'};\n  }\n\n  const result = {\n    type: XVIZ_MESSAGE_TYPE.TIMESLICE,\n    updateType,\n    streams: {},\n    links: {},\n    timestamp\n    // TODO/Xintong validate primary vehicle pose in each update?\n  };\n\n  if (streamSets) {\n    const {streams, links} = parseStreamSets(streamSets, timestamp, convertPrimitive);\n    Object.assign(result.streams, streams);\n    Object.assign(result.links, links);\n  }\n\n  return result;\n}\n\n/* eslint-disable max-statements */\nfunction parseStreamSets(streamSets, timestamp, convertPrimitive) {\n  const {STREAM_BLACKLIST} = getXVIZConfig();\n\n  const newStreams = {};\n  const newLinks = {};\n\n  const poses = {};\n  const primitives = {};\n  const variables = {};\n  const timeSeries = [];\n  const futures = {};\n  const uiPrimitives = {};\n  const noDataStreams = [];\n\n  for (const streamSet of streamSets) {\n    Object.assign(newLinks, streamSet.links);\n\n    Object.assign(poses, streamSet.poses);\n    Object.assign(primitives, streamSet.primitives);\n    Object.assign(variables, streamSet.variables);\n    Object.assign(futures, streamSet.future_instances);\n    Object.assign(uiPrimitives, streamSet.ui_primitives);\n\n    if (streamSet.time_series) {\n      if (timeSeries) {\n        timeSeries.push(...streamSet.time_series);\n      }\n    }\n\n    if (streamSet.no_data_streams) {\n      noDataStreams.push(...streamSet.no_data_streams);\n    }\n  }\n\n  Object.keys(newLinks)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(streamName => {\n      newLinks[streamName] = parseXVIZLink(newLinks[streamName]);\n    });\n\n  Object.keys(poses)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(streamName => {\n      newStreams[streamName] = parseXVIZPose(poses[streamName]);\n    });\n\n  Object.keys(primitives)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(primitive => {\n      newStreams[primitive] = parseStreamPrimitive(\n        primitives[primitive],\n        primitive,\n        timestamp,\n        convertPrimitive\n      );\n    });\n\n  Object.keys(variables)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(variable => {\n      newStreams[variable] = parseStreamVariable(variables[variable], variable, timestamp);\n    });\n\n  if (timeSeries.length) {\n    const timeSeriesStreams = parseStreamTimeSeries(timeSeries, STREAM_BLACKLIST);\n    Object.assign(newStreams, timeSeriesStreams);\n  }\n\n  Object.keys(futures)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(future => {\n      newStreams[future] = parseStreamFutures(futures[future], future, timestamp, convertPrimitive);\n    });\n\n  Object.keys(uiPrimitives)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(primitive => {\n      newStreams[primitive] = parseStreamUIPrimitives(\n        uiPrimitives[primitive],\n        primitive,\n        timestamp\n      );\n    });\n\n  if (noDataStreams.length) {\n    // Explicitly set to null and the stream buffer will do the right thing\n    noDataStreams.forEach(stream => (newStreams[stream] = null));\n  }\n\n  return {\n    streams: newStreams,\n    links: newLinks\n  };\n}\n/* eslint-enable max-statements */\n"],"file":"parse-timeslice-data-v2.js"}