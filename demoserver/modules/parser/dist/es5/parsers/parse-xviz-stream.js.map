{"version":3,"sources":["../../../src/parsers/parse-xviz-stream.js"],"names":["createPrimitiveMap","result","key","PRIMITIVE_CAT","SCALAR_TYPE","doubles","int32s","bools","strings","parseXVIZStream","data","convertPrimitive","primitives","ui_primitives","variables","futures","streamName","Object","keys","map","datum","parseStreamPrimitive","timestamp","parseStreamVariable","parseStreamFutures","parseStreamUIPrimitives","time","OBJECT_STREAM","preProcessPrimitive","DYNAMIC_STREAM_METADATA","PRIMITIVE_SETTINGS","currentMajorVersion","XVIZPrimitiveSettingsV1","XVIZPrimitiveSettingsV2","primitiveData","Array","isArray","primType","type","objects","primitiveMap","category","objectIndex","length","object","LOOKAHEAD","push","j","primitive","isMainThread","id","XVIZObject","observe","vertices","joinFeatureVerticesToTypedArrays","features","pointCloud","joinObjectPointCloudsToTypedArrays","points","positions","colors","ids","__metadata","primitive_type","parseStreamFuturesV1","parseStreamFuturesV2","lookAheads","forEach","future","filter","Boolean","timestamps","future_set","futureIndex","normalizedPrimitive","parseStreamVariableV1","parseStreamVariableV2","scalar_type","variable","values","v","i","entry","base","valueData","getVariableData","object_id","parseStreamTimeSeries","seriesArray","streamBlackList","parseStreamTimeSeriesV2","log","error","valuesObject","timeSeriesStreams","timeSeriesEntry","streams","entryIndex","has","tsStream","warn","getVertexCount","Number","isFinite","getColorStride","vertexCount","stride","feature","Float64Array","count","set","p","subarray","DEFAULT_COLOR","numInstances","vertexColorStride","Float32Array","Uint8ClampedArray","Uint32Array","vertexPositions","vertexColors","colorStride","color","isColorFlattenedArray","isPositionFlattenedArray","fill","vertex","components","assign"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {PRIMITIVE_CAT, normalizeXVIZPrimitive} from './parse-xviz-primitive';\nimport XVIZObject from '../objects/xviz-object';\nimport {isMainThread} from '../utils/globals';\nimport log from '../utils/log';\nimport {getPrimitiveData} from './xviz-v2-common';\n\nimport XVIZPrimitiveSettingsV1 from './xviz-primitives-v1';\nimport XVIZPrimitiveSettingsV2 from './xviz-primitives-v2';\n\nfunction createPrimitiveMap() {\n  const result = {};\n  for (const key in PRIMITIVE_CAT) {\n    result[PRIMITIVE_CAT[key]] = [];\n  }\n  return result;\n}\n\nconst SCALAR_TYPE = {\n  doubles: 'FLOAT',\n  int32s: 'INT32',\n  bools: 'BOOL',\n  strings: 'STRING'\n};\n\n/* eslint-disable max-depth, max-statements, complexity, camelcase */\n// Handle stream-sliced data, via the ETL flow.\nexport function parseXVIZStream(data, convertPrimitive) {\n  // data is an array of objects\n  // Each object is [{primitives, variables, timestamp},...]\n  // Each object represents a timestamp and array of objects\n\n  // V1 has a no-data entry that results in setting all top-level types to an\n  // empty array. See the test cases.\n  //\n  // Usually only one of these fields is valid and thus only one is normally\n  // iterated below.\n  const {primitives, ui_primitives, variables, futures} = data[0];\n\n  // At this point, we either have one or the other.\n  // TODO(twojtasz): BUG: there is an assumption that\n  // streamNames will be unique.  Need to put in a detection if\n  // that is violated.\n  if (primitives) {\n    const streamName = Object.keys(primitives)[0];\n    return data.map(datum =>\n      parseStreamPrimitive(\n        datum.primitives[streamName],\n        streamName,\n        datum.timestamp,\n        convertPrimitive\n      )\n    );\n  } else if (variables) {\n    const streamName = Object.keys(variables)[0];\n    return data.map(datum =>\n      parseStreamVariable(datum.variables[streamName], streamName, datum.timestamp)\n    );\n  } else if (futures) {\n    const streamName = Object.keys(futures)[0];\n    return data.map(datum =>\n      parseStreamFutures(datum.futures[streamName], streamName, datum.timestamp, convertPrimitive)\n    );\n  } else if (ui_primitives) {\n    const streamName = Object.keys(ui_primitives)[0];\n    return data.map(datum =>\n      parseStreamUIPrimitives(datum.ui_primitives[streamName], streamName, datum.timestamp)\n    );\n  }\n\n  return {};\n}\n\n/* Processes an individual primitive time sample and converts the\n * data to UI elements.\n */\nexport function parseStreamPrimitive(primitives, streamName, time, convertPrimitive) {\n  const {OBJECT_STREAM, preProcessPrimitive, DYNAMIC_STREAM_METADATA} = getXVIZConfig();\n  const PRIMITIVE_SETTINGS =\n    getXVIZConfig().currentMajorVersion === 1 ? XVIZPrimitiveSettingsV1 : XVIZPrimitiveSettingsV2;\n\n  const primitiveData = getPrimitiveData(primitives);\n\n  if (!primitiveData || !Array.isArray(primitiveData.primitives)) {\n    return {};\n  }\n\n  const {type: primType, primitives: objects} = primitiveData;\n\n  const primitiveMap = createPrimitiveMap();\n\n  let category = null;\n  // Primitives are an array of XVIZ objects\n  for (let objectIndex = 0; objectIndex < objects.length; objectIndex++) {\n    const object = objects[objectIndex];\n\n    // array of primitives\n    if (object && Array.isArray(object)) {\n      category = PRIMITIVE_CAT.LOOKAHEAD;\n      primitiveMap[category].push([]);\n\n      for (let j = 0; j < object.length; j++) {\n        // Apply custom XVIZ pre processing to this primitive\n        preProcessPrimitive({primitive: object[j], streamName, time});\n\n        // process each primitive\n        const primitive = normalizeXVIZPrimitive(\n          PRIMITIVE_SETTINGS,\n          object[j],\n          objectIndex,\n          streamName,\n          primType,\n          time,\n          convertPrimitive\n        );\n        if (primitive) {\n          primitiveMap[category][objectIndex].push(primitive);\n        }\n      }\n    } else {\n      // single primitive\n\n      // Apply custom XVIZ postprocessing to this primitive\n      preProcessPrimitive({primitive: object, streamName, time});\n\n      // normalize primitive\n      const primitive = normalizeXVIZPrimitive(\n        PRIMITIVE_SETTINGS,\n        object,\n        objectIndex,\n        streamName,\n        primType,\n        time,\n        convertPrimitive\n      );\n\n      // Allow for v1 inline type to override primitive type\n      category = PRIMITIVE_SETTINGS[object.type || primType].category;\n      if (primitive) {\n        primitiveMap[category].push(primitive);\n\n        if (\n          isMainThread &&\n          // OBJECT_STREAM is deprecated, only keeping for backward compatibility\n          (streamName === OBJECT_STREAM ||\n            (!OBJECT_STREAM && primitive.id && category === 'features'))\n        ) {\n          XVIZObject.observe(primitive.id, time);\n        }\n      }\n    }\n  }\n\n  primitiveMap.vertices = joinFeatureVerticesToTypedArrays(primitiveMap.features);\n  const pointCloud = joinObjectPointCloudsToTypedArrays(primitiveMap.pointCloud);\n  if (pointCloud) {\n    primitiveMap.features.push({\n      type: pointCloud.type,\n      points: pointCloud.positions,\n      colors: pointCloud.colors,\n      ids: pointCloud.ids\n    });\n  }\n  // Backward compatibility\n  primitiveMap.pointCloud = pointCloud;\n  primitiveMap.time = time;\n\n  if (DYNAMIC_STREAM_METADATA) {\n    primitiveMap.__metadata = {\n      category: 'PRIMITIVE',\n      primitive_type: primType\n    };\n  }\n\n  return primitiveMap;\n}\n\n/* Processes the futures and converts the\n * data to UI elements.\n */\nexport function parseStreamFutures(objects, streamName, time, convertPrimitive) {\n  const {currentMajorVersion, DYNAMIC_STREAM_METADATA} = getXVIZConfig();\n\n  const result =\n    currentMajorVersion === 1\n      ? parseStreamFuturesV1(objects, streamName, time, convertPrimitive)\n      : parseStreamFuturesV2(objects, streamName, time, convertPrimitive);\n\n  if (DYNAMIC_STREAM_METADATA) {\n    result.__metadata = {\n      category: 'FUTURE_INSTANCE',\n      primitive_type: result.lookAheads[0][0] && result.lookAheads[0][0].type\n    };\n  }\n\n  return result;\n}\n\nexport function parseStreamFuturesV1(objects, streamName, time, convertPrimitive) {\n  const futures = [];\n  // objects = array of objects\n  // [{timestamp, primitives[]}, ...]\n\n  // Futures are an array of array of primitives and\n  // the objectIndex is used to find the timestamp associated\n  // with the set of primitives.\n  objects.forEach((object, objectIndex) => {\n    const {primitives} = object;\n\n    const future = primitives\n      .map(primitive =>\n        normalizeXVIZPrimitive(\n          XVIZPrimitiveSettingsV1,\n          primitive,\n          objectIndex,\n          streamName,\n          primitive.type,\n          time,\n          convertPrimitive\n        )\n      )\n      .filter(Boolean);\n\n    futures.push(future);\n  });\n\n  return {\n    time,\n    lookAheads: futures\n  };\n}\n\nexport function parseStreamFuturesV2(objects, streamName, time, convertPrimitive) {\n  const futures = [];\n\n  // objects = {\n  //   timestamps: [1, 2, 3],\n  //   primitives: [\n  //    { <type>: [ <objects for ts[1]> ] },\n  //    { <type>: [ <objects for ts[2]> ] },\n  //    { <type>: [ <objects for ts[3]> ] }\n  //   ]\n  // }\n\n  const timestamps = objects.timestamps;\n  objects.primitives.forEach((future_set, futureIndex) => {\n    // Get the underlying primitive array\n    const data = getPrimitiveData(future_set);\n\n    const future = data.primitives\n      .map(primitive => {\n        const normalizedPrimitive = normalizeXVIZPrimitive(\n          XVIZPrimitiveSettingsV2,\n          primitive,\n          futureIndex,\n          streamName,\n          data.type,\n          time,\n          convertPrimitive\n        );\n\n        normalizedPrimitive.timestamp = timestamps[futureIndex];\n        return normalizedPrimitive;\n      })\n      .filter(Boolean);\n\n    futures.push(future);\n  });\n\n  return {\n    time,\n    lookAheads: futures\n  };\n}\n\n/* Processes an individual variable time sample and converts the\n * data to UI elements.\n */\nexport function parseStreamVariable(objects, streamName, time) {\n  const {currentMajorVersion, DYNAMIC_STREAM_METADATA} = getXVIZConfig();\n\n  const result =\n    currentMajorVersion === 1\n      ? parseStreamVariableV1(objects, streamName, time)\n      : parseStreamVariableV2(objects, streamName, time);\n\n  if (DYNAMIC_STREAM_METADATA) {\n    result.__metadata = {\n      category: 'VARIABLE',\n      scalar_type: Array.isArray(result.variable) && result.variable[0] && result.variable[0].type\n    };\n  }\n\n  return result;\n}\n\nexport function parseStreamVariableV1(objects, streamName, time) {\n  if (Array.isArray(objects)) {\n    return {time};\n  }\n\n  let variable;\n  const {timestamps, values} = objects;\n  if (values.length === 1) {\n    variable = values[0];\n  } else if (timestamps) {\n    variable = values.map((v, i) => [timestamps[i], v]);\n  } else {\n    variable = values;\n  }\n\n  const entry = {\n    time,\n    variable\n  };\n\n  return entry;\n}\n\nexport function parseStreamVariableV2(objects, streamName, time) {\n  if (Array.isArray(objects)) {\n    return {time};\n  }\n\n  const variables = objects.variables;\n  if (!variables || !Array.isArray(variables)) {\n    return {};\n  }\n\n  const result = {time};\n\n  result.variable = variables\n    .map(entry => {\n      const {base, values} = entry;\n\n      const valueData = getVariableData(values);\n      if (!valueData || !valueData.values) {\n        return null;\n      }\n\n      if (base && base.object_id) {\n        valueData.id = base.object_id;\n      }\n\n      return valueData;\n    })\n    .filter(Boolean);\n\n  return result;\n}\n\n/* Processes a time_series sample and converts the\n * data to UI elements.\n */\nexport function parseStreamTimeSeries(seriesArray, streamBlackList) {\n  const {currentMajorVersion} = getXVIZConfig();\n\n  if (currentMajorVersion === 2) {\n    return parseStreamTimeSeriesV2(seriesArray, streamBlackList);\n  }\n\n  log.error(`Invalid time_series data in XVIZ version ${currentMajorVersion}`)();\n  return null;\n}\n\nfunction getVariableData(valuesObject) {\n  // Primitives have the type as the first key\n  for (const key in valuesObject) {\n    if (key in SCALAR_TYPE) {\n      return {type: SCALAR_TYPE[key], values: valuesObject[key]};\n    }\n  }\n\n  // TODO(twojtasz): a more informative error path that doesn't abort processing\n  return null;\n}\n\nfunction parseStreamTimeSeriesV2(seriesArray, streamBlackList) {\n  if (!Array.isArray(seriesArray)) {\n    return {};\n  }\n  const {DYNAMIC_STREAM_METADATA} = getXVIZConfig();\n\n  const timeSeriesStreams = {};\n  seriesArray.forEach(timeSeriesEntry => {\n    const {timestamp, streams, values, object_id} = timeSeriesEntry;\n    const valueData = getVariableData(values);\n\n    if (!valueData || valueData.values.length !== streams.length) {\n      return null;\n    }\n\n    valueData.values.forEach((variable, entryIndex) => {\n      const streamName = streams[entryIndex];\n\n      if (!streamBlackList.has(streamName)) {\n        const entry = {time: timestamp, variable};\n        if (object_id) {\n          entry.id = object_id;\n        }\n\n        const tsStream = timeSeriesStreams[streamName];\n\n        if (tsStream) {\n          // a duplicate entry is seen, leave the first entry.\n          log.warn(`Unexpected time_series duplicate: ${streamName}`)();\n        } else {\n          timeSeriesStreams[streamName] = entry;\n        }\n\n        if (DYNAMIC_STREAM_METADATA) {\n          entry.__metadata = {\n            category: 'TIME_SERIES',\n            scalar_type: valueData.type\n          };\n        }\n      }\n    });\n\n    // eslint consistent-return warning\n    // This for loop we do not need to return any value\n    return timeSeriesStreams;\n  });\n\n  return timeSeriesStreams;\n}\n\nfunction getVertexCount(vertices) {\n  return Number.isFinite(vertices[0]) ? vertices.length / 3 : vertices.length;\n}\n\nfunction getColorStride(colors, vertexCount) {\n  if (colors) {\n    if (colors.length / 4 === vertexCount) {\n      return 4;\n    }\n    if (colors.length / 3 === vertexCount) {\n      return 3;\n    }\n    let stride;\n    if (Array.isArray(colors[0])) {\n      stride = colors[0].length;\n    } else {\n      stride = colors.length;\n    }\n    if (stride === 3 || stride === 4) {\n      return stride;\n    }\n    log.error('Unknown point color format');\n  }\n  return 0;\n}\n\n// Create typed arrays from vertices to save storage & transfer time\nfunction joinFeatureVerticesToTypedArrays(features) {\n  let vertexCount = 0;\n  for (const feature of features) {\n    if (feature.vertices) {\n      vertexCount += getVertexCount(feature.vertices);\n    }\n  }\n\n  if (vertexCount === 0) {\n    return null;\n  }\n\n  const vertices = new Float64Array(vertexCount * 3);\n  let i = 0;\n\n  for (const feature of features) {\n    if (feature.vertices) {\n      const count = getVertexCount(feature.vertices);\n      if (Number.isFinite(feature.vertices[0])) {\n        vertices.set(feature.vertices, i);\n        i += count * 3;\n      } else {\n        for (const p of feature.vertices) {\n          vertices.set(p, i);\n          i += 3;\n        }\n      }\n      feature.vertices = vertices.subarray(i - count * 3, i);\n    }\n  }\n\n  return vertices;\n}\n\nconst DEFAULT_COLOR = [0, 0, 0, 255];\n\n// Joins a set of point clouds extracted from objects into a single point cloud\n// generates typed arrays that can be displayed efficiently by deck.gl\nfunction joinObjectPointCloudsToTypedArrays(objects) {\n  if (objects.length === 0) {\n    return null;\n  }\n\n  let numInstances = 0;\n  for (const object of objects) {\n    numInstances += getVertexCount(object.vertices);\n  }\n\n  let vertexColorStride = null;\n\n  const positions = new Float32Array(numInstances * 3);\n  const colors = new Uint8ClampedArray(numInstances * 4);\n\n  // Store object ids to enable recoloring.\n  // NOTE: Not a vertex attribute, ids are just efficiently stored as as 32 bit integers...\n  const ids = new Uint32Array(numInstances);\n\n  let i = 0;\n  objects.forEach(object => {\n    const vertexPositions = object.vertices;\n    // object.color is V1 and should be removed when deprecated\n    const vertexColors = object.colors;\n    const vertexCount = getVertexCount(vertexPositions);\n\n    if (vertexCount === 0) {\n      return;\n    }\n\n    // Setup for per-point color\n    const colorStride = getColorStride(vertexColors || object.color, vertexCount);\n    if (vertexColorStride !== null && vertexColorStride !== colorStride) {\n      log.error('Inconsistent point color format');\n    }\n    vertexColorStride = colorStride;\n\n    const isColorFlattenedArray =\n      vertexColors && vertexColors.length === vertexCount * vertexColorStride;\n    if (isColorFlattenedArray) {\n      colors.set(vertexColors, i * vertexColorStride);\n    }\n\n    const isPositionFlattenedArray = vertexPositions.length === vertexCount * 3;\n    if (isPositionFlattenedArray) {\n      positions.set(vertexPositions, i * 3);\n    }\n\n    if (Number.isFinite(object.id)) {\n      // v1 object ids\n      ids.fill(object.id, i, i + vertexCount);\n    }\n\n    if (isPositionFlattenedArray && (isColorFlattenedArray || !vertexColorStride)) {\n      // both positions and colors are populated\n      return;\n    }\n\n    let color = object.color || DEFAULT_COLOR;\n    for (let j = 0; j < vertexCount; j++, i++) {\n      if (!isPositionFlattenedArray) {\n        const vertex = vertexPositions[j];\n        positions[i * 3 + 0] = vertex[0];\n        positions[i * 3 + 1] = vertex[1];\n        positions[i * 3 + 2] = vertex[2];\n      }\n\n      if (!isColorFlattenedArray && vertexColorStride) {\n        if (vertexColors) {\n          color = vertexColors[j];\n        }\n        colors[i * vertexColorStride + 0] = color[0];\n        colors[i * vertexColorStride + 1] = color[1];\n        colors[i * vertexColorStride + 2] = color[2];\n        if (vertexColorStride === 4) {\n          colors[i * vertexColorStride + 3] = color[3] || 255;\n        }\n      }\n    }\n  });\n\n  return {\n    type: objects[0].type,\n    numInstances,\n    positions,\n    colors: vertexColorStride ? colors.subarray(0, vertexColorStride * numInstances) : null,\n    ids\n  };\n}\n\nexport function parseStreamUIPrimitives(components, streamName, time) {\n  const result = Object.assign({time}, components);\n\n  if (getXVIZConfig().DYNAMIC_STREAM_METADATA) {\n    result.__metadata = {\n      category: 'UI_PRIMITIVE'\n    };\n  }\n\n  return result;\n}\n"],"file":"parse-xviz-stream.js"}