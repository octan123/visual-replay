{"version":3,"sources":["../../../src/parsers/parse-xviz-primitive.js"],"names":["PRIMITIVE_CAT","LOOKAHEAD","FEATURE","LABEL","POINTCLOUD","IMAGE","COMPONENT","normalizeXVIZPrimitive","PRIMITIVE_PROCCESSOR","primitive","objectIndex","streamName","type","time","postProcessPrimitive","primitiveType","vertices","center","enableZOffset","validate","normalize","zOffset","i","length"],"mappings":"AAcA,OAAO,MAAMA,aAAa,GAAG;AAC3BC,EAAAA,SAAS,EAAE,YADgB;AAE3BC,EAAAA,OAAO,EAAE,UAFkB;AAG3BC,EAAAA,KAAK,EAAE,QAHoB;AAI3BC,EAAAA,UAAU,EAAE,YAJe;AAK3BC,EAAAA,KAAK,EAAE,QALoB;AAM3BC,EAAAA,SAAS,EAAE;AANgB,CAAtB;AAUP,OAAO,SAASC,sBAAT,CACLC,oBADK,EAELC,SAFK,EAGLC,WAHK,EAILC,UAJK,EAKLC,IALK,EAMLC,IANK,EAOLC,oBAPK,EAQL;AAMA,QAAMC,aAAa,GAAGN,SAAS,CAACG,IAAV,IAAkBA,IAAxC;AAEA,QAAM;AAEJI,IAAAA,QAFI;AAIJC,IAAAA;AAJI,MAKFR,SALJ;AAOA,QAAM;AAACS,IAAAA,aAAD;AAAgBC,IAAAA,QAAhB;AAA0BC,IAAAA;AAA1B,MAAuCZ,oBAAoB,CAACO,aAAD,CAAjE;;AAGA,MAAIG,aAAJ,EAAmB;AACjB,UAAMG,OAAO,GAAGX,WAAW,GAAG,IAA9B;;AACA,QAAIM,QAAJ,EAAc;AAIZ,WAAK,IAAIM,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGN,QAAQ,CAACO,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AAExCN,QAAAA,QAAQ,CAACM,CAAD,CAAR,CAAY,CAAZ,IAAiBD,OAAjB;AACD;AACF;;AACD,QAAIJ,MAAM,IAAIA,MAAM,CAACM,MAAP,KAAkB,CAAhC,EAAmC;AACjCN,MAAAA,MAAM,CAAC,CAAD,CAAN,GAAYI,OAAZ;AACD;AACF;;AAGD,MAAIN,aAAJ,EAAmB;AACjBN,IAAAA,SAAS,CAACG,IAAV,GAAiBG,aAAjB;AACD;;AAGD,MAAI,CAACI,QAAQ,CAACV,SAAD,EAAYE,UAAZ,EAAwBE,IAAxB,CAAb,EAA4C;AAC1C,WAAO,IAAP;AACD;;AAGD,MAAIO,SAAJ,EAAe;AACbA,IAAAA,SAAS,CAACX,SAAD,CAAT;AACD;;AAGD,MAAIK,oBAAJ,EAA0B;AACxBA,IAAAA,oBAAoB,CAACL,SAAD,CAApB;AACD;;AAED,SAAOA,SAAP;AACD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nexport const PRIMITIVE_CAT = {\n  LOOKAHEAD: 'lookAheads',\n  FEATURE: 'features',\n  LABEL: 'labels',\n  POINTCLOUD: 'pointCloud',\n  IMAGE: 'images',\n  COMPONENT: 'components' // TODO(twojtasz): remove when v1 support is removed\n};\n\n// eslint-disable-next-line max-params\nexport function normalizeXVIZPrimitive(\n  PRIMITIVE_PROCCESSOR,\n  primitive,\n  objectIndex,\n  streamName,\n  type,\n  time,\n  postProcessPrimitive\n) {\n  // as normalizeXVIZPrimitive is called for each primitive of every frame\n  // it is intentional to mutate the primitive in place\n  // to avoid frequent allocate/discard and improve performance\n\n  // Type could come set (v2 metadata or object, or v1 inline)\n  const primitiveType = primitive.type || type;\n\n  const {\n    // line2d, polygon2d\n    vertices,\n    // circle2d\n    center\n  } = primitive;\n\n  const {enableZOffset, validate, normalize} = PRIMITIVE_PROCCESSOR[primitiveType];\n\n  // Apply a small offset to 2d geometries to battle z fighting\n  if (enableZOffset) {\n    const zOffset = objectIndex * 1e-6;\n    if (vertices) {\n      // TODO(twojtasz): this is pretty bad for memory, backend must\n      // set all 3 values otherwise we allocate and cause heavy GC\n      // TODO - this looks like it could be handled with a model matrix?\n      for (let i = 0; i < vertices.length; i++) {\n        // Flatten the data for now\n        vertices[i][2] = zOffset;\n      }\n    }\n    if (center && center.length === 2) {\n      center[2] = zOffset;\n    }\n  }\n\n  // add 'type' if not present at root level of primitive\n  if (primitiveType) {\n    primitive.type = primitiveType;\n  }\n\n  // validate\n  if (!validate(primitive, streamName, time)) {\n    return null;\n  }\n\n  // process\n  if (normalize) {\n    normalize(primitive);\n  }\n\n  // post process\n  if (postProcessPrimitive) {\n    postProcessPrimitive(primitive);\n  }\n\n  return primitive;\n}\n"],"file":"parse-xviz-primitive.js"}