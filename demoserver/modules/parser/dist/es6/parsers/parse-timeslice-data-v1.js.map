{"version":3,"sources":["../../../src/parsers/parse-timeslice-data-v1.js"],"names":["getXVIZConfig","XVIZ_MESSAGE_TYPE","parseStreamFutures","parseStreamPrimitive","parseStreamVariable","parseTimesliceData","data","convertPrimitive","PRIMARY_POSE_STREAM","vehicle_pose","vehiclePose","state_updates","stateUpdates","otherInfo","timestamp","time","reduce","t","stateUpdate","Math","max","type","INCOMPLETE","newStreams","result","TIMESLICE","streams","xvizStreams","parseStateUpdates","Object","assign","STREAM_BLACKLIST","primitives","variables","futures","keys","filter","streamName","has","forEach","primitive","variable","future"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Extracts a TIMESLICE message v1\nimport {getXVIZConfig} from '../config/xviz-config';\nimport {XVIZ_MESSAGE_TYPE} from '../constants';\nimport {parseStreamFutures, parseStreamPrimitive, parseStreamVariable} from './parse-xviz-stream';\n\nexport default function parseTimesliceData(data, convertPrimitive) {\n  const {PRIMARY_POSE_STREAM} = getXVIZConfig();\n  const {vehicle_pose: vehiclePose, state_updates: stateUpdates, ...otherInfo} = data;\n\n  let timestamp;\n  if (vehiclePose) {\n    timestamp = vehiclePose.time;\n  } else if (stateUpdates) {\n    timestamp = stateUpdates.reduce((t, stateUpdate) => {\n      return Math.max(t, stateUpdate.timestamp);\n    }, 0);\n  }\n\n  if (!timestamp) {\n    // Incomplete stream message, just tag it accordingly so client can ignore it\n    return {type: XVIZ_MESSAGE_TYPE.INCOMPLETE};\n  }\n\n  const newStreams = {};\n  const result = {\n    ...otherInfo,\n    type: XVIZ_MESSAGE_TYPE.TIMESLICE,\n    streams: newStreams,\n    timestamp\n  };\n\n  if (stateUpdates) {\n    const xvizStreams = parseStateUpdates(stateUpdates, timestamp, convertPrimitive);\n    Object.assign(newStreams, xvizStreams);\n  }\n\n  if (vehiclePose) {\n    // v1 -> v2\n    newStreams[PRIMARY_POSE_STREAM] = vehiclePose;\n  }\n\n  return result;\n}\n\nfunction parseStateUpdates(stateUpdates, timestamp, convertPrimitive) {\n  const {STREAM_BLACKLIST} = getXVIZConfig();\n\n  const newStreams = {};\n  const primitives = {};\n  const variables = {};\n  const futures = {};\n\n  for (const stateUpdate of stateUpdates) {\n    Object.assign(primitives, stateUpdate.primitives);\n    Object.assign(variables, stateUpdate.variables);\n    Object.assign(futures, stateUpdate.futures);\n  }\n\n  Object.keys(primitives)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(primitive => {\n      newStreams[primitive] = parseStreamPrimitive(\n        primitives[primitive],\n        primitive,\n        timestamp,\n        convertPrimitive\n      );\n    });\n\n  Object.keys(variables)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(variable => {\n      newStreams[variable] = parseStreamVariable(variables[variable], variable, timestamp);\n    });\n\n  Object.keys(futures)\n    .filter(streamName => !STREAM_BLACKLIST.has(streamName))\n    .forEach(future => {\n      newStreams[future] = parseStreamFutures(futures[future], future, timestamp, convertPrimitive);\n    });\n\n  return newStreams;\n}\n"],"file":"parse-timeslice-data-v1.js"}