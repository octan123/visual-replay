{"version":3,"sources":["../../../src/parsers/parse-xviz-message-sync.js"],"names":["XVIZ_MESSAGE_TYPE","XVIZData","parseLogMetadata","parseVideoMessageV1","parseTimesliceDataV1","parseTimesliceDataV2","getXVIZConfig","parseXVIZMessageSync","message","onResult","onError","opts","Blob","messageType","messageFormat","xvizData","xvizMsg","data","v2Type","type","undefined","result","parseXVIZData","error","typeKey","update_type","parseTimesliceData","convertPrimitive","METADATA","DONE","ERROR","currentMajorVersion"],"mappings":";;;;;;AAqBA,SAAQA,iBAAR,QAAgC,cAAhC;AACA,SAAQC,QAAR,QAAuB,UAAvB;AACA,SAAQC,gBAAR,QAA+B,sBAA/B;AACA,SAAQC,mBAAR,QAAkC,0BAAlC;AACA,OAAOC,oBAAP,MAAiC,2BAAjC;AACA,OAAOC,oBAAP,MAAiC,2BAAjC;AACA,SAAQC,aAAR,QAA4B,uBAA5B;AAMA,OAAO,SAASC,oBAAT,CAA8BC,OAA9B,EAAuCC,QAAvC,EAAiDC,OAAjD,EAA0DC,IAA1D,EAAgE;AAIrE,MAAI,OAAOC,IAAP,KAAgB,WAAhB,IAA+BJ,OAAO,YAAYI,IAAtD,EAA4D;AAC1DT,IAAAA,mBAAmB,CAACK,OAAD,EAAUC,QAAV,EAAoBC,OAApB,CAAnB;AACA;AACD;;AAPoE,MAS9DG,WAT8D,GAShCF,IATgC,CAS9DE,WAT8D;AAAA,MASjDC,aATiD,GAShCH,IATgC,CASjDG,aATiD;;AAWrE,MAAI;AACF,QAAMC,QAAQ,GAAG,IAAId,QAAJ,CAAaO,OAAb,EAAsB;AAACK,MAAAA,WAAW,EAAXA,WAAD;AAAcC,MAAAA,aAAa,EAAbA;AAAd,KAAtB,CAAjB;AACA,QAAME,OAAO,GAAGD,QAAQ,CAACP,OAAT,EAAhB;;AAGA,QAAIQ,OAAJ,EAAa;AACX,UAAMC,IAAI,GAAGD,OAAO,CAACC,IAArB;AAEA,UAAMC,MAAM,GAAGF,OAAO,CAACG,IAAR,IAAgBC,SAA/B;AAEA,UAAMC,MAAM,GAAGC,aAAa,CAACL,IAAD,kCAAWN,IAAX;AAAiBO,QAAAA,MAAM,EAANA;AAAjB,SAA5B;AAEAT,MAAAA,QAAQ,CAACY,MAAD,CAAR;AACD;AACF,GAdD,CAcE,OAAOE,KAAP,EAAc;AACdb,IAAAA,OAAO,CAACa,KAAD,CAAP;AACD;AACF;AAED,OAAO,SAASD,aAAT,CAAuBL,IAAvB,EAAwC;AAAA,MAAXN,IAAW,uEAAJ,EAAI;AAG7C,MAAMa,OAAO,GAAGb,IAAI,CAACO,MAAL,IAAeD,IAAI,CAACE,IAApB,IAA4BF,IAAI,CAACT,OAAjC,IAA4CS,IAAI,CAACQ,WAAjE;;AAEA,UAAQD,OAAR;AACE,SAAK,cAAL;AACE,aAAOE,kBAAkB,CAACT,IAAD,EAAON,IAAI,CAACgB,gBAAZ,CAAzB;;AACF,SAAK,UAAL;AACE,6CACKzB,gBAAgB,CAACe,IAAD,CADrB;AAGEE,QAAAA,IAAI,EAAEnB,iBAAiB,CAAC4B;AAH1B;;AAKF,SAAK,oBAAL;AACE,6CAAWX,IAAX;AAAiBE,QAAAA,IAAI,EAAEnB,iBAAiB,CAAC6B;AAAzC;;AACF,SAAK,OAAL;AACE,6CAAWZ,IAAX;AAAiBT,QAAAA,OAAO,EAAE,qBAA1B;AAAiDW,QAAAA,IAAI,EAAEnB,iBAAiB,CAAC8B;AAAzE;;AAGF,SAAK,MAAL;AACE,6CAAWb,IAAX;AAAiBE,QAAAA,IAAI,EAAEnB,iBAAiB,CAAC6B;AAAzC;;AACF;AAEE,aAAOH,kBAAkB,CAACT,IAAD,EAAON,IAAI,CAACgB,gBAAZ,CAAzB;AAnBJ;AAqBD;;AAED,SAASD,kBAAT,CAA4BT,IAA5B,EAAkCU,gBAAlC,EAAoD;AAAA,uBACpBrB,aAAa,EADO;AAAA,MAC3CyB,mBAD2C,kBAC3CA,mBAD2C;;AAGlD,SAAOA,mBAAmB,KAAK,CAAxB,GACH3B,oBAAoB,CAACa,IAAD,EAAOU,gBAAP,CADjB,GAEHtB,oBAAoB,CAACY,IAAD,EAAOU,gBAAP,CAFxB;AAGD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * This file contains parsers for XVIZ log stream protocol.\n * Naming conventions:\n  `message` refers to the raw message received via webSocket.onmessage\n * `data` refers to pre-processed data objects (blob, arraybuffer, JSON object)\n */\n/* global Blob */\nimport {XVIZ_MESSAGE_TYPE} from '../constants';\nimport {XVIZData} from '@xviz/io';\nimport {parseLogMetadata} from './parse-log-metadata';\nimport {parseVideoMessageV1} from './parse-video-message-v1';\nimport parseTimesliceDataV1 from './parse-timeslice-data-v1';\nimport parseTimesliceDataV2 from './parse-timeslice-data-v2';\nimport {getXVIZConfig} from '../config/xviz-config';\n\n// Post processes a stream message to make it easy to use for JavaScript applications\n// opts.messageType is the message type contained in data envelope (when it has one)\n// - If supplied it assume data does not have an Envelope.\n// - Can be one of ('xviz/state_update', 'xviz/metadata', etc.)\nexport function parseXVIZMessageSync(message, onResult, onError, opts) {\n  // TODO(twojtasz): better message dispatching\n  // here, not all arraybuffer may be image (packed point cloud)\n  // TODO(jlisee): Node.js support for blobs for better unit testing\n  if (typeof Blob !== 'undefined' && message instanceof Blob) {\n    parseVideoMessageV1(message, onResult, onError);\n    return;\n  }\n\n  const {messageType, messageFormat} = opts;\n\n  try {\n    const xvizData = new XVIZData(message, {messageType, messageFormat});\n    const xvizMsg = xvizData.message();\n\n    // Non-xviz messages will return null\n    if (xvizMsg) {\n      const data = xvizMsg.data;\n\n      const v2Type = xvizMsg.type || undefined;\n\n      const result = parseXVIZData(data, {...opts, v2Type});\n\n      onResult(result);\n    }\n  } catch (error) {\n    onError(error);\n  }\n}\n\nexport function parseXVIZData(data, opts = {}) {\n  // TODO(twojtasz): this data.message is due an\n  // uncoordinated change on the XVIZ server, temporary.\n  const typeKey = opts.v2Type || data.type || data.message || data.update_type;\n\n  switch (typeKey) {\n    case 'state_update':\n      return parseTimesliceData(data, opts.convertPrimitive);\n    case 'metadata':\n      return {\n        ...parseLogMetadata(data),\n        // ensure application sees the metadata type set to the uppercase version\n        type: XVIZ_MESSAGE_TYPE.METADATA\n      };\n    case 'transform_log_done':\n      return {...data, type: XVIZ_MESSAGE_TYPE.DONE};\n    case 'error':\n      return {...data, message: 'Stream server error', type: XVIZ_MESSAGE_TYPE.ERROR};\n\n    // v1 types\n    case 'done':\n      return {...data, type: XVIZ_MESSAGE_TYPE.DONE};\n    default:\n      //  TODO(twojtasz): XVIZ should be tagging this with a type\n      return parseTimesliceData(data, opts.convertPrimitive);\n  }\n}\n\nfunction parseTimesliceData(data, convertPrimitive) {\n  const {currentMajorVersion} = getXVIZConfig();\n\n  return currentMajorVersion === 1\n    ? parseTimesliceDataV1(data, convertPrimitive)\n    : parseTimesliceDataV2(data, convertPrimitive);\n}\n"],"file":"parse-xviz-message-sync.js"}