{"version":3,"sources":["../../../src/workers/stream-data-worker.js"],"names":["setXVIZConfig","parseXVIZMessageSync","preSerialize","getTransferList","XVIZ_MESSAGE_TYPE","config","self","onResult","message","transfers","Set","type","TIMESLICE","streamName","streams","stream","pointCloud","vertices","images","length","forEach","image","VIDEO_FRAME","imageData","postMessage","Array","from","onError","error","onmessage","e","data","xvizConfig","opts"],"mappings":"AAeA,SAAQA,aAAR,QAA4B,uBAA5B;AACA,SAAQC,oBAAR,QAAmC,oCAAnC;AACA,SAAQC,YAAR,QAA2B,sBAA3B;AACA,SAAQC,eAAR,QAA8B,uBAA9B;AACA,SAAQC,iBAAR,QAAgC,cAAhC;AAEA,gBAAe,UAAAC,MAAM;AAAA,SAAI,UAAAC,IAAI,EAAI;AAC/BN,IAAAA,aAAa,CAACK,MAAD,CAAb;;AAEA,aAASE,QAAT,CAAkBC,OAAlB,EAA2B;AACzB,UAAMC,SAAS,GAAG,IAAIC,GAAJ,EAAlB;;AAEA,cAAQF,OAAO,CAACG,IAAhB;AACE,aAAKP,iBAAiB,CAACQ,SAAvB;AACE,eAAK,IAAMC,UAAX,IAAyBL,OAAO,CAACM,OAAjC,EAA0C;AACxC,gBAAMC,MAAM,GAAGP,OAAO,CAACM,OAAR,CAAgBD,UAAhB,CAAf;;AACA,gBAAIE,MAAJ,EAAY;AACVZ,cAAAA,eAAe,CAACY,MAAM,CAACC,UAAR,EAAoB,IAApB,EAA0BP,SAA1B,CAAf;AACAN,cAAAA,eAAe,CAACY,MAAM,CAACE,QAAR,EAAkB,KAAlB,EAAyBR,SAAzB,CAAf;;AACA,kBAAIM,MAAM,CAACG,MAAP,IAAiBH,MAAM,CAACG,MAAP,CAAcC,MAAnC,EAA2C;AACzCJ,gBAAAA,MAAM,CAACG,MAAP,CAAcE,OAAd,CAAsB,UAAAC,KAAK;AAAA,yBAAIlB,eAAe,CAACkB,KAAD,EAAQ,IAAR,EAAcZ,SAAd,CAAnB;AAAA,iBAA3B;AACD;AACF;AACF;;AACD;;AAEF,aAAKL,iBAAiB,CAACkB,WAAvB;AAEEnB,UAAAA,eAAe,CAACK,OAAO,CAACe,SAAT,EAAoB,KAApB,EAA2Bd,SAA3B,CAAf;AACA;;AAEF;AAnBF;;AAsBAD,MAAAA,OAAO,GAAGN,YAAY,CAACM,OAAD,CAAtB;AAYAF,MAAAA,IAAI,CAACkB,WAAL,CAAiBhB,OAAjB,EAA0BiB,KAAK,CAACC,IAAN,CAAWjB,SAAX,CAA1B;AACD;;AAED,aAASkB,OAAT,CAAiBC,KAAjB,EAAwB;AACtB,YAAMA,KAAN;AACD;;AAEDtB,IAAAA,IAAI,CAACuB,SAAL,GAAiB,UAAAC,CAAC,EAAI;AAIpB,UAAIA,CAAC,CAACC,IAAF,IAAUD,CAAC,CAACC,IAAF,CAAOC,UAArB,EAAiC;AAC/BhC,QAAAA,aAAa,CAAC8B,CAAC,CAACC,IAAF,CAAOC,UAAR,CAAb;AACD,OAFD,MAEO,IAAIF,CAAC,CAACC,IAAN,EAAY;AACjB,YAAID,CAAC,CAACC,IAAF,CAAOE,IAAX,EAAiB;AAEfhC,UAAAA,oBAAoB,CAAC6B,CAAC,CAACC,IAAF,CAAOA,IAAR,EAAcxB,QAAd,EAAwBoB,OAAxB,EAAiCG,CAAC,CAACC,IAAF,CAAOE,IAAxC,CAApB;AACD,SAHD,MAGO;AAELhC,UAAAA,oBAAoB,CAAC6B,CAAC,CAACC,IAAH,EAASxB,QAAT,EAAmBoB,OAAnB,CAApB;AACD;AACF;AACF,KAfD;AAgBD,GA/DoB;AAAA,CAArB","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n/* eslint-disable max-depth */\n\nimport {setXVIZConfig} from '../config/xviz-config';\nimport {parseXVIZMessageSync} from '../parsers/parse-xviz-message-sync';\nimport {preSerialize} from '../parsers/serialize';\nimport {getTransferList} from '../utils/worker-utils';\nimport {XVIZ_MESSAGE_TYPE} from '../constants';\n\nexport default config => self => {\n  setXVIZConfig(config);\n\n  function onResult(message) {\n    const transfers = new Set();\n\n    switch (message.type) {\n      case XVIZ_MESSAGE_TYPE.TIMESLICE:\n        for (const streamName in message.streams) {\n          const stream = message.streams[streamName];\n          if (stream) {\n            getTransferList(stream.pointCloud, true, transfers);\n            getTransferList(stream.vertices, false, transfers);\n            if (stream.images && stream.images.length) {\n              stream.images.forEach(image => getTransferList(image, true, transfers));\n            }\n          }\n        }\n        break;\n\n      case XVIZ_MESSAGE_TYPE.VIDEO_FRAME:\n        // v1 video stream\n        getTransferList(message.imageData, false, transfers);\n        break;\n\n      default:\n    }\n\n    message = preSerialize(message);\n\n    /* uncomment for debug */\n    // let size = 0;\n    // for (const item of transfers) {\n    //   size += item.byteLength;\n    // }\n    // message._size = {\n    //   arraybuffer: size\n    // };\n    // message._sentAt = Date.now();\n\n    self.postMessage(message, Array.from(transfers));\n  }\n\n  function onError(error) {\n    throw error;\n  }\n\n  self.onmessage = e => {\n    // The WorkerFarm will \"broadcast\" the version to the workers\n    // to make sure they properly respond in the event a v1 log is read\n    // then a v2 during the same session\n    if (e.data && e.data.xvizConfig) {\n      setXVIZConfig(e.data.xvizConfig);\n    } else if (e.data) {\n      if (e.data.opts) {\n        // Support explicit message type with non-enveloped protobuf\n        parseXVIZMessageSync(e.data.data, onResult, onError, e.data.opts);\n      } else {\n        // Normal flow where we handle message type determination\n        parseXVIZMessageSync(e.data, onResult, onError);\n      }\n    }\n  };\n};\n"],"file":"stream-data-worker.js"}