{"version":3,"sources":["../../../src/synchronizers/log-slice.js"],"names":["getXVIZConfig","XVIZObject","findInsertPos","INSERT_POSITION","log","getTransformsFromPose","lookAheadTimesliceAccessor","timeslice","length","timestamp","warn","updateObjects","streamName","features","feature","xvizObject","get","id","_addFeature","LogSlice","streamFilter","lookAheadMs","linksByReverseTime","streamsByReverseTime","variables","pointCloud","lookAheads","components","links","streams","initialize","params","postProcessFrame","vehiclePose","OBJECT_STREAM","frame","resetAll","objects","getAllInCurrentFrame","filter","Object","keys","forEach","_includeStream","addStreamDatum","datum","setLabelsOnXVIZObjects","labels","variable","lookAheadTime","time","lookAheadIndex","RIGHT","undefined","label","object","labelName","_setProp","value","stream","defaultValue","streamData"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {getXVIZConfig} from '../config/xviz-config';\nimport XVIZObject from '../objects/xviz-object';\nimport {findInsertPos, INSERT_POSITION} from '../utils/search';\nimport log from '../utils/log';\n\nimport {getTransformsFromPose} from '../parsers/parse-vehicle-pose';\n\n// lookAheads is an array of arrays, so we need to fetch out the first\n// timestamp of the inner array.\nfunction lookAheadTimesliceAccessor(timeslice) {\n  if (timeslice && timeslice.length) {\n    return timeslice[0].timestamp;\n  }\n\n  log.warn('Missing entry or timestamp in lookAhead array')();\n  return 0;\n}\n\nfunction updateObjects(streamName, features) {\n  for (const feature of features) {\n    const xvizObject = XVIZObject.get(feature.id);\n    if (xvizObject) {\n      xvizObject._addFeature(streamName, feature);\n    }\n  }\n}\n\n// LOGSLICE CLASS\n\n// One time slice, one datum from each stream.\nexport default class LogSlice {\n  constructor(streamFilter, lookAheadMs, linksByReverseTime, streamsByReverseTime) {\n    this.features = {};\n    this.variables = {};\n    this.pointCloud = null;\n    this.lookAheads = {};\n    this.components = {};\n    this.links = {};\n    this.streams = {};\n\n    this.initialize(streamFilter, lookAheadMs, linksByReverseTime, streamsByReverseTime);\n  }\n\n  // Extract car data from vehicle_pose and get geoJson for related frames\n  /* eslint-disable max-statements */\n  getCurrentFrame(params, postProcessFrame) {\n    const {vehiclePose} = params;\n    if (!vehiclePose) {\n      return null;\n    }\n\n    const {OBJECT_STREAM} = getXVIZConfig();\n\n    const frame = {\n      ...params,\n      ...getTransformsFromPose(vehiclePose),\n      vehiclePose,\n      features: this.features,\n      lookAheads: this.lookAheads,\n      variables: this.variables,\n      pointCloud: this.pointCloud,\n      components: this.components,\n      streams: this.streams,\n      links: this.links\n    };\n\n    // OBJECTS\n    XVIZObject.resetAll();\n    if (postProcessFrame) {\n      postProcessFrame(frame);\n    }\n\n    // OBJECT_STREAM is deprecated, only keeping for backward compatibility\n    if (OBJECT_STREAM) {\n      updateObjects(OBJECT_STREAM, this.features[OBJECT_STREAM] || []);\n    } else {\n      for (const streamName in this.features) {\n        const features = this.features[streamName];\n        if (features.length && features[0].id) {\n          updateObjects(streamName, features);\n        }\n      }\n\n      for (const streamName in this.variables) {\n        const variables = this.variables[streamName];\n        if (variables.length && variables[0].id) {\n          updateObjects(streamName, variables);\n        }\n      }\n    }\n\n    frame.objects = XVIZObject.getAllInCurrentFrame(); // Map of XVIZ ids in current slice\n\n    return frame;\n  }\n  /* eslint-enable max-statements */\n\n  // HELPER METHODS\n\n  /**\n   * In-contrast to the per-stream post-processors,\n   * this function has the ability to look at and correlate data from multiple streams.\n   * Among other things parses XVIZ Object-related info from misc streams and merge into XVIZ\n   * feature properties.\n   */\n  initialize(streamFilter, lookAheadMs, linksByReverseTime, streamsByReverseTime) {\n    const filter = streamFilter && Object.keys(streamFilter).length > 0 ? streamFilter : null;\n\n    // get data if we don't already have that stream && it is not filtered.\n    streamsByReverseTime.forEach(streams => {\n      for (const streamName in streams) {\n        if (\n          this.streams[streamName] !== null && // Explicit no data entry\n          !this.streams[streamName] && // undefined means it has not been seen so keep looking for valid entry\n          this._includeStream(filter, streamName)\n        ) {\n          this.addStreamDatum(streams[streamName], streamName, lookAheadMs, this);\n        }\n      }\n    });\n\n    // get data if we don't already have that stream && it is not filtered.\n    linksByReverseTime.forEach(links => {\n      for (const streamName in links) {\n        if (\n          this.links[streamName] !== null && // Explicit no data entry\n          !this.links[streamName] && // undefined means it has not been seen so keep looking for valid entry\n          this._includeStream(filter, streamName)\n        ) {\n          this.links[streamName] = links[streamName];\n        }\n      }\n    });\n  }\n\n  /**\n   * Process a stream and put the appropriate data into\n   */\n  addStreamDatum(datum, streamName, lookAheadMs) {\n    this.streams[streamName] = datum;\n\n    // Handle the no data case\n    if (!datum) {\n      return;\n    }\n\n    this.setLabelsOnXVIZObjects(datum.labels);\n\n    const {features = [], lookAheads = [], variable, pointCloud = null} = datum;\n\n    // Future data is separate from features so we can control independently\n    if (lookAheads.length && lookAheadMs > 0) {\n      const lookAheadTime = datum.time + lookAheadMs;\n      const lookAheadIndex = findInsertPos(\n        lookAheads,\n        lookAheadTime,\n        INSERT_POSITION.RIGHT,\n        lookAheadTimesliceAccessor\n      );\n\n      if (lookAheadIndex) {\n        this.lookAheads[streamName] = lookAheads[lookAheadIndex - 1];\n      }\n    }\n\n    // Combine data from current datums\n    if (features.length) {\n      this.features[streamName] = features;\n    }\n\n    // Point cloud\n    if (pointCloud) {\n      this.pointCloud = pointCloud;\n    }\n\n    if (variable !== undefined) {\n      this.variables[streamName] = variable;\n    }\n  }\n\n  setLabelsOnXVIZObjects(labels = []) {\n    // Sort labels by id\n    labels.forEach(label => {\n      const object = XVIZObject.get(label.id);\n      if (object && label.labelName) {\n        // Extract label name (acceleration, velocity etc.) from stream name\n\n        // For streams that do not follow the simple pattern in STREAM_REGEXP\n        // Lookup for exact matches for labels first.\n        object._setProp(label.labelName, label.value);\n      }\n    });\n  }\n\n  // Helper function to get a stream from data\n  // @param {Object} data - log data\n  // @param {String} stream - name of stream\n  // @param {*} defaultValue={} - return value in case stream is not present\n  // @return {Object} - contents of stream or defaultValue\n  getStream(stream, defaultValue = {}) {\n    const streamData = this.streams[stream];\n    if (!streamData) {\n      return defaultValue;\n    }\n    return streamData;\n  }\n\n  _includeStream(streamFilter, streamName) {\n    return !streamFilter || streamFilter[streamName];\n  }\n}\n"],"file":"log-slice.js"}