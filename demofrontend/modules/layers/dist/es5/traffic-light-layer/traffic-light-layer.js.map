{"version":3,"sources":["../../../src/traffic-light-layer/traffic-light-layer.js"],"names":["LIGHT_COLOR","invalid","green","yellow","red","LIGHT_SHAPE","circular","left_arrow","right_arrow","defaultProps","getPosition","type","value","x","position","getAngle","getShape","getColor","getState","sizeScale","min","material","shininess","specularColor","TrafficLightLayer","vs","fs","modules","project32","gouraudLighting","picking","gl","context","modelsByName","_getModels","setState","models","box","lights","attributeManager","getAttributeManager","addInstanced","instancePositions","size","GL","DOUBLE","fp64","use64bitPositions","accessor","instanceAngles","instanceShapes","UNSIGNED_BYTE","transform","shape","instanceColors","color","instanceStates","uniforms","props","state","setUniforms","Object","assign","modelScale","draw","shaders","getShaders","Model","id","shaderCache","geometry","CubeGeometry","isInstanced","modelTranslate","useInstanceColor","SphereGeometry","lightShapeTexture","changedAttributes","getModels","model","setInstanceCount","data","length","setAttributes","Layer","layerName"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAoBA;;AACA;;AACA;;AAEA;;AACA;;AAEA;;;;;;;;;;;;;;;;AAEA,IAAMA,WAAW,GAAG;AAClBC,EAAAA,OAAO,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CADS;AAElBC,EAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,GAAJ,EAAS,GAAT,CAFW;AAGlBC,EAAAA,MAAM,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,CAAX,CAHU;AAIlBC,EAAAA,GAAG,EAAE,CAAC,GAAD,EAAM,EAAN,EAAU,EAAV;AAJa,CAApB;AAQA,IAAMC,WAAW,GAAG;AAClBC,EAAAA,QAAQ,EAAE,CADQ;AAElBC,EAAAA,UAAU,EAAE,CAFM;AAGlBC,EAAAA,WAAW,EAAE;AAHK,CAApB;AAOA,IAAMC,YAAY,GAAG;AACnBC,EAAAA,WAAW,EAAE;AAACC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,eAAAC,CAAC;AAAA,aAAIA,CAAC,CAACC,QAAN;AAAA;AAA3B,GADM;AAEnBC,EAAAA,QAAQ,EAAE;AAACJ,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE;AAA1B,GAFS;AAGnBI,EAAAA,QAAQ,EAAE;AAACL,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,eAAAC,CAAC;AAAA,aAAI,UAAJ;AAAA;AAA3B,GAHS;AAInBI,EAAAA,QAAQ,EAAE;AAACN,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,eAAAC,CAAC;AAAA,aAAI,OAAJ;AAAA;AAA3B,GAJS;AAKnBK,EAAAA,QAAQ,EAAE;AAACP,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE;AAA1B,GALS;AAOnBO,EAAAA,SAAS,EAAE;AAACR,IAAAA,IAAI,EAAE,QAAP;AAAiBC,IAAAA,KAAK,EAAE,IAAxB;AAA8BQ,IAAAA,GAAG,EAAE;AAAnC,GAPQ;AASnBC,EAAAA,QAAQ,EAAE;AACRC,IAAAA,SAAS,EAAE,CADH;AAERC,IAAAA,aAAa,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP;AAFP;AATS,CAArB;;IAeqBC,iB;;;;;;;;;;;;iCACN;AACX,aAAO;AAACC,QAAAA,EAAE,EAAFA,mCAAD;AAAKC,QAAAA,EAAE,EAAFA,qCAAL;AAASC,QAAAA,OAAO,EAAE,CAACC,eAAD,EAAYC,qBAAZ,EAA6BC,aAA7B;AAAlB,OAAP;AACD;;;sCAEiB;AAAA,UACTC,EADS,GACH,KAAKC,OADF,CACTD,EADS;;AAEhB,UAAME,YAAY,GAAG,KAAKC,UAAL,CAAgBH,EAAhB,CAArB;;AACA,WAAKI,QAAL,CAAc;AACZC,QAAAA,MAAM,EAAE,CAACH,YAAY,CAACI,GAAd,EAAmBJ,YAAY,CAACK,MAAhC,CADI;AAEZL,QAAAA,YAAY,EAAZA;AAFY,OAAd;AAKA,UAAMM,gBAAgB,GAAG,KAAKC,mBAAL,EAAzB;AAEAD,MAAAA,gBAAgB,CAACE,YAAjB,CAA8B;AAC5BC,QAAAA,iBAAiB,EAAE;AACjBC,UAAAA,IAAI,EAAE,CADW;AAEjBhC,UAAAA,IAAI,EAAEiC,sBAAGC,MAFQ;AAGjBC,UAAAA,IAAI,EAAE,KAAKC,iBAAL,EAHW;AAIjBC,UAAAA,QAAQ,EAAE;AAJO,SADS;AAO5BC,QAAAA,cAAc,EAAE;AAACN,UAAAA,IAAI,EAAE,CAAP;AAAUK,UAAAA,QAAQ,EAAE;AAApB,SAPY;AAQ5BE,QAAAA,cAAc,EAAE;AACdP,UAAAA,IAAI,EAAE,CADQ;AAEdhC,UAAAA,IAAI,EAAEiC,sBAAGO,aAFK;AAGdH,UAAAA,QAAQ,EAAE,UAHI;AAIdI,UAAAA,SAAS,EAAE,mBAAAC,KAAK;AAAA,mBAAIhD,WAAW,CAACgD,KAAD,CAAX,IAAsB,CAA1B;AAAA;AAJF,SARY;AAc5BC,QAAAA,cAAc,EAAE;AACdX,UAAAA,IAAI,EAAE,CADQ;AAEdhC,UAAAA,IAAI,EAAEiC,sBAAGO,aAFK;AAGdH,UAAAA,QAAQ,EAAE,UAHI;AAIdI,UAAAA,SAAS,EAAE,mBAAAG,KAAK;AAAA,mBAAIvD,WAAW,CAACuD,KAAD,CAAX,IAAsBvD,WAAW,CAACC,OAAtC;AAAA;AAJF,SAdY;AAoB5BuD,QAAAA,cAAc,EAAE;AACdb,UAAAA,IAAI,EAAE,CADQ;AAEdhC,UAAAA,IAAI,EAAEiC,sBAAGO,aAFK;AAGdH,UAAAA,QAAQ,EAAE;AAHI;AApBY,OAA9B;AA2BD;;;+BAEgB;AAAA,UAAXS,QAAW,QAAXA,QAAW;AAAA,UACRtC,SADQ,GACK,KAAKuC,KADV,CACRvC,SADQ;AAAA,UAERc,YAFQ,GAEQ,KAAK0B,KAFb,CAER1B,YAFQ;AAIfA,MAAAA,YAAY,CAACI,GAAb,CACGuB,WADH,CAEIC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBL,QAAlB,EAA4B;AAC1BM,QAAAA,UAAU,EAAE,CAAC5C,SAAS,GAAG,GAAb,EAAkBA,SAAS,GAAG,GAA9B,EAAmCA,SAAS,GAAG,GAA/C;AADc,OAA5B,CAFJ,EAMG6C,IANH;AAOA/B,MAAAA,YAAY,CAACK,MAAb,CACGsB,WADH,CAEIC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBL,QAAlB,EAA4B;AAC1BM,QAAAA,UAAU,EAAE,CAAC5C,SAAD,EAAYA,SAAZ,EAAuBA,SAAvB;AADc,OAA5B,CAFJ,EAMG6C,IANH;AAOD;;;+BAEUjC,E,EAAI;AACb,UAAMkC,OAAO,GAAG,KAAKC,UAAL,EAAhB;AAEA,UAAM7B,GAAG,GAAG,IAAI8B,YAAJ,CAAUpC,EAAV;AACVqC,QAAAA,EAAE,YAAK,KAAKV,KAAL,CAAWU,EAAhB;AADQ,SAEPH,OAFO;AAGVI,QAAAA,WAAW,EAAE,KAAKrC,OAAL,CAAaqC,WAHhB;AAIVC,QAAAA,QAAQ,EAAE,IAAIC,mBAAJ,EAJA;AAKVC,QAAAA,WAAW,EAAE,IALH;AAMVf,QAAAA,QAAQ,EAAE;AACRgB,UAAAA,cAAc,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CADR;AAERC,UAAAA,gBAAgB,EAAE;AAFV;AANA,SAAZ;AAYA,UAAMpC,MAAM,GAAG,IAAI6B,YAAJ,CAAUpC,EAAV;AACbqC,QAAAA,EAAE,YAAK,KAAKV,KAAL,CAAWU,EAAhB;AADW,SAEVH,OAFU;AAGbI,QAAAA,WAAW,EAAE,KAAKrC,OAAL,CAAaqC,WAHb;AAIbC,QAAAA,QAAQ,EAAE,IAAIK,qBAAJ,EAJG;AAKbH,QAAAA,WAAW,EAAE,IALA;AAMbf,QAAAA,QAAQ,EAAE;AACRmB,UAAAA,iBAAiB,EAAE,8CAAsB7C,EAAtB,CADX;AAER0C,UAAAA,cAAc,EAAE,CAAC,CAAC,GAAF,EAAO,CAAP,EAAU,CAAV,CAFR;AAGRC,UAAAA,gBAAgB,EAAE;AAHV;AANG,SAAf;AAaA,aAAO;AAACrC,QAAAA,GAAG,EAAHA,GAAD;AAAMC,QAAAA,MAAM,EAANA;AAAN,OAAP;AACD;;;qCAEgBuC,iB,EAAmB;AAClC,gIAAuBA,iBAAvB;;AADkC,iDAGd,KAAKC,SAAL,EAHc;AAAA;;AAAA;AAGlC,4DAAsC;AAAA,cAA3BC,KAA2B;AACpCA,UAAAA,KAAK,CAACC,gBAAN,CAAuB,KAAKtB,KAAL,CAAWuB,IAAX,CAAgBC,MAAvC;AACAH,UAAAA,KAAK,CAACI,aAAN,CAAoBN,iBAApB;AACD;AANiC;AAAA;AAAA;AAAA;AAAA;AAOnC;;;EAtG4CO,W;;;AAyG/C5D,iBAAiB,CAAC6D,SAAlB,GAA8B,mBAA9B;AACA7D,iBAAiB,CAACf,YAAlB,GAAiCA,YAAjC","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer, project32, gouraudLighting, picking} from '@deck.gl/core';\nimport {CubeGeometry, SphereGeometry, Model} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\n\nimport vs from './traffic-light-layer-vertex.glsl';\nimport fs from './traffic-light-layer-fragment.glsl';\n\nimport {makeLightShapeTexture} from './traffic-light-utils';\n\nconst LIGHT_COLOR = {\n  invalid: [0, 0, 0],\n  green: [0, 255, 128],\n  yellow: [255, 250, 0],\n  red: [255, 16, 16]\n};\n\n/* eslint-disable camelcase */\nconst LIGHT_SHAPE = {\n  circular: 0,\n  left_arrow: 1,\n  right_arrow: 2\n};\n/* eslint-enable camelcase */\n\nconst defaultProps = {\n  getPosition: {type: 'accessor', value: x => x.position},\n  getAngle: {type: 'accessor', value: 0},\n  getShape: {type: 'accessor', value: x => 'circular'},\n  getColor: {type: 'accessor', value: x => 'green'},\n  getState: {type: 'accessor', value: 1},\n\n  sizeScale: {type: 'number', value: 0.15, min: 0},\n\n  material: {\n    shininess: 0,\n    specularColor: [0, 0, 0]\n  }\n};\n\nexport default class TrafficLightLayer extends Layer {\n  getShaders() {\n    return {vs, fs, modules: [project32, gouraudLighting, picking]};\n  }\n\n  initializeState() {\n    const {gl} = this.context;\n    const modelsByName = this._getModels(gl);\n    this.setState({\n      models: [modelsByName.box, modelsByName.lights],\n      modelsByName\n    });\n\n    const attributeManager = this.getAttributeManager();\n    /* eslint-disable max-len */\n    attributeManager.addInstanced({\n      instancePositions: {\n        size: 3,\n        type: GL.DOUBLE,\n        fp64: this.use64bitPositions(),\n        accessor: 'getPosition'\n      },\n      instanceAngles: {size: 1, accessor: 'getAngle'},\n      instanceShapes: {\n        size: 1,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getShape',\n        transform: shape => LIGHT_SHAPE[shape] || 0\n      },\n      instanceColors: {\n        size: 3,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getColor',\n        transform: color => LIGHT_COLOR[color] || LIGHT_COLOR.invalid\n      },\n      instanceStates: {\n        size: 1,\n        type: GL.UNSIGNED_BYTE,\n        accessor: 'getState'\n      }\n    });\n    /* eslint-enable max-len */\n  }\n\n  draw({uniforms}) {\n    const {sizeScale} = this.props;\n    const {modelsByName} = this.state;\n\n    modelsByName.box\n      .setUniforms(\n        Object.assign({}, uniforms, {\n          modelScale: [sizeScale * 0.8, sizeScale * 1.6, sizeScale * 1.6]\n        })\n      )\n      .draw();\n    modelsByName.lights\n      .setUniforms(\n        Object.assign({}, uniforms, {\n          modelScale: [sizeScale, sizeScale, sizeScale]\n        })\n      )\n      .draw();\n  }\n\n  _getModels(gl) {\n    const shaders = this.getShaders();\n\n    const box = new Model(gl, {\n      id: `${this.props.id}-box`,\n      ...shaders,\n      shaderCache: this.context.shaderCache,\n      geometry: new CubeGeometry(),\n      isInstanced: true,\n      uniforms: {\n        modelTranslate: [0, 0, 0],\n        useInstanceColor: false\n      }\n    });\n\n    const lights = new Model(gl, {\n      id: `${this.props.id}-light`,\n      ...shaders,\n      shaderCache: this.context.shaderCache,\n      geometry: new SphereGeometry(),\n      isInstanced: true,\n      uniforms: {\n        lightShapeTexture: makeLightShapeTexture(gl),\n        modelTranslate: [-0.4, 0, 0],\n        useInstanceColor: true\n      }\n    });\n\n    return {box, lights};\n  }\n\n  updateAttributes(changedAttributes) {\n    super.updateAttributes(changedAttributes);\n\n    for (const model of this.getModels()) {\n      model.setInstanceCount(this.props.data.length);\n      model.setAttributes(changedAttributes);\n    }\n  }\n}\n\nTrafficLightLayer.layerName = 'TrafficLightLayer';\nTrafficLightLayer.defaultProps = defaultProps;\n"],"file":"traffic-light-layer.js"}