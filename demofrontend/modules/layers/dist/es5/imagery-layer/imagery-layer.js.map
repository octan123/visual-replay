{"version":3,"sources":["../../../src/imagery-layer/imagery-layer.js"],"names":["getTexture","gl","src","then","data","getTextureFromData","error","Error","Promise","resolve","Texture2D","parameters","TEXTURE_MIN_FILTER","LINEAR_MIPMAP_LINEAR","TEXTURE_MAG_FILTER","LINEAR","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","defaultProps","heightMap","heightMapBounds","type","value","compare","heightRange","imagery","imageryBounds","uCount","min","vCount","desaturate","max","transparentColor","tintColor","ImageryLayer","context","getExtension","setState","model","getModel","props","oldProps","changeFlags","state","texture","setUniforms","heightMapTexture","hasHeightMap","imageLoaded","imageryTexture","geometry","GridGeometry","setGeometry","propsChanged","opts","draw","Model","id","vs","IMAGERY_VERTEX_SHADER","fs","IMAGERY_FRAGMENT_SHADER","modules","picking","project32","shaderCache","vertexCount","isIndexed","Layer","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer, picking, project32} from '@deck.gl/core';\nimport {Model, Texture2D} from '@luma.gl/core';\nimport {loadImage} from '@loaders.gl/images';\n\nimport IMAGERY_VERTEX_SHADER from './imagery-layer-vertex';\nimport IMAGERY_FRAGMENT_SHADER from './imagery-layer-fragment';\n\nimport GridGeometry from './grid-geometry';\n\n/*\n * Load image data into luma.gl Texture2D objects\n * @param {WebGLContext} gl\n * @param {String|Texture2D|HTMLImageElement|Uint8ClampedArray} src - source of image data\n *   can be url string, Texture2D object, HTMLImageElement or pixel array\n * @returns {Promise} resolves to an object with name -> texture mapping\n */\nfunction getTexture(gl, src) {\n  if (typeof src === 'string') {\n    // Url, load the image\n    return loadImage(src)\n      .then(data => getTextureFromData(gl, data))\n      .catch(error => {\n        throw new Error(`Could not load texture from ${src}: ${error}`);\n      });\n  }\n  return new Promise(resolve => resolve(getTextureFromData(gl, src)));\n}\n\n/*\n * Convert image data into texture\n * @returns {Texture2D} texture\n */\nfunction getTextureFromData(gl, data) {\n  if (data instanceof Texture2D) {\n    return data;\n  }\n  return new Texture2D(gl, {\n    data,\n    parameters: {\n      [gl.TEXTURE_MIN_FILTER]: gl.LINEAR_MIPMAP_LINEAR,\n      // GL.LINEAR is the default value but explicitly set it here\n      [gl.TEXTURE_MAG_FILTER]: gl.LINEAR,\n      [gl.TEXTURE_WRAP_S]: gl.CLAMP_TO_EDGE,\n      [gl.TEXTURE_WRAP_T]: gl.CLAMP_TO_EDGE\n    }\n  });\n}\n\nconst defaultProps = {\n  heightMap: null,\n  heightMapBounds: {type: 'array', value: [0, 0, 1, 1], compare: true},\n  heightRange: {type: 'array', value: [0, 1], compare: true},\n  imagery: null,\n  imageryBounds: {type: 'array', value: [0, 0, 1, 1], compare: true},\n  uCount: {type: 'number', value: 1, min: 1},\n  vCount: {type: 'number', value: 1, min: 1},\n  desaturate: {type: 'number', value: 0, min: 0, max: 1},\n  // More context: because of the blending mode we're using for ground imagery,\n  // alpha is not effective when blending the bitmap layers with the base map.\n  // Instead we need to manually dim/blend rgb values with a background color.\n  transparentColor: {type: 'color', value: [0, 0, 0, 0]},\n  tintColor: {type: 'color', value: [255, 255, 255]}\n};\n\n/*\n * @class\n * @param {object} props\n * @param {number} props.transparentColor - color to interpret transparency to\n * @param {number} props.tintColor - color bias\n */\nexport default class ImageryLayer extends Layer {\n  initializeState() {\n    const {gl} = this.context;\n    // TODO/ib - Enabled to allow debugging of heightmaps, not perfect but really helps\n    gl.getExtension('OES_standard_derivatives');\n    this.setState({model: this.getModel(gl)});\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    const {gl} = this.context;\n    const {model} = this.state;\n\n    const {heightMap, imagery, uCount, vCount} = props;\n    if (heightMap && heightMap !== oldProps.heightMap) {\n      getTexture(gl, heightMap).then(texture => {\n        model.setUniforms({heightMapTexture: texture, hasHeightMap: true});\n      });\n    }\n    if (imagery !== oldProps.imagery) {\n      this.setState({imageLoaded: false});\n      getTexture(gl, imagery).then(texture => {\n        this.setState({imageLoaded: true});\n        model.setUniforms({imageryTexture: texture});\n      });\n    }\n    if (uCount !== oldProps.uCount || vCount !== oldProps.vCount) {\n      const geometry = new GridGeometry({uCount, vCount});\n      model.setGeometry(geometry);\n    }\n    if (changeFlags.propsChanged) {\n      const {\n        heightMapBounds,\n        heightRange,\n        imageryBounds,\n        desaturate,\n        transparentColor,\n        tintColor\n      } = props;\n      model.setUniforms({\n        heightMapBounds,\n        heightRange,\n        imageryBounds,\n        desaturate,\n        transparentColor,\n        tintColor\n      });\n    }\n  }\n\n  draw(opts) {\n    if (this.state.imageLoaded) {\n      this.state.model.draw(opts);\n    }\n  }\n\n  getModel(gl) {\n    // 3d surface\n    return new Model(gl, {\n      id: this.props.id,\n      vs: IMAGERY_VERTEX_SHADER,\n      fs: IMAGERY_FRAGMENT_SHADER,\n      modules: [picking, project32],\n      shaderCache: this.context.shaderCache,\n      vertexCount: 0,\n      isIndexed: true\n    });\n  }\n}\n\nImageryLayer.layerName = 'ImageryLayer';\nImageryLayer.defaultProps = defaultProps;\n"],"file":"imagery-layer.js"}