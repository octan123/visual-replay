{"version":3,"sources":["../../../src/utils/viewport.js"],"names":["WebMercatorViewport","MapView","FirstPersonView","getViewStateOffset","oldViewState","viewState","oldOffset","oldViewport","oldPos","width","x","height","y","trackedLngLat","unproject","newViewport","newPos","project","bearing","offsetViewState","offset","shiftedViewState","helperViewport","pos","lngLat","longitude","latitude","getLocationAtPoint","getViews","viewMode","options","name","orthographic","firstPerson","mapInteraction","controllerProps","keyboard","id","fovy","near","far","focalDistance","controller","getViewStates","trackedPosition","tracked","viewStates","position","altitude","transitionDuration","heading"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport WebMercatorViewport from 'viewport-mercator-project';\nimport {MapView, FirstPersonView} from '@deck.gl/core';\n\nexport function getViewStateOffset(oldViewState, viewState, oldOffset) {\n  if (!oldViewState) {\n    return oldOffset;\n  }\n\n  const oldViewport = new WebMercatorViewport(oldViewState);\n  const oldPos = [oldViewport.width / 2 + oldOffset.x, oldViewport.height / 2 + oldOffset.y];\n  const trackedLngLat = oldViewport.unproject(oldPos);\n\n  const newViewport = new WebMercatorViewport(viewState);\n  const newPos = newViewport.project(trackedLngLat);\n\n  return {\n    x: oldOffset.x + newPos[0] - oldPos[0],\n    y: oldOffset.y + newPos[1] - oldPos[1],\n    bearing: oldOffset.bearing + viewState.bearing - oldViewState.bearing\n  };\n}\n\n// Adjust lng/lat to position the car 1/4 from screen bottom\nfunction offsetViewState(viewState, offset) {\n  const shiftedViewState = {\n    ...viewState,\n    bearing: viewState.bearing + offset.bearing\n  };\n\n  const helperViewport = new WebMercatorViewport(shiftedViewState);\n\n  const pos = [viewState.width / 2 + offset.x, viewState.height / 2 + offset.y];\n  const lngLat = [viewState.longitude, viewState.latitude];\n\n  const [longitude, latitude] = helperViewport.getLocationAtPoint({\n    lngLat,\n    pos\n  });\n\n  return {\n    ...shiftedViewState,\n    longitude,\n    latitude\n  };\n}\n\nexport function getViews(viewMode, options = {}) {\n  const {name, orthographic, firstPerson, mapInteraction} = viewMode;\n\n  const controllerProps = {...mapInteraction, keyboard: false};\n\n  if (firstPerson) {\n    return new FirstPersonView({\n      ...options,\n      id: name,\n      fovy: 75,\n      near: 1,\n      far: 10000,\n      focalDistance: 6,\n      controller: controllerProps\n    });\n  }\n\n  return new MapView({\n    ...options,\n    id: name,\n    orthographic,\n    controller: controllerProps\n  });\n}\n\n// Creates viewports that contains information about car position and heading\nexport function getViewStates({viewState, trackedPosition, viewMode, offset}) {\n  const {name, firstPerson, tracked = {}} = viewMode;\n\n  const viewStates = {};\n\n  if (firstPerson) {\n    if (trackedPosition) {\n      const bearing = trackedPosition.bearing;\n      viewState = {\n        ...viewState,\n        ...firstPerson,\n        longitude: trackedPosition.longitude,\n        latitude: trackedPosition.latitude,\n        bearing: bearing + offset.bearing\n      };\n\n      // Put the tracked object on the ground + 1.3 for vehicle height\n      // TODO - support flying vehicle\n      viewState.position = [0, 0, trackedPosition.altitude + 1.3];\n    }\n\n    viewStates[name] = viewState;\n  } else {\n    viewState = {...viewState, transitionDuration: 0};\n    offset = {...offset};\n\n    // Track car position & heading\n    if (tracked.position && trackedPosition) {\n      viewState.longitude = trackedPosition.longitude;\n      viewState.latitude = trackedPosition.latitude;\n    } else {\n      offset.x = 0;\n      offset.y = 0;\n    }\n    if (tracked.heading && trackedPosition) {\n      viewState.bearing = trackedPosition.bearing;\n    } else {\n      offset.bearing = 0;\n    }\n    // Put the tracked object on the ground\n    // TODO - support flying vehicle\n    if (trackedPosition) {\n      viewState.position = [0, 0, trackedPosition.altitude];\n    }\n\n    viewStates[name] = offsetViewState(viewState, offset);\n  }\n\n  return viewStates;\n}\n/* eslint-enable max-params */\n"],"file":"viewport.js"}