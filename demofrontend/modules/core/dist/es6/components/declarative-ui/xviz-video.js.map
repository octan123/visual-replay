{"version":3,"sources":["../../../../src/components/declarative-ui/xviz-video.js"],"names":["React","PureComponent","PropTypes","styled","Dropdown","withTheme","evaluateStyle","ImageSequence","connectToLog","normalizeStreamFilter","WrapperComponent","span","props","theme","__reset__","position","userStyle","BaseComponent","constructor","streamName","setState","selectedStreamName","state","_getStreamNames","componentWillReceiveProps","nextProps","streamsMetadata","cameras","streamNames","Object","keys","filter","type","primitive_type","sort","includes","_renderVideoSelector","style","length","data","forEach","name","selector","_onSelectVideo","render","currentTime","streams","width","height","images","Boolean","wrapper","object","oneOfType","number","string","array","func","getLogState","log","getCurrentTime","getStreamsMetadata","getStreams","XVIZVideoComponent","Component"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport styled from '@emotion/styled';\nimport {Dropdown, withTheme, evaluateStyle} from '@streetscape.gl/monochrome';\nimport ImageSequence from './image-sequence';\nimport connectToLog from '../connect';\n\nimport {normalizeStreamFilter} from '../../utils/stream-utils';\n\nconst WrapperComponent = styled.span(props => ({\n  ...props.theme.__reset__,\n  position: 'relative',\n  ...evaluateStyle(props.userStyle, props)\n}));\n\nclass BaseComponent extends PureComponent {\n  static propTypes = {\n    // User configuration\n    style: PropTypes.object,\n    width: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n    height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n\n    // From declarative UI video component\n    cameras: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.array,\n      PropTypes.object,\n      PropTypes.func\n    ]),\n\n    // From connected log\n    currentTime: PropTypes.number,\n    streamsMetadata: PropTypes.object,\n    streams: PropTypes.object\n  };\n\n  static defaultProps = {\n    style: {},\n    width: '100%',\n    height: 'auto'\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      ...this._getStreamNames(props)\n    };\n  }\n\n  componentWillReceiveProps(nextProps) {\n    if (\n      this.props.streamsMetadata !== nextProps.streamsMetadata ||\n      this.props.cameras !== nextProps.cameras\n    ) {\n      this.setState(this._getStreamNames(nextProps));\n    }\n  }\n\n  _getStreamNames({streamsMetadata, cameras}) {\n    const streamNames = Object.keys(streamsMetadata)\n      .filter(streamName => {\n        const type = streamsMetadata[streamName] && streamsMetadata[streamName].primitive_type;\n        return type === 'IMAGE' || type === 'image'; // Support pre-1.0 lowercase value\n      })\n      .filter(normalizeStreamFilter(cameras))\n      .sort();\n    let {selectedStreamName} = this.state || {};\n    if (!streamNames.includes(selectedStreamName)) {\n      selectedStreamName = streamNames[0] || null;\n    }\n    return {selectedStreamName, streamNames};\n  }\n\n  _onSelectVideo = streamName => {\n    this.setState({selectedStreamName: streamName});\n  };\n\n  _renderVideoSelector() {\n    const {style} = this.props;\n    const {streamNames, selectedStreamName} = this.state;\n\n    if (streamNames.length <= 1) {\n      return null;\n    }\n\n    const data = {};\n    streamNames.forEach(name => {\n      // TODO - use display name from metadata\n      data[name] = name;\n    });\n\n    return (\n      <Dropdown\n        style={style.selector}\n        value={selectedStreamName}\n        data={data}\n        onChange={this._onSelectVideo}\n      />\n    );\n  }\n\n  render() {\n    const {currentTime, streams, width, height, style, theme} = this.props;\n    const {selectedStreamName} = this.state;\n\n    if (!streams || !currentTime || !selectedStreamName) {\n      return null;\n    }\n    let images = streams[selectedStreamName];\n    if (images) {\n      images = images.filter(Boolean);\n    }\n\n    return (\n      <WrapperComponent theme={theme} userStyle={style.wrapper}>\n        <ImageSequence width={width} height={height} src={images} currentTime={currentTime} />\n\n        {this._renderVideoSelector()}\n      </WrapperComponent>\n    );\n  }\n}\n\nconst getLogState = log => ({\n  currentTime: log.getCurrentTime(),\n  streamsMetadata: log.getStreamsMetadata(),\n  streams: log.getStreams()\n});\n\nconst XVIZVideoComponent = withTheme(BaseComponent);\n\nexport default connectToLog({getLogState, Component: XVIZVideoComponent});\n"],"file":"xviz-video.js"}