{"version":3,"sources":["../../../../src/components/declarative-ui/image-sequence.js"],"names":["React","PureComponent","PropTypes","AutoSizer","ImageBuffer","ImageSequence","constructor","props","ref","_canvas","_context","getContext","width","height","setState","brightness","contrast","saturate","invert","filter","Number","isFinite","state","_getVideoFilterCSS","currentFrameImage","clearRect","drawImage","_buffer","_getCurrentFrames","componentDidMount","_renderFrame","componentWillReceiveProps","nextProps","componentDidUpdate","prevProps","prevState","currentFrameImagePending","currentTime","src","currentFrame","set","currentFrameData","get","image","promise","then","render","style","position","background","lineHeight","_onCanvasResize","_onCanvasLoad","oneOfType","number","string","array","isRequired"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n// @flow\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\nimport {AutoSizer} from '@streetscape.gl/monochrome';\nimport ImageBuffer from '../../utils/image-buffer';\n\n/* Component that renders image sequence as video */\nexport default class ImageSequence extends PureComponent {\n  static propTypes = {\n    width: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n    height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n\n    // Array of frames to render, in shape of {timestamp, imageUrl}\n    src: PropTypes.array, // eslint-disable-line\n\n    // Filters\n    brightness: PropTypes.number,\n    contrast: PropTypes.number,\n    saturate: PropTypes.number,\n    invert: PropTypes.number,\n\n    currentTime: PropTypes.number.isRequired\n  };\n\n  static defaultProps = {\n    width: '100%',\n    height: 'auto',\n    // brightness: 1.0,\n    // contrast: 1.0,\n    // saturate: 1.0,\n    // invert: 0.0,\n    src: []\n  };\n\n  constructor(props) {\n    super(props);\n\n    this._buffer = new ImageBuffer(10);\n\n    this.state = {\n      width: 0,\n      height: 0,\n      ...this._getCurrentFrames(props)\n    };\n\n    this._canvas = null;\n    this._context = null;\n  }\n\n  componentDidMount() {\n    this._renderFrame();\n  }\n\n  componentWillReceiveProps(nextProps) {\n    this.setState({\n      ...this._getCurrentFrames(nextProps)\n    });\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (\n      (this.state.currentFrameImage !== prevState.currentFrameImage &&\n        !this.state.currentFrameImagePending) ||\n      this.state.width !== prevState.width ||\n      this.state.height !== prevState.height\n    ) {\n      this._renderFrame();\n    }\n  }\n\n  _onCanvasLoad = ref => {\n    this._canvas = ref;\n\n    if (ref) {\n      this._context = ref.getContext('2d');\n    }\n  };\n\n  _onCanvasResize = ({width, height}) => {\n    this.setState({width, height});\n  };\n\n  _getCurrentFrames(props) {\n    const {currentTime, src} = props;\n\n    const currentFrame = this._buffer.set(src, currentTime);\n    const currentFrameData = this._buffer.get(currentFrame);\n\n    if (currentFrameData && !currentFrameData.image) {\n      currentFrameData.promise.then(image => {\n        if (this.state.currentFrame === currentFrame) {\n          this.setState({\n            currentFrameImagePending: false,\n            currentFrameImage: image\n          });\n        }\n      });\n    }\n\n    return {\n      currentFrameImage: currentFrameData && currentFrameData.image,\n      currentFrameImagePending: currentFrameData && !currentFrameData.image && true,\n      currentFrame\n    };\n  }\n\n  _getVideoFilterCSS = () => {\n    const {brightness, contrast, saturate, invert} = this.props;\n    const filter = `\\\n      ${Number.isFinite(brightness) ? `brightness(${brightness}) ` : ''}\\\n      ${Number.isFinite(saturate) ? `saturate(${saturate}) ` : ''}\\\n      ${Number.isFinite(contrast) ? `contrast(${contrast}) ` : ''}\\\n      ${Number.isFinite(invert) ? `invert(${invert}) ` : ''}`;\n    return filter;\n  };\n\n  _renderFrame = () => {\n    if (!this._context) {\n      return;\n    }\n\n    const width = this.state.width;\n    let height = this.state.height;\n\n    if (!width) {\n      return;\n    }\n\n    this._context.filter = this._getVideoFilterCSS();\n\n    const {currentFrameImage} = this.state;\n    if (!currentFrameImage) {\n      this._context.clearRect(0, 0, width, height);\n    } else {\n      if (this.props.height === 'auto') {\n        height = (width / currentFrameImage.width) * currentFrameImage.height;\n      }\n      this._canvas.width = width;\n      this._canvas.height = height;\n      this._context.drawImage(currentFrameImage, 0, 0, width, height);\n    }\n  };\n\n  render() {\n    const {width, height} = this.props;\n    const style = {\n      position: 'relative',\n      background: '#000',\n      lineHeight: 0,\n      width,\n      height\n    };\n\n    return (\n      <div style={style}>\n        <AutoSizer onResize={this._onCanvasResize} />\n        <canvas ref={this._onCanvasLoad} />\n      </div>\n    );\n  }\n}\n"],"file":"image-sequence.js"}