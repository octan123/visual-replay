{"version":3,"sources":["../../../../src/components/log-viewer/core-3d-viewer.js"],"names":["React","PureComponent","PropTypes","StaticMap","DeckGL","COORDINATE_SYSTEM","_MapContext","MapContext","ObjectLabelsOverlay","SimpleMeshLayer","XVIZStyleParser","XVIZLayer","VIEW_MODE","DEFAULT_VIEW_STATE","getViewStateOffset","getViews","getViewStates","resolveCoordinateTransform","mergeXVIZStyles","normalizeStreamFilter","stats","memoize","DEFAULT_ORIGIN","CAR_DATA","LIGHTS","DEFAULT_CAR","noop","Z_INDEX","car","point","polygon","customDefault","Core3DViewer","constructor","props","createRef","evt","map","target","onMapLoad","deck","deckRef","current","onDeckLoad","deckMetrics","debug","metrics","Object","assign","table","getTable","key","count","reset","viewState","oldViewState","viewOffset","onViewStateChange","info","objectId","object","id","isHovering","Boolean","onHover","isRightClick","which","onContextMenu","onClick","layer","viewport","isPicking","showTooltip","startsWith","sampleData","data","state","styleParser","_getStyleParser","views","viewMode","viewOptions","getLayers","_getLayers","bind","getViewState","_getViewState","componentWillReceiveProps","nextProps","initialViewState","x","y","bearing","setState","metadata","xvizStyles","frame","get","incrementCount","styles","_getCarLayer","origin","mesh","scale","wireframe","texture","color","opacity","coordinateSystem","METER_OFFSETS","coordinateOrigin","getTransformMatrix","d","vehicleRelativeTransform","clone","translate","pickable","getPosition","getColor","updateTriggers","zIndex","opts","streamsMetadata","objectStates","customLayers","customXVIZLayers","streams","lookAheads","streamFilter","featuresAndFutures","Set","keys","concat","filter","layerList","Array","from","streamName","stream","coordinateProps","stylesheet","getStylesheet","primitives","features","length","style","type","streamMetadata","additionalProps","coordinate","sort","layer1","layer2","trackedPosition","longitude","trackPosition","latitude","altitude","heading","offset","render","mapboxApiAccessToken","renderObjectLabel","mapStyle","showMap","layers","viewStates","_layerFilter","_getCursor","_onDeckLoad","_onLayerHover","_onLayerClick","_onViewStateChange","Provider","_onMetrics","firstPerson","_onMapLoad","selected","children","bool","string","oneOfType","array","func","PERSPECTIVE"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {StaticMap} from 'react-map-gl';\nimport DeckGL from '@deck.gl/react';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\nimport {_MapContext as MapContext} from 'react-map-gl';\n\nimport ObjectLabelsOverlay from './object-labels-overlay';\n\nimport {SimpleMeshLayer} from '@deck.gl/mesh-layers';\nimport {XVIZStyleParser} from '@xviz/parser';\n\nimport XVIZLayer from '../../layers/xviz-layer';\n\nimport {VIEW_MODE, DEFAULT_VIEW_STATE} from '../../constants';\nimport {getViewStateOffset, getViews, getViewStates} from '../../utils/viewport';\nimport {resolveCoordinateTransform} from '../../utils/transform';\nimport {mergeXVIZStyles} from '../../utils/style';\nimport {normalizeStreamFilter} from '../../utils/stream-utils';\nimport stats from '../../utils/stats';\nimport memoize from '../../utils/memoize';\n\nimport {DEFAULT_ORIGIN, CAR_DATA, LIGHTS, DEFAULT_CAR} from './constants';\n\nconst noop = () => {};\n\nconst Z_INDEX = {\n  car: 0,\n  point: 1,\n  polygon: 2,\n  customDefault: 3\n};\n\nexport default class Core3DViewer extends PureComponent {\n  static propTypes = {\n    // Props from loader\n    frame: PropTypes.object,\n    metadata: PropTypes.object,\n    streamsMetadata: PropTypes.object,\n\n    // Rendering options\n    showMap: PropTypes.bool,\n    showTooltip: PropTypes.bool,\n    mapboxApiAccessToken: PropTypes.string,\n    mapStyle: PropTypes.oneOfType([PropTypes.object, PropTypes.string]),\n    xvizStyles: PropTypes.object,\n    car: PropTypes.object,\n    viewMode: PropTypes.object,\n    streamFilter: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.array,\n      PropTypes.object,\n      PropTypes.func\n    ]),\n    customLayers: PropTypes.array,\n    customXVIZLayers: PropTypes.array,\n    renderObjectLabel: PropTypes.func,\n    getTransformMatrix: PropTypes.func,\n    viewOptions: PropTypes.object,\n\n    // Callbacks\n    onMapLoad: PropTypes.func,\n    onDeckLoad: PropTypes.func,\n    onHover: PropTypes.func,\n    onClick: PropTypes.func,\n    onContextMenu: PropTypes.func,\n    onViewStateChange: PropTypes.func,\n\n    // Debug info listener\n    debug: PropTypes.func,\n\n    // States\n    viewState: PropTypes.object,\n    viewOffset: PropTypes.object,\n    objectStates: PropTypes.object\n  };\n\n  static defaultProps = {\n    car: DEFAULT_CAR,\n    viewMode: VIEW_MODE.PERSPECTIVE,\n    xvizStyles: {},\n    customLayers: [],\n    customXVIZLayers: [],\n    onMapLoad: noop,\n    onDeckLoad: noop,\n    onViewStateChange: noop,\n    onHover: noop,\n    onClick: noop,\n    onContextMenu: noop,\n    showMap: true,\n    showTooltip: false\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      styleParser: this._getStyleParser(props),\n      views: getViews(props.viewMode, props.viewOptions)\n    };\n\n    this.getLayers = memoize(this._getLayers.bind(this));\n    this.getViewState = memoize(this._getViewState);\n  }\n\n  deckRef = React.createRef();\n\n  componentWillReceiveProps(nextProps) {\n    if (this.props.viewMode !== nextProps.viewMode) {\n      const viewState = {\n        ...this.props.viewState,\n        ...DEFAULT_VIEW_STATE,\n        ...nextProps.viewMode.initialViewState\n      };\n      // Reset offset\n      const viewOffset = {\n        x: 0,\n        y: 0,\n        bearing: 0\n      };\n\n      nextProps.onViewStateChange({viewState, viewOffset});\n      this.setState({\n        views: getViews(nextProps.viewMode, nextProps.viewOptions)\n      });\n    }\n    if (\n      this.props.metadata !== nextProps.metadata ||\n      this.props.xvizStyles !== nextProps.xvizStyles\n    ) {\n      this.setState({\n        styleParser: this._getStyleParser(nextProps)\n      });\n    }\n    if (this.props.frame !== nextProps.frame) {\n      stats.get('frame-update').incrementCount();\n    }\n  }\n\n  _onMapLoad = evt => {\n    const map = evt.target;\n    this.props.onMapLoad(map);\n  };\n\n  _onDeckLoad = () => {\n    const deck = this.deckRef.current.deck;\n    this.props.onDeckLoad(deck);\n  };\n\n  _onMetrics = deckMetrics => {\n    if (this.props.debug) {\n      const metrics = Object.assign({}, deckMetrics);\n      const table = stats.getTable();\n\n      for (const key in table) {\n        metrics[key] = table[key].count;\n      }\n      this.props.debug(metrics);\n    }\n    stats.reset();\n  };\n\n  _onViewStateChange = ({viewState, oldViewState}) => {\n    const viewOffset = getViewStateOffset(oldViewState, viewState, this.props.viewOffset);\n    this.props.onViewStateChange({viewState, viewOffset});\n  };\n\n  _onLayerHover = (info, evt) => {\n    const objectId = info && info.object && info.object.id;\n    this.isHovering = Boolean(objectId);\n    this.props.onHover(info, evt);\n  };\n\n  _onLayerClick = (info, evt) => {\n    const isRightClick = evt.which === 3;\n\n    if (isRightClick) {\n      this.props.onContextMenu(info, evt);\n    } else {\n      this.props.onClick(info, evt);\n    }\n  };\n\n  _getStyleParser({metadata, xvizStyles}) {\n    return new XVIZStyleParser(mergeXVIZStyles(metadata && metadata.styles, xvizStyles));\n  }\n\n  _getCarLayer({frame, car}) {\n    const {\n      origin = DEFAULT_ORIGIN,\n      mesh,\n      scale = [1, 1, 1],\n      wireframe = false,\n      texture = null,\n      color = [0, 0, 0]\n    } = car;\n\n    return new SimpleMeshLayer({\n      id: 'car',\n      opacity: 1,\n      coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n      coordinateOrigin: frame.origin || DEFAULT_ORIGIN,\n      // Adjust for car center position relative to GPS/IMU\n      getTransformMatrix: d =>\n        frame.vehicleRelativeTransform\n          .clone()\n          .translate(origin)\n          .scale(scale),\n      mesh,\n      data: CAR_DATA,\n      pickable: true,\n      getPosition: d => d,\n      getColor: color,\n      texture,\n      wireframe,\n      updateTriggers: {\n        getTransformMatrix: frame.vehicleRelativeTransform\n      },\n      zIndex: Z_INDEX.car\n    });\n  }\n\n  _getLayers(opts) {\n    const {\n      frame,\n      streamsMetadata,\n      objectStates,\n      customLayers,\n      customXVIZLayers,\n      getTransformMatrix,\n      styleParser\n    } = opts;\n    if (!frame) {\n      return [];\n    }\n\n    const {streams, lookAheads = {}} = frame;\n\n    const streamFilter = normalizeStreamFilter(opts.streamFilter);\n    const featuresAndFutures = new Set(\n      Object.keys(streams)\n        .concat(Object.keys(lookAheads))\n        .filter(streamFilter)\n    );\n\n    let layerList = [this._getCarLayer(opts)];\n\n    layerList = layerList.concat(\n      Array.from(featuresAndFutures)\n        .map(streamName => {\n          // Check lookAheads first because it will contain the selected futures\n          // while streams would contain the full futures array\n          const stream = lookAheads[streamName] || streams[streamName];\n          const coordinateProps = resolveCoordinateTransform(\n            frame,\n            streamName,\n            streamsMetadata[streamName],\n            getTransformMatrix\n          );\n\n          const stylesheet = styleParser.getStylesheet(streamName);\n\n          // Support both features and lookAheads, respectively\n          const primitives = stream.features || stream;\n          if (primitives && primitives.length) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: true,\n              data: primitives,\n              style: stylesheet,\n              objectStates,\n              vehicleRelativeTransform: frame.vehicleRelativeTransform,\n\n              // Hack: draw extruded polygons last to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: Z_INDEX[primitives[0].type] || 0,\n\n              // Selection props (app defined, not used by deck.gl)\n              streamName,\n              streamMetadata: streamsMetadata[streamName],\n              customXVIZLayers\n            });\n          }\n          return null;\n        })\n        .filter(Boolean)\n    );\n\n    layerList = layerList.concat(\n      customLayers.map(layer => {\n        // Clone layer props\n        const {props} = layer;\n        const additionalProps = {\n          zIndex: 'zIndex' in props ? props.zIndex : Z_INDEX.customDefault\n        };\n\n        if (props.streamName) {\n          // Use log data\n          const stream = streams[props.streamName];\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(\n              frame,\n              props.streamName,\n              streamsMetadata[props.streamName],\n              getTransformMatrix\n            ),\n            {\n              data: stream && stream.features\n            }\n          );\n        } else if (props.coordinate) {\n          // Apply log-specific coordinate props\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, null, props, getTransformMatrix)\n          );\n        } else {\n          return layer;\n        }\n\n        return layer.clone(additionalProps);\n      })\n    );\n\n    // Sort layers by zIndex to avoid depth test issues\n    return layerList.sort(\n      (layer1, layer2) => (layer1.props.zIndex || 0) - (layer2.props.zIndex || 0)\n    );\n  }\n\n  _layerFilter = ({layer, viewport, isPicking}) => {\n    if (viewport.id === 'driver' && layer.id === 'car') {\n      return false;\n    }\n    if (isPicking) {\n      if (this.props.showTooltip) {\n        return true;\n      }\n      if (layer.id.startsWith('xviz-')) {\n        const sampleData = layer.props.data[0];\n        return sampleData && sampleData.id;\n      }\n    }\n    return true;\n  };\n\n  _getCursor = () => {\n    return this.isHovering ? 'pointer' : 'crosshair';\n  };\n\n  _getViewState({viewMode, frame, viewState, viewOffset}) {\n    const trackedPosition = frame\n      ? {\n          longitude: frame.trackPosition[0],\n          latitude: frame.trackPosition[1],\n          altitude: frame.trackPosition[2],\n          bearing: 90 - frame.heading\n        }\n      : null;\n\n    return getViewStates({viewState, viewMode, trackedPosition, offset: viewOffset});\n  }\n\n  render() {\n    const {\n      mapboxApiAccessToken,\n      frame,\n      car,\n      streamsMetadata,\n      streamFilter,\n      objectStates,\n      renderObjectLabel,\n      customLayers,\n      getTransformMatrix,\n      style,\n      mapStyle,\n      viewMode,\n      viewState,\n      viewOffset,\n      showMap,\n      customXVIZLayers\n    } = this.props;\n    const {styleParser, views} = this.state;\n    const layers = this.getLayers({\n      frame,\n      car,\n      streamsMetadata,\n      streamFilter,\n      objectStates,\n      customLayers,\n      getTransformMatrix,\n      styleParser,\n      customXVIZLayers\n    });\n    const viewStates = this.getViewState({viewMode, frame, viewState, viewOffset});\n\n    return (\n      <DeckGL\n        width=\"100%\"\n        height=\"100%\"\n        ref={this.deckRef}\n        effects={[LIGHTS]}\n        views={views}\n        viewState={viewStates}\n        layers={layers}\n        layerFilter={this._layerFilter}\n        getCursor={this._getCursor}\n        onLoad={this._onDeckLoad}\n        onHover={this._onLayerHover}\n        onClick={this._onLayerClick}\n        onViewStateChange={this._onViewStateChange}\n        ContextProvider={MapContext.Provider}\n        _onMetrics={this._onMetrics}\n      >\n        {showMap && (\n          <StaticMap\n            reuseMap={true}\n            attributionControl={false}\n            mapboxApiAccessToken={mapboxApiAccessToken}\n            mapStyle={mapStyle}\n            visible={frame && frame.origin && !viewMode.firstPerson}\n            onLoad={this._onMapLoad}\n          />\n        )}\n\n        <ObjectLabelsOverlay\n          objectSelection={objectStates.selected}\n          frame={frame}\n          streamsMetadata={streamsMetadata}\n          renderObjectLabel={renderObjectLabel}\n          xvizStyleParser={styleParser}\n          style={style}\n          getTransformMatrix={getTransformMatrix}\n        />\n\n        {this.props.children}\n      </DeckGL>\n    );\n  }\n}\n"],"file":"core-3d-viewer.js"}