{"version":3,"sources":["../../../src/loaders/loader-interface.js"],"names":["LoaderInterface","_updateTimer","listeners","forEach","o","_version","get","state","_updates","instance","push","index","findIndex","splice","key","value","requestAnimationFrame","_update","set"],"mappings":";;;;;;;;;;;;;;;IA2DqBA,e;AACnB,6BAAc;AAAA;;AAAA;AAAA,sDAkCJ,YAAM;AACd,MAAA,KAAI,CAACC,YAAL,GAAoB,IAApB;;AACA,MAAA,KAAI,CAACC,SAAL,CAAeC,OAAf,CAAuB,UAAAC,CAAC;AAAA,eAAIA,CAAC,CAAC,KAAI,CAACC,QAAN,CAAL;AAAA,OAAxB;AACD,KArCa;AAAA,8DA4CI;AAAA,aAAM,KAAI,CAACC,GAAL,CAAS,aAAT,CAAN;AAAA,KA5CJ;AACZ,SAAKJ,SAAL,GAAiB,EAAjB;AACA,SAAKK,KAAL,GAAa,EAAb;AACA,SAAKC,QAAL,GAAgB,CAAhB;AACA,SAAKH,QAAL,GAAgB,CAAhB;AACA,SAAKJ,YAAL,GAAoB,IAApB;AACD;;;;8BAESQ,Q,EAAU;AAClB,WAAKP,SAAL,CAAeQ,IAAf,CAAoBD,QAApB;AACD;;;gCAEWA,Q,EAAU;AACpB,UAAME,KAAK,GAAG,KAAKT,SAAL,CAAeU,SAAf,CAAyB,UAAAR,CAAC;AAAA,eAAIA,CAAC,KAAKK,QAAV;AAAA,OAA1B,CAAd;;AACA,UAAIE,KAAK,IAAI,CAAb,EAAgB;AACd,aAAKT,SAAL,CAAeW,MAAf,CAAsBF,KAAtB,EAA6B,CAA7B;AACD;AACF;;;wBAEGG,G,EAAK;AACP,aAAO,KAAKP,KAAL,CAAWO,GAAX,CAAP;AACD;;;wBAEGA,G,EAAKC,K,EAAO;AACd,UAAI,KAAKR,KAAL,CAAWO,GAAX,MAAoBC,KAAxB,EAA+B;AAC7B,aAAKR,KAAL,CAAWO,GAAX,IAAkBC,KAAlB;AACA,aAAKV,QAAL;;AACA,YAAI,CAAC,KAAKJ,YAAV,EAAwB;AAEtB,eAAKA,YAAL,GAAoBe,qBAAqB,CAAC,KAAKC,OAAN,CAAzC;AACD;AACF;AACF;;;uCAOkB;AACjB,WAAKT,QAAL;AACA,WAAKU,GAAL,CAAS,aAAT,EAAwB,KAAKV,QAA7B;AACD","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/**\n * This class defines the interface for Loader classes. A Loader is factually\n * a store holding state for connected components. We call the subclasses of this\n * interface \"Loaders\" and not simply \"Stores\" because they are is usually also\n * responsible for loading data in addition of storing it.\n *\n * The pattern of a Loader is very similar to the Redux store.\n * We provide a \"connect()\" High Order Component (H.O.C.) to connect React\n * components to Loader instances. Connected components will react to the loader's\n * state changes, very much like React components react to the Redux's store state\n * changes when they are connected it via the Redux connect() HOC.\n *\n * @example\n *\n * // Define and instantiate a new loader.\n * class MyLoader extends LoaderInterface {\n *   // Some arbitrary internal method that will store the loaded data\n *   _onMessage(msg) {\n *     this.set('foo', msg.foo);\n *     this.set('bar', msg.bar);\n *   }\n * }\n * const loader = new MyLoader(...opts);\n *\n * // Create a new component that will connect to the loader state.\n * const MyComponent = props => <div>{props.foo}:{props.bar}</div>;\n *\n * // Connect component to the loader.\n * import {connect} from 'streetscape.gl';\n * const mapStateToProps = loader => ({\n *     foo: loader.get('foo'),\n *     bar: loader.get('bar')\n * });\n * const MyConnectedComponent = connect(mapStateToProps, MyComponent);\n *\n * // Render connected component somewhere and feed it the loader. It will\n * // react to the loader state changes.\n * <MyConnectedComponent loader={loader} />\n */\nexport default class LoaderInterface {\n  constructor() {\n    this.listeners = [];\n    this.state = {};\n    this._updates = 0;\n    this._version = 0;\n    this._updateTimer = null;\n  }\n\n  subscribe(instance) {\n    this.listeners.push(instance);\n  }\n\n  unsubscribe(instance) {\n    const index = this.listeners.findIndex(o => o === instance);\n    if (index >= 0) {\n      this.listeners.splice(index, 1);\n    }\n  }\n\n  get(key) {\n    return this.state[key];\n  }\n\n  set(key, value) {\n    if (this.state[key] !== value) {\n      this.state[key] = value;\n      this._version++;\n      if (!this._updateTimer) {\n        /* global requestAnimationFrame */\n        this._updateTimer = requestAnimationFrame(this._update);\n      }\n    }\n  }\n\n  _update = () => {\n    this._updateTimer = null;\n    this.listeners.forEach(o => o(this._version));\n  };\n\n  _bumpDataVersion() {\n    this._updates++;\n    this.set('dataVersion', this._updates);\n  }\n\n  _getDataVersion = () => this.get('dataVersion');\n}\n"],"file":"loader-interface.js"}