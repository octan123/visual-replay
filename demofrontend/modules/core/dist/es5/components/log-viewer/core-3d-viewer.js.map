{"version":3,"sources":["../../../../src/components/log-viewer/core-3d-viewer.js"],"names":["noop","Z_INDEX","car","point","polygon","customDefault","Core3DViewer","props","React","createRef","evt","map","target","onMapLoad","deck","deckRef","current","onDeckLoad","deckMetrics","debug","metrics","Object","assign","table","stats","getTable","key","count","reset","viewState","oldViewState","viewOffset","onViewStateChange","info","objectId","object","id","isHovering","Boolean","onHover","isRightClick","which","onContextMenu","onClick","layer","viewport","isPicking","showTooltip","startsWith","sampleData","data","state","styleParser","_getStyleParser","views","viewMode","viewOptions","getLayers","_getLayers","bind","getViewState","_getViewState","nextProps","DEFAULT_VIEW_STATE","initialViewState","x","y","bearing","setState","metadata","xvizStyles","frame","get","incrementCount","XVIZStyleParser","styles","origin","DEFAULT_ORIGIN","mesh","scale","wireframe","texture","color","SimpleMeshLayer","opacity","coordinateSystem","COORDINATE_SYSTEM","METER_OFFSETS","coordinateOrigin","getTransformMatrix","d","vehicleRelativeTransform","clone","translate","CAR_DATA","pickable","getPosition","getColor","updateTriggers","zIndex","opts","streamsMetadata","objectStates","customLayers","customXVIZLayers","streams","lookAheads","streamFilter","featuresAndFutures","Set","keys","concat","filter","layerList","_getCarLayer","Array","from","streamName","stream","coordinateProps","stylesheet","getStylesheet","primitives","features","length","XVIZLayer","style","type","streamMetadata","additionalProps","coordinate","sort","layer1","layer2","trackedPosition","longitude","trackPosition","latitude","altitude","heading","offset","mapboxApiAccessToken","renderObjectLabel","mapStyle","showMap","layers","viewStates","LIGHTS","_layerFilter","_getCursor","_onDeckLoad","_onLayerHover","_onLayerClick","_onViewStateChange","MapContext","Provider","_onMetrics","firstPerson","_onMapLoad","selected","children","PureComponent","PropTypes","bool","string","oneOfType","array","func","DEFAULT_CAR","VIEW_MODE","PERSPECTIVE"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {StaticMap} from 'react-map-gl';\nimport DeckGL from '@deck.gl/react';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\nimport {_MapContext as MapContext} from 'react-map-gl';\n\nimport ObjectLabelsOverlay from './object-labels-overlay';\n\nimport {SimpleMeshLayer} from '@deck.gl/mesh-layers';\nimport {XVIZStyleParser} from '@xviz/parser';\n\nimport XVIZLayer from '../../layers/xviz-layer';\n\nimport {VIEW_MODE, DEFAULT_VIEW_STATE} from '../../constants';\nimport {getViewStateOffset, getViews, getViewStates} from '../../utils/viewport';\nimport {resolveCoordinateTransform} from '../../utils/transform';\nimport {mergeXVIZStyles} from '../../utils/style';\nimport {normalizeStreamFilter} from '../../utils/stream-utils';\nimport stats from '../../utils/stats';\nimport memoize from '../../utils/memoize';\n\nimport {DEFAULT_ORIGIN, CAR_DATA, LIGHTS, DEFAULT_CAR} from './constants';\n\nconst noop = () => {};\n\nconst Z_INDEX = {\n  car: 0,\n  point: 1,\n  polygon: 2,\n  customDefault: 3\n};\n\nexport default class Core3DViewer extends PureComponent {\n  static propTypes = {\n    // Props from loader\n    frame: PropTypes.object,\n    metadata: PropTypes.object,\n    streamsMetadata: PropTypes.object,\n\n    // Rendering options\n    showMap: PropTypes.bool,\n    showTooltip: PropTypes.bool,\n    mapboxApiAccessToken: PropTypes.string,\n    mapStyle: PropTypes.oneOfType([PropTypes.object, PropTypes.string]),\n    xvizStyles: PropTypes.object,\n    car: PropTypes.object,\n    viewMode: PropTypes.object,\n    streamFilter: PropTypes.oneOfType([\n      PropTypes.string,\n      PropTypes.array,\n      PropTypes.object,\n      PropTypes.func\n    ]),\n    customLayers: PropTypes.array,\n    customXVIZLayers: PropTypes.array,\n    renderObjectLabel: PropTypes.func,\n    getTransformMatrix: PropTypes.func,\n    viewOptions: PropTypes.object,\n\n    // Callbacks\n    onMapLoad: PropTypes.func,\n    onDeckLoad: PropTypes.func,\n    onHover: PropTypes.func,\n    onClick: PropTypes.func,\n    onContextMenu: PropTypes.func,\n    onViewStateChange: PropTypes.func,\n\n    // Debug info listener\n    debug: PropTypes.func,\n\n    // States\n    viewState: PropTypes.object,\n    viewOffset: PropTypes.object,\n    objectStates: PropTypes.object\n  };\n\n  static defaultProps = {\n    car: DEFAULT_CAR,\n    viewMode: VIEW_MODE.PERSPECTIVE,\n    xvizStyles: {},\n    customLayers: [],\n    customXVIZLayers: [],\n    onMapLoad: noop,\n    onDeckLoad: noop,\n    onViewStateChange: noop,\n    onHover: noop,\n    onClick: noop,\n    onContextMenu: noop,\n    showMap: true,\n    showTooltip: false\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      styleParser: this._getStyleParser(props),\n      views: getViews(props.viewMode, props.viewOptions)\n    };\n\n    this.getLayers = memoize(this._getLayers.bind(this));\n    this.getViewState = memoize(this._getViewState);\n  }\n\n  deckRef = React.createRef();\n\n  componentWillReceiveProps(nextProps) {\n    if (this.props.viewMode !== nextProps.viewMode) {\n      const viewState = {\n        ...this.props.viewState,\n        ...DEFAULT_VIEW_STATE,\n        ...nextProps.viewMode.initialViewState\n      };\n      // Reset offset\n      const viewOffset = {\n        x: 0,\n        y: 0,\n        bearing: 0\n      };\n\n      nextProps.onViewStateChange({viewState, viewOffset});\n      this.setState({\n        views: getViews(nextProps.viewMode, nextProps.viewOptions)\n      });\n    }\n    if (\n      this.props.metadata !== nextProps.metadata ||\n      this.props.xvizStyles !== nextProps.xvizStyles\n    ) {\n      this.setState({\n        styleParser: this._getStyleParser(nextProps)\n      });\n    }\n    if (this.props.frame !== nextProps.frame) {\n      stats.get('frame-update').incrementCount();\n    }\n  }\n\n  _onMapLoad = evt => {\n    const map = evt.target;\n    this.props.onMapLoad(map);\n  };\n\n  _onDeckLoad = () => {\n    const deck = this.deckRef.current.deck;\n    this.props.onDeckLoad(deck);\n  };\n\n  _onMetrics = deckMetrics => {\n    if (this.props.debug) {\n      const metrics = Object.assign({}, deckMetrics);\n      const table = stats.getTable();\n\n      for (const key in table) {\n        metrics[key] = table[key].count;\n      }\n      this.props.debug(metrics);\n    }\n    stats.reset();\n  };\n\n  _onViewStateChange = ({viewState, oldViewState}) => {\n    const viewOffset = getViewStateOffset(oldViewState, viewState, this.props.viewOffset);\n    this.props.onViewStateChange({viewState, viewOffset});\n  };\n\n  _onLayerHover = (info, evt) => {\n    const objectId = info && info.object && info.object.id;\n    this.isHovering = Boolean(objectId);\n    this.props.onHover(info, evt);\n  };\n\n  _onLayerClick = (info, evt) => {\n    const isRightClick = evt.which === 3;\n\n    if (isRightClick) {\n      this.props.onContextMenu(info, evt);\n    } else {\n      this.props.onClick(info, evt);\n    }\n  };\n\n  _getStyleParser({metadata, xvizStyles}) {\n    return new XVIZStyleParser(mergeXVIZStyles(metadata && metadata.styles, xvizStyles));\n  }\n\n  _getCarLayer({frame, car}) {\n    const {\n      origin = DEFAULT_ORIGIN,\n      mesh,\n      scale = [1, 1, 1],\n      wireframe = false,\n      texture = null,\n      color = [0, 0, 0]\n    } = car;\n\n    return new SimpleMeshLayer({\n      id: 'car',\n      opacity: 1,\n      coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,\n      coordinateOrigin: frame.origin || DEFAULT_ORIGIN,\n      // Adjust for car center position relative to GPS/IMU\n      getTransformMatrix: d =>\n        frame.vehicleRelativeTransform\n          .clone()\n          .translate(origin)\n          .scale(scale),\n      mesh,\n      data: CAR_DATA,\n      pickable: true,\n      getPosition: d => d,\n      getColor: color,\n      texture,\n      wireframe,\n      updateTriggers: {\n        getTransformMatrix: frame.vehicleRelativeTransform\n      },\n      zIndex: Z_INDEX.car\n    });\n  }\n\n  _getLayers(opts) {\n    const {\n      frame,\n      streamsMetadata,\n      objectStates,\n      customLayers,\n      customXVIZLayers,\n      getTransformMatrix,\n      styleParser\n    } = opts;\n    if (!frame) {\n      return [];\n    }\n\n    const {streams, lookAheads = {}} = frame;\n\n    const streamFilter = normalizeStreamFilter(opts.streamFilter);\n    const featuresAndFutures = new Set(\n      Object.keys(streams)\n        .concat(Object.keys(lookAheads))\n        .filter(streamFilter)\n    );\n\n    let layerList = [this._getCarLayer(opts)];\n\n    layerList = layerList.concat(\n      Array.from(featuresAndFutures)\n        .map(streamName => {\n          // Check lookAheads first because it will contain the selected futures\n          // while streams would contain the full futures array\n          const stream = lookAheads[streamName] || streams[streamName];\n          const coordinateProps = resolveCoordinateTransform(\n            frame,\n            streamName,\n            streamsMetadata[streamName],\n            getTransformMatrix\n          );\n\n          const stylesheet = styleParser.getStylesheet(streamName);\n\n          // Support both features and lookAheads, respectively\n          const primitives = stream.features || stream;\n          if (primitives && primitives.length) {\n            return new XVIZLayer({\n              id: `xviz-${streamName}`,\n              ...coordinateProps,\n\n              pickable: true,\n              data: primitives,\n              style: stylesheet,\n              objectStates,\n              vehicleRelativeTransform: frame.vehicleRelativeTransform,\n\n              // Hack: draw extruded polygons last to defeat depth test when rendering translucent objects\n              // This is not used by deck.gl, only used in this function to sort the layers\n              zIndex: Z_INDEX[primitives[0].type] || 0,\n\n              // Selection props (app defined, not used by deck.gl)\n              streamName,\n              streamMetadata: streamsMetadata[streamName],\n              customXVIZLayers\n            });\n          }\n          return null;\n        })\n        .filter(Boolean)\n    );\n\n    layerList = layerList.concat(\n      customLayers.map(layer => {\n        // Clone layer props\n        const {props} = layer;\n        const additionalProps = {\n          zIndex: 'zIndex' in props ? props.zIndex : Z_INDEX.customDefault\n        };\n\n        if (props.streamName) {\n          // Use log data\n          const stream = streams[props.streamName];\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(\n              frame,\n              props.streamName,\n              streamsMetadata[props.streamName],\n              getTransformMatrix\n            ),\n            {\n              data: stream && stream.features\n            }\n          );\n        } else if (props.coordinate) {\n          // Apply log-specific coordinate props\n          Object.assign(\n            additionalProps,\n            resolveCoordinateTransform(frame, null, props, getTransformMatrix)\n          );\n        } else {\n          return layer;\n        }\n\n        return layer.clone(additionalProps);\n      })\n    );\n\n    // Sort layers by zIndex to avoid depth test issues\n    return layerList.sort(\n      (layer1, layer2) => (layer1.props.zIndex || 0) - (layer2.props.zIndex || 0)\n    );\n  }\n\n  _layerFilter = ({layer, viewport, isPicking}) => {\n    if (viewport.id === 'driver' && layer.id === 'car') {\n      return false;\n    }\n    if (isPicking) {\n      if (this.props.showTooltip) {\n        return true;\n      }\n      if (layer.id.startsWith('xviz-')) {\n        const sampleData = layer.props.data[0];\n        return sampleData && sampleData.id;\n      }\n    }\n    return true;\n  };\n\n  _getCursor = () => {\n    return this.isHovering ? 'pointer' : 'crosshair';\n  };\n\n  _getViewState({viewMode, frame, viewState, viewOffset}) {\n    const trackedPosition = frame\n      ? {\n          longitude: frame.trackPosition[0],\n          latitude: frame.trackPosition[1],\n          altitude: frame.trackPosition[2],\n          bearing: 90 - frame.heading\n        }\n      : null;\n\n    return getViewStates({viewState, viewMode, trackedPosition, offset: viewOffset});\n  }\n\n  render() {\n    const {\n      mapboxApiAccessToken,\n      frame,\n      car,\n      streamsMetadata,\n      streamFilter,\n      objectStates,\n      renderObjectLabel,\n      customLayers,\n      getTransformMatrix,\n      style,\n      mapStyle,\n      viewMode,\n      viewState,\n      viewOffset,\n      showMap,\n      customXVIZLayers\n    } = this.props;\n    const {styleParser, views} = this.state;\n    const layers = this.getLayers({\n      frame,\n      car,\n      streamsMetadata,\n      streamFilter,\n      objectStates,\n      customLayers,\n      getTransformMatrix,\n      styleParser,\n      customXVIZLayers\n    });\n    const viewStates = this.getViewState({viewMode, frame, viewState, viewOffset});\n\n    return (\n      <DeckGL\n        width=\"100%\"\n        height=\"100%\"\n        ref={this.deckRef}\n        effects={[LIGHTS]}\n        views={views}\n        viewState={viewStates}\n        layers={layers}\n        layerFilter={this._layerFilter}\n        getCursor={this._getCursor}\n        onLoad={this._onDeckLoad}\n        onHover={this._onLayerHover}\n        onClick={this._onLayerClick}\n        onViewStateChange={this._onViewStateChange}\n        ContextProvider={MapContext.Provider}\n        _onMetrics={this._onMetrics}\n      >\n        {showMap && (\n          <StaticMap\n            reuseMap={true}\n            attributionControl={false}\n            mapboxApiAccessToken={mapboxApiAccessToken}\n            mapStyle={mapStyle}\n            visible={frame && frame.origin && !viewMode.firstPerson}\n            onLoad={this._onMapLoad}\n          />\n        )}\n\n        <ObjectLabelsOverlay\n          objectSelection={objectStates.selected}\n          frame={frame}\n          streamsMetadata={streamsMetadata}\n          renderObjectLabel={renderObjectLabel}\n          xvizStyleParser={styleParser}\n          style={style}\n          getTransformMatrix={getTransformMatrix}\n        />\n\n        {this.props.children}\n      </DeckGL>\n    );\n  }\n}\n"],"file":"core-3d-viewer.js"}