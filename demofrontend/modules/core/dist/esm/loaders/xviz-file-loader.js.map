{"version":3,"sources":["../../../src/loaders/xviz-file-loader.js"],"names":["assert","parseStreamMessage","XVIZStreamBuffer","XVIZLoaderInterface","DEFAULT_BATCH_SIZE","XVIZFileLoader","options","timingsFilePath","getFilePath","_timingsFilePath","_getFilePath","_batchSize","maxConcurrency","streamBuffer","_isOpen","_lastLoadFrame","_loadTimings","then","data","_numberOfFrames","timing","length","_loadMetadata","_startLoad","timestamp","fetch","resp","json","metadataPath","_loadFile","worker","i","_loadNextFrame","isOpen","emit","filePath","Promise","resolve","fileFormat","toLowerCase","match","file","arrayBuffer","reject","message","onResult","onXVIZMessage","onError","debug","_debug","bind"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global fetch */\nimport assert from 'assert';\nimport {parseStreamMessage, XVIZStreamBuffer} from '@xviz/parser';\n\nimport XVIZLoaderInterface from './xviz-loader-interface';\n\nconst DEFAULT_BATCH_SIZE = 4;\n\nexport default class XVIZFileLoader extends XVIZLoaderInterface {\n  constructor(options) {\n    super(options);\n\n    assert(options.timingsFilePath && options.getFilePath);\n\n    this._timingsFilePath = options.timingsFilePath;\n    this._getFilePath = options.getFilePath;\n    this._batchSize = options.maxConcurrency || DEFAULT_BATCH_SIZE;\n\n    this.streamBuffer = new XVIZStreamBuffer();\n    this._isOpen = false;\n\n    this._lastLoadFrame = -1;\n  }\n\n  isOpen() {\n    return this._isOpen;\n  }\n\n  connect() {\n    this._isOpen = true;\n    this._loadTimings().then(data => {\n      // Adding 1 is to account for the metadata file\n      this._numberOfFrames = data.timing.length + 1;\n      this._loadMetadata().then(() => this._startLoad());\n    });\n  }\n\n  seek(timestamp) {\n    // TODO incomplete\n    super.seek(timestamp);\n  }\n\n  close() {\n    // Stop file loading\n    this._isOpen = false;\n  }\n\n  _loadTimings() {\n    return fetch(this._timingsFilePath).then(resp => resp.json());\n  }\n\n  _loadMetadata() {\n    const metadataPath = this._getFilePath(0);\n    assert(metadataPath);\n    return this._loadFile(metadataPath, {worker: false});\n  }\n\n  _startLoad() {\n    this._lastLoadFrame = 0;\n    // fetching in parallel\n    for (let i = 0; i < this._batchSize && i < this._numberOfFrames; i++) {\n      this._loadNextFrame();\n    }\n  }\n\n  _loadNextFrame() {\n    if (!this.isOpen()) {\n      return;\n    }\n\n    this._lastLoadFrame = this._lastLoadFrame + 1;\n\n    if (this._lastLoadFrame >= this._numberOfFrames) {\n      this.emit('done');\n      return;\n    }\n\n    const filePath = this._getFilePath(this._lastLoadFrame);\n    assert(filePath);\n    Promise.resolve(this._loadFile(filePath, this.options)).then(() => {\n      this._loadNextFrame();\n    });\n  }\n\n  _loadFile(filePath, options) {\n    const fileFormat = filePath.toLowerCase().match(/[^\\.]*$/)[0];\n\n    let file;\n    switch (fileFormat) {\n      case 'glb':\n        file = fetch(filePath).then(resp => resp.arrayBuffer());\n        break;\n\n      case 'json':\n        file = fetch(filePath).then(resp => resp.json());\n        break;\n\n      default:\n        return Promise.reject('Unknown file format');\n    }\n\n    return file.then(data => {\n      // if not open, do not parse the message\n      if (this._isOpen) {\n        parseStreamMessage({\n          message: data,\n          onResult: this.onXVIZMessage,\n          onError: this.onError,\n          worker: options.worker,\n          maxConcurrency: options.maxConcurrency,\n          debug: this._debug.bind(this, 'parse_message')\n        });\n      }\n    });\n  }\n}\n"],"file":"xviz-file-loader.js"}