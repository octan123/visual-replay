{"version":3,"sources":["../../../src/loaders/xviz-loader-interface.js"],"names":["getXVIZConfig","StreamSynchronizer","LOG_STREAM_MESSAGE","clamp","PlayableLoaderInterface","createSelector","stats","XVIZLoaderInterface","options","message","type","METADATA","_onXVIZMetadata","emit","TIMESLICE","_onXVIZTimeslice","DONE","error","get","_getDataVersion","_getDataByStream","_getBufferedTimeRanges","getStreamSettings","_getStreams","streamSettings","streams","result","streamName","DYNAMIC_STREAM_METADATA","getMetadata","_getStreamsMetadata","metadata","streamsMetadata","Object","assign","getCurrentTime","_getBufferStartTime","_getBufferEndTime","_getLogStartTime","_getLogEndTime","getLookAhead","timestamp","lookAhead","logSynchronizer","Number","isFinite","setTime","setLookAheadTimeOffset","getCurrentFrame","_debug","debug","callbacks","eventType","cb","push","index","indexOf","splice","eventArgs","incrementCount","startTime","getLogStartTime","endTime","getLogEndTime","set","streamBuffer","setCurrentTime","settings","keys","length","Error","newTimestamp","start_time","seek","timeslice","oldStreamCount","streamCount","bufferUpdated","insert","_bumpDataVersion","__metadata","range","getLoadedTimeRange","start","end","TIME_WINDOW","end_time"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {getXVIZConfig, StreamSynchronizer, LOG_STREAM_MESSAGE} from '@xviz/parser';\nimport {clamp} from 'math.gl';\n\nimport PlayableLoaderInterface from './playable-loader-interface';\nimport createSelector from '../utils/create-selector';\nimport stats from '../utils/stats';\n\n/* eslint-disable callback-return */\nexport default class XVIZLoaderInterface extends PlayableLoaderInterface {\n  constructor(options = {}) {\n    super();\n    this.options = options;\n    this._debug = options.debug || (() => {});\n    this.callbacks = {};\n  }\n\n  /* Event types:\n   * - ready\n   * - update\n   * - finish\n   * - error\n   */\n  on(eventType, cb) {\n    this.callbacks[eventType] = this.callbacks[eventType] || [];\n    this.callbacks[eventType].push(cb);\n    return this;\n  }\n\n  off(eventType, cb) {\n    const callbacks = this.callbacks[eventType];\n    if (callbacks) {\n      const index = callbacks.indexOf(cb);\n      if (index >= 0) {\n        callbacks.splice(index, 1);\n      }\n    }\n    return this;\n  }\n\n  emit(eventType, eventArgs) {\n    const callbacks = this.callbacks[eventType];\n    if (callbacks) {\n      for (const cb of callbacks) {\n        cb(eventType, eventArgs);\n      }\n    }\n    stats.get(`loader-${eventType}`).incrementCount();\n  }\n\n  onXVIZMessage = message => {\n    switch (message.type) {\n      case LOG_STREAM_MESSAGE.METADATA:\n        this._onXVIZMetadata(message);\n        this.emit('ready', message);\n        break;\n\n      case LOG_STREAM_MESSAGE.TIMESLICE:\n        this._onXVIZTimeslice(message);\n        this.emit('update', message);\n        break;\n\n      case LOG_STREAM_MESSAGE.DONE:\n        this.emit('finish', message);\n        break;\n\n      default:\n        this.emit('error', message);\n    }\n  };\n\n  onError = error => {\n    this.emit('error', error);\n  };\n\n  seek(timestamp) {\n    const metadata = this.getMetadata();\n\n    if (metadata) {\n      const startTime = this.getLogStartTime();\n      const endTime = this.getLogEndTime();\n      if (Number.isFinite(startTime) && Number.isFinite(endTime)) {\n        timestamp = clamp(timestamp, startTime, endTime);\n      }\n    }\n\n    this.set('timestamp', timestamp);\n\n    // Notify the stream buffer of the current play head\n    // for any data management needs.\n    this.streamBuffer.setCurrentTime(timestamp);\n  }\n\n  updateStreamSettings(settings) {\n    const streamSettings = this.get('streamSettings');\n    this.set('streamSettings', {...streamSettings, ...settings});\n  }\n\n  /* Data selector API */\n\n  getMetadata = () => this.get('metadata');\n\n  getStreamSettings = () => this.get('streamSettings');\n\n  _getStreamsMetadata = () => this.get('streamsMetadata');\n\n  _getStreams = createSelector(this, this._getDataVersion, () => this._getDataByStream());\n\n  getBufferedTimeRanges = createSelector(this, this._getDataVersion, () =>\n    this._getBufferedTimeRanges()\n  );\n\n  getStreams = createSelector(\n    this,\n    [this.getStreamSettings, this._getStreams, this._getDataVersion],\n    (streamSettings, streams) => {\n      if (!streamSettings || !streams) {\n        return streams;\n      }\n      const result = {};\n      for (const streamName in streams) {\n        if (streamSettings[streamName]) {\n          result[streamName] = streams[streamName];\n        }\n      }\n      return result;\n    }\n  );\n\n  getStreamsMetadata = getXVIZConfig().DYNAMIC_STREAM_METADATA\n    ? createSelector(\n        this,\n        [this.getMetadata, this._getStreamsMetadata],\n        (metadata, streamsMetadata) => {\n          return Object.assign({}, streamsMetadata, metadata && metadata.streams);\n        }\n      )\n    : createSelector(this, this.getMetadata, metadata => (metadata && metadata.streams) || {});\n\n  getBufferStartTime = createSelector(this, this.getCurrentTime, () => this._getBufferStartTime());\n  getBufferEndTime = createSelector(this, this.getCurrentTime, () => this._getBufferEndTime());\n\n  getLogStartTime = createSelector(this, this.getMetadata, metadata =>\n    this._getLogStartTime(metadata)\n  );\n  getLogEndTime = createSelector(this, this.getMetadata, metadata => this._getLogEndTime(metadata));\n\n  getCurrentFrame = createSelector(\n    this,\n    [this.getStreamSettings, this.getCurrentTime, this.getLookAhead, this._getDataVersion],\n    // `dataVersion` is only needed to trigger recomputation.\n    // The logSynchronizer has access to the timeslices.\n    (streamSettings, timestamp, lookAhead) => {\n      const {logSynchronizer} = this;\n      if (logSynchronizer && Number.isFinite(timestamp)) {\n        logSynchronizer.setTime(timestamp);\n        logSynchronizer.setLookAheadTimeOffset(lookAhead);\n        return logSynchronizer.getCurrentFrame(streamSettings);\n      }\n      return null;\n    }\n  );\n\n  /* Subclass hooks */\n\n  _onXVIZMetadata(metadata) {\n    this.set('metadata', metadata);\n    if (metadata.streams && Object.keys(metadata.streams).length > 0) {\n      this.set('streamSettings', metadata.streams);\n    }\n\n    if (!this.streamBuffer) {\n      throw new Error('streamBuffer is missing');\n    }\n    this.logSynchronizer = this.logSynchronizer || new StreamSynchronizer(this.streamBuffer);\n\n    const timestamp = this.get('timestamp');\n    const newTimestamp = Number.isFinite(timestamp) ? timestamp : metadata.start_time;\n    if (Number.isFinite(newTimestamp)) {\n      this.seek(newTimestamp);\n    }\n  }\n\n  _onXVIZTimeslice(timeslice) {\n    const oldStreamCount = this.streamBuffer.streamCount;\n    const bufferUpdated = this.streamBuffer.insert(timeslice);\n    if (bufferUpdated) {\n      this._bumpDataVersion();\n    }\n\n    if (getXVIZConfig().DYNAMIC_STREAM_METADATA && this.streamBuffer.streamCount > oldStreamCount) {\n      const streamsMetadata = {};\n      const streamSettings = this.get('streamSettings');\n\n      for (const streamName in timeslice.streams) {\n        streamsMetadata[streamName] = timeslice.streams[streamName].__metadata;\n\n        // Add new stream name to stream settings (default on)\n        if (!(streamName in streamSettings)) {\n          streamSettings[streamName] = true;\n        }\n      }\n      this.set('streamsMetadata', streamsMetadata);\n    }\n\n    return bufferUpdated;\n  }\n\n  _getDataByStream() {\n    // XVIZStreamBuffer.getStreams filters out missing streams. This has significant impact\n    // on performance. Here we take the unfiltered slices and only filter them if a stream\n    // is used.\n\n    // return this.streamBuffer.getStreams();\n    return this.streamBuffer.streams;\n  }\n\n  _getBufferedTimeRanges() {\n    const range = this.streamBuffer.getLoadedTimeRange();\n    if (range) {\n      return [[range.start, range.end]];\n    }\n    return [];\n  }\n\n  _getLogStartTime(metadata) {\n    return metadata && metadata.start_time && metadata.start_time + getXVIZConfig().TIME_WINDOW;\n  }\n\n  _getLogEndTime(metadata) {\n    return metadata && metadata.end_time;\n  }\n\n  _getBufferStartTime() {\n    return this.getLogStartTime();\n  }\n\n  _getBufferEndTime() {\n    return this.getLogEndTime();\n  }\n}\n"],"file":"xviz-loader-interface.js"}