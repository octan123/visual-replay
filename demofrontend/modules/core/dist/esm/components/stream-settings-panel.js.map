{"version":3,"sources":["../../../src/components/stream-settings-panel.js"],"names":["React","PureComponent","PropTypes","Form","CheckBox","evaluateStyle","styled","connectToLog","Badge","div","props","content","type","userStyle","getParentKey","streamName","i","indexOf","slice","getParentValue","children","values","parentValue","key","value","INDETERMINATE","createFormData","metadata","opts","root","style","collapsible","parentKey","siblings","badge","primitive_type","scalar_type","title","replace","settingsToFormValues","data","settings","ON","OFF","updateFormValues","oldValues","newValues","formValuesToSettings","StreamSettingsPanel","streamsMetadata","log","onSettingsChange","state","updateStreamSettings","streamSettings","nextProps","setState","_onValuesChange","object","func","getLogState","getStreamsMetadata","getStreamSettings","Component"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\nimport {Form, CheckBox, evaluateStyle} from '@streetscape.gl/monochrome';\nimport styled from '@emotion/styled';\n\nimport connectToLog from './connect';\n\nconst Badge = styled.div(props => ({\n  '&:before': {\n    content: `\"${props.type || ''}\"`\n  },\n  ...evaluateStyle(props.userStyle, props)\n}));\n\nfunction getParentKey(streamName) {\n  const i = streamName.indexOf('/', 1);\n  if (i > 1) {\n    return streamName.slice(0, i);\n  }\n  return '';\n}\n\nfunction getParentValue(children, values) {\n  let parentValue = null;\n  for (const key in children) {\n    const value = values[key];\n    if (parentValue === null) {\n      parentValue = value;\n    } else if (parentValue !== value) {\n      return CheckBox.INDETERMINATE;\n    }\n  }\n  return parentValue;\n}\n\n// Created 1-level nested form structure\nexport function createFormData(metadata, opts) {\n  if (!metadata) {\n    return null;\n  }\n\n  const root = {};\n  const {style = {}, collapsible = false} = opts;\n\n  for (const streamName in metadata) {\n    const parentKey = getParentKey(streamName);\n    let siblings = root;\n\n    if (parentKey) {\n      root[parentKey] = root[parentKey] || {\n        type: 'checkbox',\n        children: {},\n        collapsible,\n        badge: (\n          <Badge\n            userStyle={style.badge}\n            type={\n              (metadata[streamName] && metadata[streamName].primitive_type) ||\n              metadata[streamName].scalar_type\n            }\n          />\n        )\n      };\n      siblings = root[parentKey].children;\n    }\n\n    if (!siblings[streamName]) {\n      siblings[streamName] = {\n        type: 'checkbox',\n        title: streamName.replace(parentKey, ''),\n        badge: (\n          <Badge\n            userStyle={style.badge}\n            type={metadata[streamName].primitive_type || metadata[streamName].scalar_type}\n          />\n        )\n      };\n    }\n  }\n\n  return root;\n}\n\nexport function settingsToFormValues(data, settings) {\n  if (!data || !settings) {\n    return null;\n  }\n\n  const values = {};\n  for (const key in data) {\n    const {children} = data[key];\n    if (children) {\n      // is parent\n      for (const streamName in children) {\n        values[streamName] = settings[streamName] ? CheckBox.ON : CheckBox.OFF;\n      }\n      values[key] = getParentValue(children, values);\n    } else {\n      // is leaf\n      values[key] = settings[key] ? CheckBox.ON : CheckBox.OFF;\n    }\n  }\n  return values;\n}\n\nexport function updateFormValues(data, oldValues, newValues) {\n  const values = {...oldValues, ...newValues};\n  for (const key in newValues) {\n    if (data[key] && data[key].children) {\n      // is parent, reset child values\n      for (const streamName in data[key].children) {\n        values[streamName] = newValues[key];\n      }\n    } else {\n      // is leaf, re-evaluate parent value\n      const parentKey = getParentKey(key);\n      if (parentKey) {\n        values[parentKey] = getParentValue(data[parentKey].children, values);\n      }\n    }\n  }\n  return values;\n}\n\nexport function formValuesToSettings(metadata, values) {\n  const settings = {};\n  for (const streamName in metadata) {\n    settings[streamName] = values[streamName] === CheckBox.ON;\n  }\n  return settings;\n}\n\nclass StreamSettingsPanel extends PureComponent {\n  static propTypes = {\n    style: PropTypes.object,\n    streamsMetadata: PropTypes.object,\n    onSettingsChange: PropTypes.func\n  };\n\n  static defaultProps = {\n    style: {},\n    onSettingsChange: () => {}\n  };\n\n  constructor(props) {\n    super(props);\n\n    const data = createFormData(props.streamsMetadata, props);\n    const values = settingsToFormValues(data, props.streamSettings);\n    this.state = {data, values};\n  }\n\n  componentWillReceiveProps(nextProps) {\n    let {data, values} = this.state;\n\n    if (nextProps.streamsMetadata !== this.props.streamsMetadata) {\n      data = createFormData(nextProps.streamsMetadata, nextProps);\n      values = null;\n    }\n    if (nextProps.streamSettings !== this.props.streamSettings) {\n      values = settingsToFormValues(data, nextProps.streamSettings);\n    }\n    this.setState({data, values});\n  }\n\n  _onValuesChange = newValues => {\n    const {streamsMetadata, log, onSettingsChange} = this.props;\n    const {data} = this.state;\n    const values = updateFormValues(data, this.state.values, newValues);\n    const settings = formValuesToSettings(streamsMetadata, values);\n\n    if (!onSettingsChange(settings) && log) {\n      log.updateStreamSettings(settings);\n    }\n  };\n\n  render() {\n    const {style} = this.props;\n    const {data, values} = this.state;\n\n    if (!data || !values) {\n      return null;\n    }\n\n    return <Form style={style} data={data} values={values} onChange={this._onValuesChange} />;\n  }\n}\n\nconst getLogState = log => ({\n  streamsMetadata: log.getStreamsMetadata(),\n  streamSettings: log.getStreamSettings()\n});\n\nexport default connectToLog({getLogState, Component: StreamSettingsPanel});\n"],"file":"stream-settings-panel.js"}