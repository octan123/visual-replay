{"version":3,"sources":["../../../../src/components/playback-control/index.js"],"names":["React","PureComponent","PropTypes","getXVIZConfig","DualPlaybackControl","connectToLog","TIME_SCALES","seconds","milliseconds","PlaybackControl","isPlaying","timeScale","TIMESTAMP_FORMAT","props","onPlay","setState","onPause","timestamp","_onTimeChange","state","_onPause","log","onSeek","seek","lookAhead","onLookAheadChange","setLookAhead","now","Date","startTime","endTime","buffered","lastUpdate","_lastAnimationUpdate","PLAYBACK_FRAME_RATE","TIME_WINDOW","timeDeltaMs","Math","min","newTimestamp","some","r","_animationFrame","window","requestAnimationFrame","_animate","x","formatter","deltaTimeS","formatTimeCode","_formatTime","formatTick","formatTimestamp","formatLookAhead","nextProps","Boolean","prevProps","prevState","cancelAnimationFrame","otherProps","Number","isFinite","bufferRange","map","max","_formatTick","_formatTimestamp","_formatLookAhead","_onSeek","_onPlay","_onLookAheadChange","number","array","bool","width","oneOfType","string","style","object","compact","className","step","padding","tickSpacing","markers","arrayOf","func","maxLookAhead","defaultProps","getLogState","getCurrentTime","getLookAhead","getLogStartTime","getLogEndTime","getBufferedTimeRanges","Component"],"mappings":"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","sourcesContent":["// Copyright (c) 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window */\nimport React, {PureComponent} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {getXVIZConfig} from '@xviz/parser';\nimport DualPlaybackControl from './dual-playback-control';\n\nimport connectToLog from '../connect';\n\nconst TIME_SCALES = {\n  seconds: 0.001,\n  milliseconds: 1\n};\n\nclass PlaybackControl extends PureComponent {\n  static propTypes = {\n    // from log\n    timestamp: PropTypes.number,\n    lookAhead: PropTypes.number,\n    startTime: PropTypes.number,\n    endTime: PropTypes.number,\n    buffered: PropTypes.array,\n\n    // state override\n    isPlaying: PropTypes.bool,\n\n    // config\n    width: PropTypes.oneOfType([PropTypes.string, PropTypes.number]),\n    style: PropTypes.object,\n    compact: PropTypes.bool,\n    className: PropTypes.string,\n    step: PropTypes.number,\n    padding: PropTypes.oneOfType([PropTypes.number, PropTypes.object]),\n    tickSpacing: PropTypes.number,\n    markers: PropTypes.arrayOf(PropTypes.object),\n    formatTick: PropTypes.func,\n    formatTimestamp: PropTypes.func,\n    // dual playback control config\n    maxLookAhead: PropTypes.number,\n    formatLookAhead: PropTypes.func,\n\n    // callbacks\n    onPlay: PropTypes.func,\n    onPause: PropTypes.func,\n    onSeek: PropTypes.func,\n    onLookAheadChange: PropTypes.func\n  };\n\n  static defaultProps = DualPlaybackControl.defaultProps;\n\n  state = {\n    isPlaying: false,\n    timeScale: TIME_SCALES[getXVIZConfig().TIMESTAMP_FORMAT] || 1\n  };\n\n  componentWillReceiveProps(nextProps) {\n    if ('isPlaying' in nextProps) {\n      this.setState({isPlaying: Boolean(nextProps.isPlaying)});\n    }\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    const {isPlaying} = this.state;\n    if (isPlaying && prevState.isPlaying !== isPlaying) {\n      this._lastAnimationUpdate = Date.now();\n      this._animationFrame = window.requestAnimationFrame(this._animate);\n    }\n  }\n\n  componentWillUnmount() {\n    if (this._animationFrame) {\n      window.cancelAnimationFrame(this._animationFrame);\n    }\n  }\n\n  _animationFrame = null;\n  _lastAnimationUpdate = -1;\n\n  _onPlay = () => {\n    this.props.onPlay();\n    this.setState({isPlaying: true});\n  };\n\n  _onPause = () => {\n    this.props.onPause();\n    this.setState({isPlaying: false});\n  };\n\n  _onSeek = timestamp => {\n    this._onTimeChange(timestamp);\n\n    if (this.state.isPlaying) {\n      this._onPause();\n    }\n  };\n\n  _onTimeChange = timestamp => {\n    const {log, onSeek} = this.props;\n    if (!onSeek(timestamp) && log) {\n      log.seek(timestamp);\n    }\n  };\n\n  _onLookAheadChange = lookAhead => {\n    const {log, onLookAheadChange} = this.props;\n    if (!onLookAheadChange(lookAhead) && log) {\n      log.setLookAhead(lookAhead);\n    }\n  };\n\n  _animate = () => {\n    if (this.state.isPlaying) {\n      const now = Date.now();\n      const {startTime, endTime, buffered, timestamp} = this.props;\n      const {timeScale} = this.state;\n      const lastUpdate = this._lastAnimationUpdate;\n      const {PLAYBACK_FRAME_RATE, TIME_WINDOW} = getXVIZConfig();\n\n      // avoid skipping frames - cap delta at resolution\n      let timeDeltaMs = lastUpdate > 0 ? now - lastUpdate : 0;\n      timeDeltaMs = Math.min(timeDeltaMs, 1000 / PLAYBACK_FRAME_RATE);\n\n      let newTimestamp = timestamp + timeDeltaMs * timeScale;\n      if (newTimestamp > endTime) {\n        newTimestamp = startTime;\n      }\n\n      // check buffer availability\n      if (buffered.some(r => newTimestamp >= r[0] && newTimestamp <= r[1] + TIME_WINDOW)) {\n        // only move forward if buffer is loaded\n        // otherwise pause and wait\n        this._onTimeChange(newTimestamp);\n      }\n\n      this._lastAnimationUpdate = now;\n      this._animationFrame = window.requestAnimationFrame(this._animate);\n    }\n  };\n\n  _formatTime = (x, formatter = null) => {\n    const {startTime} = this.props;\n    const {timeScale} = this.state;\n\n    if (formatter) {\n      return formatter(x, startTime);\n    }\n\n    const deltaTimeS = (x - startTime) / timeScale / 1000;\n    return DualPlaybackControl.formatTimeCode(deltaTimeS, '{mm}:{ss}');\n  };\n\n  _formatTick = x => {\n    return this._formatTime(x, this.props.formatTick);\n  };\n\n  _formatTimestamp = x => {\n    return this._formatTime(x, this.props.formatTimestamp);\n  };\n\n  _formatLookAhead = x => {\n    const {formatLookAhead} = this.props;\n    const {timeScale} = this.state;\n\n    if (formatLookAhead) {\n      return formatLookAhead(x);\n    }\n\n    const deltaTimeS = x / timeScale / 1000;\n    return DualPlaybackControl.formatTimeCode(deltaTimeS, '{s}.{S}s');\n  };\n\n  render() {\n    const {startTime, endTime, timestamp, lookAhead, buffered, ...otherProps} = this.props;\n\n    if (!Number.isFinite(timestamp) || !Number.isFinite(startTime)) {\n      return null;\n    }\n\n    const bufferRange = buffered.map(r => ({\n      startTime: Math.max(r[0], startTime),\n      endTime: Math.min(r[1], endTime)\n    }));\n\n    return (\n      <DualPlaybackControl\n        {...otherProps}\n        bufferRange={bufferRange}\n        currentTime={timestamp}\n        lookAhead={lookAhead}\n        startTime={startTime}\n        endTime={endTime}\n        isPlaying={this.state.isPlaying}\n        formatTick={this._formatTick}\n        formatTimestamp={this._formatTimestamp}\n        formatLookAhead={this._formatLookAhead}\n        onSeek={this._onSeek}\n        onPlay={this._onPlay}\n        onPause={this._onPause}\n        onLookAheadChange={this._onLookAheadChange}\n      />\n    );\n  }\n}\n\nconst getLogState = log => ({\n  timestamp: log.getCurrentTime(),\n  lookAhead: log.getLookAhead(),\n  startTime: log.getLogStartTime(),\n  endTime: log.getLogEndTime(),\n  buffered: log.getBufferedTimeRanges()\n});\n\nexport default connectToLog({getLogState, Component: PlaybackControl});\n"],"file":"index.js"}